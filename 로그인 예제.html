<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Firebase 로그인 + 점수 시스템 (자유 ID)</title>
</head>
<body>
  <h2>회원가입</h2>
  <input type="text" id="signupId" placeholder="아이디 (5글자 이상)"><br>
  <input type="password" id="signupPassword" placeholder="비밀번호 (6글자 이상)"><br>
  <button onclick="signUp()">회원가입</button>

  <h2>로그인</h2>
  <input type="text" id="loginId" placeholder="아이디 (5글자 이상)"><br>
  <input type="password" id="loginPassword" placeholder="비밀번호 (6글자 이상)"><br>
  <button onclick="login()">로그인</button>

  <h2>로그아웃</h2>
  <button onclick="logout()">로그아웃</button>

  <h2>점수 시스템</h2>
  <p id="status">로그인 상태: 없음</p>
  <p>현재 점수: <span id="score">0</span></p>
  <button onclick="addPoint()">점수 +1</button>

  <script type="module">
    // Firebase SDK import
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ✅ Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
      authDomain: "simulation-67cd3.firebaseapp.com",
      projectId: "simulation-67cd3",
      storageBucket: "simulation-67cd3.appspot.com",
      messagingSenderId: "615983461615",
      appId: "1:615983461615:web:002e07bcea878eb6d5571a",
      measurementId: "G-9RGN7LYE5W"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentScore = 0;

    // 회원가입
    async function signUp() {
      const userId = document.getElementById("signupId").value.trim();
      const password = document.getElementById("signupPassword").value;

      if (userId.length < 5) {
        alert("아이디는 5글자 이상이어야 합니다!");
        return;
      }
      if (password.length < 6) {
        alert("비밀번호는 6글자 이상이어야 합니다!");
        return;
      }

      const email = userId + "@myapp.local";

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);

        // ✅ Firestore에 반드시 ID 저장
        try {
          await setDoc(doc(db, "users", cred.user.uid), { ID: userId });
        } catch (err) {
          console.error("Firestore 저장 오류(users):", err);
        }

        // ✅ scores 문서도 초기화
        try {
          await setDoc(doc(db, "scores", cred.user.uid), { ID: userId, score: 0 });
        } catch (err) {
          console.error("Firestore 저장 오류(scores):", err);
        }

        alert("회원가입 성공: " + userId);
      } catch (err) {
        alert("회원가입 오류: " + err.message);
      }
    }

    // 로그인
    async function login() {
      const userId = document.getElementById("loginId").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (userId.length < 5) {
        alert("아이디는 5글자 이상이어야 합니다!");
        return;
      }
      if (password.length < 6) {
        alert("비밀번호는 6글자 이상이어야 합니다!");
        return;
      }

      const email = userId + "@myapp.local";

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        alert("로그인 성공: " + userId);
      } catch (err) {
        alert("로그인 오류: " + err.message);
      }
    }

    // 로그아웃
    async function logout() {
      await signOut(auth);
      alert("로그아웃 완료");
    }

    // 점수 불러오기
    async function loadScore(user) {
      try {
        const ref = doc(db, "scores", user.uid);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          currentScore = snap.data().score ?? 0;
        } else {
          currentScore = 0;
        }
        document.getElementById("score").innerText = currentScore;
      } catch (err) {
        console.error("점수 불러오기 오류:", err);
        document.getElementById("score").innerText = "0";
      }
    }

    // 점수 저장
    async function saveScore(user, score) {
      try {
        // ID 가져오기
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userId = userDoc.exists() ? userDoc.data().ID : user.email.split("@")[0];

        const ref = doc(db, "scores", user.uid);
        await setDoc(ref, { score: score, ID: userId }, { merge: true });
      } catch (err) {
        console.error("점수 저장 오류:", err);
      }
    }

    // 점수 +1
    async function addPoint() {
      if (!currentUser) {
        alert("로그인 후 사용하세요!");
        return;
      }
      currentScore += 1;
      document.getElementById("score").innerText = currentScore;
      await saveScore(currentUser, currentScore);
    }

    // 로그인 상태 감지
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        let displayId = "";

        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (userDoc.exists()) {
            displayId = userDoc.data().ID ?? "(ID 미등록)";
          } else {
            const fallbackId = user.email.split("@")[0];
            await setDoc(doc(db, "users", user.uid), { ID: fallbackId });
            displayId = fallbackId;
          }
        } catch (err) {
          console.error("ID 불러오기 오류:", err);
          displayId = "(ID 불러오기 실패)";
        }

        document.getElementById("status").innerText = "로그인 상태: " + displayId;
        loadScore(user);
      } else {
        currentUser = null;
        currentScore = 0;
        document.getElementById("status").innerText = "로그인 상태: 없음";
        document.getElementById("score").innerText = "0";
      }
    });

    // 전역 함수 등록
    window.signUp = signUp;
    window.login = login;
    window.logout = logout;
    window.addPoint = addPoint;
  </script>
</body>
</html>
