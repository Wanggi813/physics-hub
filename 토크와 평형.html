<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ì‹œì†Œ í‰í˜• ê²Œì„ (ì •í™• í‰í˜• + ëª¨ë°”ì¼ + íŒíŠ¸ê°ì )</title>
<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
<style>
  :root{ --bg:#eef6ff; --line:#dbe8ff; --ink:#0f172a; }
  body{
    margin:0;
    background: radial-gradient(1000px 600px at 15% -10%, #eef6ff, #fdfbff);
    font:15px/1.55 system-ui,-apple-system,Segoe UI,Roboto,'Apple SD Gothic Neo','Malgun Gothic',sans-serif;
    color:var(--ink);
    touch-action:none;
  }
  .top-hud{
    position:fixed;left:50%;top:10px;transform:translateX(-50%);
    display:flex;gap:12px;align-items:center;
    background:#ffffffda;border:1px solid var(--line);
    border-radius:16px;padding:8px 12px;z-index:10;
    backdrop-filter:blur(8px);
  }
  .hud-item{display:flex;gap:6px;align-items:baseline}
  .hud-label{font-size:13px;color:#475569}
  .hud-value{font-weight:800;font-size:20px;min-width:70px;text-align:right}

  /* â˜… ìµœê³ ì ìˆ˜ ì „ìš© ìŠ¤íƒ€ì¼ */
  .hud-item.best .hud-value{
    color:#f59e0b;
    text-shadow:0 0 6px rgba(245,158,11,0.7);
    display:flex;
    align-items:center;
    gap:4px;
  }
  .hud-item.best .trophy{
    font-size:18px;
    filter:drop-shadow(0 0 4px rgba(250,204,21,0.9));
  }

  /* â˜… ìµœê³ ì ìˆ˜ ìƒìŠ¹ ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes bestPop {
    0%   { transform:scale(1); }
    30%  { transform:scale(1.25); }
    60%  { transform:scale(0.92); }
    100% { transform:scale(1); }
  }
  .best-bump{
    animation:bestPop 0.6s ease-out;
  }

  .btn{
    border:1px solid var(--line);background:#fff;border-radius:10px;
    padding:4px 10px;cursor:pointer;font-size:13px;
  }
  .btn:hover{background:#eff6ff;}
  #hud{
    position:fixed;left:10px;bottom:10px;background:#fffffff2;
    border:1px solid var(--line);border-radius:10px;padding:8px;font-size:13px;z-index:10;
  }
  .bar{height:8px;background:#eef3ff;border-radius:999px;overflow:hidden;border:1px solid #dbe8ff}
  .bar>span{display:block;height:100%;background:linear-gradient(90deg,#67e8f9,#60a5fa)}
  .stars{font-size:18px;letter-spacing:2px}
  .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;font-weight:700}
  .ok{background:#eafaf5;color:#065f46;border:1px solid #b7f0de}

  /* ê°ì  í† ìŠ¤íŠ¸ */
  .toast{
    position:fixed;left:50%;top:56px;transform:translateX(-50%);
    background:#fee2e2;border:1px solid #fecaca;color:#991b1b;
    padding:6px 12px;border-radius:999px;font-weight:800;z-index:20;
    opacity:0; pointer-events:none; transition:opacity .15s ease, transform .5s cubic-bezier(.2,.6,.2,1);
  }
  .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px);}
</style>
</head>
<body>

<!-- ìƒë‹¨ HUD -->
<div class="top-hud">
  <div class="hud-item"><div class="hud-label">ë ˆë²¨</div><div class="hud-value" id="lvl">1</div></div>
  <div class="hud-item"><div class="hud-label">ì ìˆ˜</div><div class="hud-value" id="score">0</div></div>

  <!-- â˜… ìµœê³ ì ìˆ˜ í‘œì‹œ (ì•„ì´ì½˜ + ê°•ì¡°) -->
  <div class="hud-item best">
    <div class="hud-label">ìµœê³ ì ìˆ˜</div>
    <div class="hud-value" id="bestTop">
      <span class="trophy">ğŸ†</span>
      <span class="best-number">0</span>
    </div>
  </div>

  <div class="hud-item"><div class="hud-label">ì‹œê°„</div><div class="hud-value" id="time">30.0s</div></div>
  <button id="resetBtn" class="btn">ìƒˆ ê²Œì„</button>
  <button id="hintBtn" class="btn">íŒíŠ¸</button>
  <span class="badge ok" id="eqBadge" style="display:none;">ì •í™• í‰í˜•!</span>
</div>

<!-- ê°ì  í† ìŠ¤íŠ¸ -->
<div id="penaltyToast" class="toast">-30ì </div>

<!-- ì¢Œí•˜ë‹¨ HUD -->
<div id="hud">
  <div><b>ëª©í‘œ:</b> ëª¨ë“  ë¸”ë¡ì„ ì‚¬ìš©í•´ <b>í† í¬í‰í˜•</b> ë§Œë“¤ê¸° (0ì¹¸ ê¸ˆì§€)</div>
  <div style="margin:6px 0 4px">ì•Œì§œí† í¬</div>
  <div class="bar" style="width:200px"><span id="tauFill" style="width:0%"></span></div>
  <div style="margin-top:4px">ì•Œì§œí† í¬ = <span id="tauVal">0</span> (ì •í™• 0ë§Œ ì„±ê³µ)</div>
  <div style="margin-top:4px">íŒíŠ¸ ì‚¬ìš©: <b><span id="hintCount">0</span>íšŒ</b> (íšŒë‹¹ -30ì )</div>
  <div style="margin-top:4px" class="stars" id="stars"></div>
</div>

<script>
/* ===== ìƒìˆ˜ ===== */
const maxAngle = Math.PI/180 * 10;
const slotRange = 4;
const ALLOWED_SLOTS = [-4,-3,-2,-1,1,2,3,4]; // 0 ê¸ˆì§€
const HINT_COST = 30;
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* íŒŒìŠ¤í…” ìƒ‰ìƒ */
const PASTELS=[
  ['#ffe8ec','#ffb3c0'],['#fff0da','#ffd098'],['#fff6d5','#ffe082'],
  ['#eef9db','#bfe69b'],['#ddfbf3','#9fe5d0'],['#e7f6ff','#a8d8ff'],
  ['#ecebff','#c2c1ff'],['#f3e9ff','#d4b6ff'],['#ffe9f6','#ffc2e6']
];
const colorPair=w=>PASTELS[clamp(w-1,0,8)];

/* ===== ì‹œì†Œ ===== */
class Plank{
  constructor(cx,cy,len){
    this.cx=cx;this.cy=cy;this.len=len;
    this.slotDx=this.len/(slotRange*2+2);
    this.angle=0;
  }
  slotToLocalX(k){return k*this.slotDx;}
  slotToScreen(k){
    const lx=this.slotToLocalX(k);
    const c=Math.cos(this.angle),s=Math.sin(this.angle);
    return{x:this.cx+lx*c,y:this.cy+lx*s};
  }
  drawGrid(){
    push();
    translate(this.cx,this.cy);
    rotate(this.angle);

    noStroke();fill(0,0,0,0.08);
    rectMode(CENTER);rect(6,10,this.len+42,58,20);

    drawingContext.save();
    const rr=20,w=this.len,h=40;
    const path=new Path2D();
    roundedRectPath(path,-w/2,-h/2,w,h,rr);
    drawingContext.fillStyle=gradientLR('#fff5e6','#ffe8c9',-w/2,0,w,0);
    drawingContext.strokeStyle='#e0c9a6';drawingContext.lineWidth=2.4;
    drawingContext.fill(path);drawingContext.stroke(path);
    drawingContext.clip(path);
    drawingContext.globalAlpha=0.25;drawingContext.strokeStyle='#e6d5b6';
    for(let i=-Math.floor(w/40);i<=Math.floor(w/40);i++){
      drawingContext.beginPath();
      drawingContext.moveTo(i*40,-20);
      drawingContext.lineTo(i*40,20);
      drawingContext.stroke();
    }
    drawingContext.restore();

    stroke('#9fb1d9');
    for(let k=-slotRange;k<=slotRange;k++){
      const x=this.slotToLocalX(k);
      line(x,-22,x,22);
      noStroke();fill(k===0?'#ef4444':'#374151');
      textAlign(CENTER,TOP);textSize(12);text(k,x,24);
    }

    noFill();stroke('#ef4444');strokeWeight(2);
    line(-10,-16,10,16);line(-10,16,10,-16);
    pop();
  }
}
function roundedRectPath(path,x,y,w,h,r){
  path.moveTo(x+r,y);path.lineTo(x+w-r,y);path.quadraticCurveTo(x+w,y,x+w,y+r);
  path.lineTo(x+w,y+h-r);path.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  path.lineTo(x+r,y+h);path.quadraticCurveTo(x,y+h,x,y+h-r);
  path.lineTo(x,y+r);path.quadraticCurveTo(x,y,x+r,y);path.closePath();
}
function gradientLR(c1,c2,x0,y0,x1,y1){
  const g=drawingContext.createLinearGradient(x0,y0,x0+x1,y0+y1);
  g.addColorStop(0,c1);g.addColorStop(1,c2);return g;
}

/* ===== ë¸”ë¡ ===== */
class Block{
  constructor(w){
    this.w=w;this.size=map(w,1,9,28,52);[this.c1,this.c2]=colorPair(w);
    this.x=random(width*0.35,width*0.65);this.y=random(height*0.72,height*0.84);
    this.onPlank=false;this.slot=0;this.snap=0;
  }
  screenPos(){return this.onPlank?plank.slotToScreen(this.slot):{x:this.x,y:this.y};}
  draw(){
    const {x,y}=this.screenPos();const s=1+0.08*Math.sin(this.snap*Math.PI),sz=this.size;
    push();translate(x,y);scale(s);rectMode(CENTER);
    noStroke();fill(0,0,0,0.15);rect(4,6,sz*0.9,sz*0.9,8);
    drawingContext.save();
    const g=drawingContext.createLinearGradient(-sz/2,-sz/2,sz/2,sz/2);
    g.addColorStop(0,this.c1);g.addColorStop(1,this.c2);
    drawingContext.fillStyle=g;stroke('#9ca3af');strokeWeight(1.6);rect(0,0,sz,sz,10);
    drawingContext.clip();drawingContext.globalAlpha=0.15;stroke('#ffffff');
    for(let i=-sz/2;i<sz/2;i+=6)line(i,-sz/2,i,sz/2);
    drawingContext.restore();
    noStroke();fill(255,255,255,0.3);rect(0,-sz*0.25,sz*0.9,sz*0.15,4);
    noStroke();fill('#0f172a');textAlign(CENTER,CENTER);textSize(14);text(`${this.w} kg`,0,1);
    pop();
    if(this.snap>0)this.snap=Math.max(0,this.snap-0.06);
  }
  hit(mx,my){
    const {x,y}=this.screenPos();
    return dist(mx,my,x,y)<Math.max(24,this.size*0.65);
  }
}

/* ===== íŒŒí‹°í´ ===== */
let particles=[];
class Particle{
  constructor(x,y){
    this.x=x;this.y=y;
    const a=random(TWO_PI),sp=random(1.8,4.2);
    this.vx=Math.cos(a)*sp;this.vy=Math.sin(a)*sp-random(0.2,1.0);
    this.life=random(40,60);this.r=random(3.5,6.5);
  }
  step(){this.x+=this.vx;this.y+=this.vy;this.vy+=0.07;this.life--;}
  draw(){
    noStroke();const alpha=map(this.life,0,60,0,1);
    fill(`hsla(50 95% 60% / ${alpha})`);circle(this.x,this.y,this.r);
    fill(`hsla(48 100% 70% / ${alpha*0.35})`);circle(this.x,this.y,this.r*2.2);
  }
}

/* ===== ì „ì—­ ìƒíƒœ ===== */
let plank, blocks=[], heldIdx=-1, level=1, score=0, streak=0, timeLeft=30.0, justCleared=false, numBlocks=2;
let solutionSlots=[]; let showHint=false; let hintTimer=0; let hintCount=0;
/* â˜… ì—°ì† ì„±ê³µ ìµœê³  ì ìˆ˜ */
let bestScore = 0;

/* ìµœê³  ì ìˆ˜ UI ì—…ë°ì´íŠ¸ (animate=trueì¼ ë•Œ íŒ ì• ë‹ˆë©”ì´ì…˜) */
function updateBestScoreUI(animate=false){
  const container = document.getElementById('bestTop');
  if (!container) return;
  const numSpan = container.querySelector('.best-number');
  if (numSpan) numSpan.textContent = bestScore;

  if (animate){
    container.classList.remove('best-bump');
    // reflow to restart animation
    void container.offsetWidth;
    container.classList.add('best-bump');
  }
}

/* Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ ìµœê³  ì ìˆ˜ ë°˜ì˜ */
window.setBestScoreFromFirebase = function(scoreFromDb){
  bestScore = Number(scoreFromDb) || 0;
  updateBestScoreUI(false);
};

/* ===== p5 ===== */
function setup(){
  createCanvas(windowWidth,windowHeight).position(0,0);
  pixelDensity(1); textFont('system-ui');
  document.getElementById('resetBtn').onclick=()=>newGame();
  document.getElementById('hintBtn').onclick=onHint;
  newGame();
}
function windowResized(){
  resizeCanvas(windowWindow=windowWidth,windowHeight);
  if(plank){
    plank.cx=width/2;plank.cy=height*0.55;plank.len=Math.min(width*0.88,1000);
    plank.slotDx=plank.len/(slotRange*2+2);
  }
}

/* ìƒˆ ê²Œì„: ë ˆë²¨/ì ìˆ˜/ì—°ì† ì„±ê³µ/íŒíŠ¸ ì¹´ìš´íŠ¸ ì´ˆê¸°í™” (ìµœê³  ì ìˆ˜ëŠ” ìœ ì§€) */
function newGame(){
  level=1;
  score=0;
  streak=0;
  hintCount=0;
  updateHintCount();
  document.getElementById('score').textContent = score;
  setupLevel(level);
}

/* ===== í¼ì¦ ìƒì„± ===== */
function setupLevel(lv){
  numBlocks=Math.min(2+Math.floor((lv-1)/2),5);
  plank=new Plank(width/2,height*0.55,Math.min(width*0.88,1000));
  const {weights,slots}=generateExactCase(numBlocks);
  blocks=weights.map(w=>new Block(w));
  solutionSlots=slots;
  timeLeft=clamp(28-(lv-1)*2,12,28);justCleared=false;particles.length=0;
  document.getElementById('lvl').textContent=lv;
  document.getElementById('eqBadge').style.display='none';
  document.getElementById('stars').textContent='';
}
function generateExactCase(n){
  while(true){
    const slots=shuffle([...ALLOWED_SLOTS]).slice(0,n);
    let sum=0,weights=[];
    for(let i=0;i<n-1;i++){
      const w=1+floor(random(9));
      weights.push(w);sum+=w*slots[i];
    }
    const wN=(-sum)/slots[n-1];
    if(Number.isInteger(wN)&&wN>=1&&wN<=9){
      weights.push(wN);return{weights:shuffle(weights),slots};
    }
  }
}

/* ===== íŒíŠ¸ ì²˜ë¦¬ (ê°ì  í¬í•¨) ===== */
function onHint(){
  // ì •ë‹µ í‘œì‹œ
  showHint=true; hintTimer=120; // ì•½ 2ì´ˆ

  // ê°ì  ì²˜ë¦¬
  hintCount++; updateHintCount();
  score=Math.max(0, score - HINT_COST);
  if(navigator.vibrate) navigator.vibrate(30);
  document.getElementById('score').textContent=score;
  flashPenalty(`-${HINT_COST}ì `);
}
function updateHintCount(){
  document.getElementById('hintCount').textContent = hintCount;
}
function flashPenalty(text){
  const t = document.getElementById('penaltyToast');
  t.textContent = text;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 700);
}

/* ===== ë©”ì¸ ë£¨í”„ ===== */
function draw(){
  clear();background('#eef6ff');
  const torque=computeTorque();const maxT=numBlocks*9*4;
  plank.angle=map(torque,-maxT,maxT,-maxAngle,maxAngle);
  plank.drawGrid();
  for(const b of blocks)b.draw();

  if(showHint&&hintTimer>0){
    hintTimer--;drawHints();
    if(hintTimer<=0)showHint=false;
  }

  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.step();p.draw();
    if(p.life<=0)particles.splice(i,1);
  }

  updateHUD(torque);
  const used=blocks.filter(b=>b.onPlank).length,eqNow=(used===blocks.length)&&(torque===0);
  if(!justCleared&&eqNow)levelClear();

  // ì‹¤íŒ¨(ì‹œê°„ ì´ˆê³¼) ì²˜ë¦¬: ì—°ì† ì„±ê³µ/ì ìˆ˜ ë¦¬ì…‹
  if(!justCleared){
    timeLeft-=deltaTime/1000;
    if(timeLeft<=0){
      timeLeft=0;
      streak=0;
      score=0;
      document.getElementById('score').textContent = score;
      setupLevel(level);
    }
  }
}
function computeTorque(){
  let s=0;for(const b of blocks){if(b.onPlank)s+=b.w*b.slot;}return s;
}

/* ë ˆë²¨ í´ë¦¬ì–´: ì—°ì† ì„±ê³µ ì‹œë§ˆë‹¤ +50ì , ìµœê³  ì ìˆ˜ ì €ì¥ */
function levelClear(){
  justCleared=true;
  document.getElementById('eqBadge').style.display='inline-flex';
  const speed=clamp(timeLeft/clamp(28-(level-1)*2,12,28),0,1);
  const stars=1+(speed>0.6)+(speed>0.85);
  document.getElementById('stars').textContent='â˜…'.repeat(stars)+'â˜†'.repeat(3-stars);

  // ì—°ì† ì„±ê³µ ì ìˆ˜: ì„±ê³µí•  ë•Œë§ˆë‹¤ +50ì 
  streak += 1;
  score += 50;
  document.getElementById('score').textContent = score;

  // ìµœê³  ì ìˆ˜ ê°±ì‹  ë° Firebase ì €ì¥ + ì• ë‹ˆë©”ì´ì…˜
  if (score > bestScore) {
    bestScore = score;
    updateBestScoreUI(true);
    if (window.saveBestScoreToFirebase) {
      window.saveBestScoreToFirebase(bestScore);
    }
  }

  for(let i=0;i<100;i++){
    const x=plank.cx+random(-plank.len*0.45,plank.len*0.45);
    particles.push(new Particle(x,plank.cy-8));
  }
  setTimeout(()=>{level+=1;setupLevel(level);},900);
}

function updateHUD(torque){
  document.getElementById('time').textContent=`${timeLeft.toFixed(1)}s`;
  document.getElementById('tauVal').textContent=torque;
  const maxT=numBlocks*9*4;
  const fill=clamp(map(Math.abs(torque),0,maxT,100,0),0,100);
  document.getElementById('tauFill').style.width=`${fill}%`;
}
function drawDock(){
  const w=plank?Math.min(plank.len*0.9,width*0.9):width*0.9;
  const x=(plank?plank.cx:width/2)-w/2;const y=(plank?plank.cy:height*0.55)+84;
  noStroke();fill(255,255,255,0.9);rect(x,y,w,92,18);
  stroke('#dbe8ff');noFill();rect(x,y,w,92,18);
  noStroke();fill('#6b7280');textSize(13);
  text(`ëª¨ë“  ë¸”ë¡ ë°°ì¹˜ í›„ Î£(wÂ·r)=0 ë§Œë“¤ê¸° (0ì¹¸ ê¸ˆì§€, ${numBlocks}ê°œ ë¸”ë¡)`,x+12,y+26);
}
function drawHints(){
  for(let k of solutionSlots){
    const p=plank.slotToScreen(k);
    noFill();stroke('#facc15');strokeWeight(3);circle(p.x,p.y,36);
  }
}

/* ===== ì…ë ¥: PC/ëª¨ë°”ì¼ ê³µí†µ ===== */
function handlePress(mx,my){
  for(let i=blocks.length-1;i>=0;i--){
    if(blocks[i].hit(mx,my)){heldIdx=i;break;}
  }
}
function handleDrag(mx,my){
  if(heldIdx<0)return;
  const b=blocks[heldIdx];b.onPlank=false;b.x=mx;b.y=my;
}
function handleRelease(mx,my){
  if(heldIdx<0)return;
  const b=blocks[heldIdx];heldIdx=-1;
  let bestK=null,bestD=1e9;
  for(const k of ALLOWED_SLOTS){
    const p=plank.slotToScreen(k);const d=dist(mx,my,p.x,p.y);
    if(d<bestD){bestD=d;bestK=k;}
  }
  if(bestD<46){b.onPlank=true;b.slot=bestK;b.snap=1;}else{b.onPlank=false;}
}
/* ë§ˆìš°ìŠ¤ */
function mousePressed(){handlePress(mouseX,mouseY);}
function mouseDragged(){handleDrag(mouseX,mouseY);}
function mouseReleased(){handleRelease(mouseX,mouseY);}
/* í„°ì¹˜ */
function touchStarted(){const t=touches[0];if(t)handlePress(t.x,t.y);return false;}
function touchMoved(){const t=touches[0];if(t)handleDrag(t.x,t.y);return false;}
function touchEnded(){const t=touches[0]||{x:mouseX,y:mouseY};handleRelease(t.x,t.y);return false;}
</script>

<!-- ===== Firebase ì ìˆ˜ ì—°ë™ (í† í¬ì™€ í‰í˜•) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
    authDomain: "simulation-67cd3.firebaseapp.com",
    projectId: "simulation-67cd3",
    storageBucket: "simulation-67cd3.appspot.com",
    messagingSenderId: "615983461615",
    appId: "1:615983461615:web:002e07bcea878eb6d5571a",
    measurementId: "G-9RGN7LYE5W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const SIM_ID = "í† í¬ì™€_í‰í˜•";
  let firebaseUser = null;

  async function saveBestScore(score) {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      await setDoc(ref, { score: Number(score) || 0 }, { merge: true });
    } catch (err) {
      console.error("[í† í¬ì™€ í‰í˜•] ìµœê³  ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:", err);
    }
  }

  async function loadBestScore() {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const score = Number(data.score || 0) || 0;
        if (window.setBestScoreFromFirebase) {
          window.setBestScoreFromFirebase(score);
        }
      }
    } catch (err) {
      console.error("[í† í¬ì™€ í‰í˜•] ìµœê³  ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
    }
  }

  window.saveBestScoreToFirebase = saveBestScore;

  onAuthStateChanged(auth, async (user) => {
    firebaseUser = user;
    if (user) {
      await loadBestScore();
    }
  });
</script>

</body>
</html>
