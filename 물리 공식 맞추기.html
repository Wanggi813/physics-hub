<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë¬¼ë¦¬ ê³µì‹ íƒ€ì´í•‘ ë ˆì¸ (êµì‹¤ + ì½¤ë³´ + ê²½ê³  + ì•„ì´í…œ + Firebase)</title>

<!-- âœ… p5.js ë¡œì»¬ ë¡œë“œ -->
<script src="./libs/p5.min.js"></script>

<style>
:root{
  --card:#ffffff;
  --border:#dbeafe;
  --ink:#0f172a;
  --muted:#475569;
  --accent:#38bdf8;
  --good:#22c55e;
  --bad:#ef4444;
  --shadow:0 10px 30px rgba(0,0,0,0.10);
}
html,body{
  margin:0; height:100%;
  font-family:system-ui,"Noto Sans KR",sans-serif;
  color:var(--ink);
  overflow:hidden;
  background: radial-gradient(1200px 700px at 15% -10%, #f2fbff, #ffffff);
}

/* íŒ¨ë„ ìœ ë¦¬ ëŠë‚Œ */
.panel{
  position:fixed; top:16px; bottom:16px; width:300px;
  background: rgba(255,255,255,0.88);
  border:1px solid rgba(219,234,254,0.95);
  border-radius:16px;
  padding:14px;
  box-shadow:var(--shadow);
  overflow:auto;
  z-index:10;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
#left{left:16px}
#right{right:16px}
h3{margin:6px 0 10px;font-size:15px}
small{color:var(--muted)}
input{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid rgba(219,234,254,0.95);
  font-size:14px;
  outline:none;
}
input:focus{border-color:rgba(56,189,248,0.75)}
.row{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;}
.badge{
  font-size:12px;
  padding:3px 10px;
  border-radius:999px;
  background:rgba(56,189,248,0.10);
  border:1px solid rgba(56,189,248,0.22);
  color:#075985;
}
.badge.good{
  background:rgba(34,197,94,0.12);
  border-color:rgba(34,197,94,0.22);
  color:#166534;
}
.badge.warn{
  background:rgba(245,158,11,0.12);
  border-color:rgba(245,158,11,0.22);
  color:#92400e;
}
.msg{font-size:13px; color:var(--muted); min-height:18px; margin-top:8px}
.msg.good{color:var(--good); font-weight:800}
.msg.bad{color:var(--bad); font-weight:800}
.answer{font-size:13px; padding:3px 0}
.d1{ color:#0f766e }
.d2{ color:#0369a1 }
.d3{ color:#7c2d12 }

/* ìµœê³ ì ìˆ˜ */
.bestWrap{
  margin-top:12px;
  padding-top:10px;
  border-top:1px dashed rgba(219,234,254,0.9);
}
.bestLabel{font-size:13px; color:var(--muted); margin-bottom:6px}
.bestValue{
  color:#f59e0b;
  text-shadow:0 0 6px rgba(245,158,11,0.7);
  display:flex;
  align-items:center;
  gap:6px;
  font-weight:900;
  font-size:22px;
}
.bestValue .trophy{
  font-size:20px;
  filter:drop-shadow(0 0 4px rgba(250,204,21,0.9));
}
@keyframes bestPop {
  0%   { transform:scale(1); }
  30%  { transform:scale(1.25); }
  60%  { transform:scale(0.92); }
  100% { transform:scale(1); }
}
.best-bump{ animation:bestPop 0.6s ease-out; }

/* ìº”ë²„ìŠ¤ëŠ” íˆ¬ëª…(êµì‹¤ ë°°ê²½ì´ p5ë¡œ ê·¸ë ¤ì§) */
canvas{
  position:fixed;
  left:332px; right:332px;
  top:16px; bottom:16px;
  border-radius:20px;
  background: rgba(255,255,255,0.25);
  border:1px solid rgba(219,234,254,0.95);
  box-shadow:0 10px 30px rgba(0,0,0,0.10);
  z-index:5;
}
</style>
</head>

<body>
  <div id="left" class="panel">
    <h3>âŒ¨ï¸ ì…ë ¥</h3>
    <input id="ans" placeholder="ì •ë‹µ ì…ë ¥ í›„ Enter (ë„ì–´ì“°ê¸° ì •í™•íˆ)" />
    <div class="msg" id="msg">ê³µì‹ì´ ë–¨ì–´ì§€ë©´, ê·¸ ê³µì‹ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</div>

    <h3 style="margin-top:14px;">ì ìˆ˜</h3>
    <div class="row">
      <div style="font-size:34px;font-weight:900;color:var(--accent)" id="score">0</div>
      <span class="badge" id="perCorrectBadge">ì •ë‹µ +20</span>
      <span class="badge" id="speedBadge">ì†ë„ 1.00Ã—</span>
    </div>

    <div class="row" style="margin-top:6px;">
      <span class="badge good" id="comboBadge">ì½¤ë³´ 0</span>
    </div>

    <!-- ì•„ì´í…œ ìƒíƒœ -->
    <div class="row" style="margin-top:10px;">
      <span class="badge" id="x2Badge" style="display:none;">ì ìˆ˜ 2ë°°</span>
      <span class="badge warn" id="freezeBadge" style="display:none;">ì‹œê°„ ì •ì§€</span>
      <span class="badge good" id="shieldBadge" style="display:none;">ë³´í˜¸ë§‰</span>
    </div>

    <!-- ìµœê³ ì ìˆ˜ -->
    <div class="bestWrap">
      <div class="bestLabel">ìµœê³ ì ìˆ˜</div>
      <div class="bestValue" id="bestTop">
        <span class="trophy">ğŸ†</span>
        <span class="best-number">0</span>
      </div>
      <div style="margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45">
        * ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ê³ , ê°±ì‹  ì‹œ ì €ì¥í•©ë‹ˆë‹¤.
      </div>
    </div>

    <p style="margin-top:12px; font-size:12px; line-height:1.45; color:var(--muted);">
      â€¢ ì •ë‹µ +20 (ì ìˆ˜ 2ë°° ì¤‘ì—ëŠ” +40)<br>
      â€¢ ì½¤ë³´ê°€ ìŒ“ì´ë©´ <b>ì¶”ê°€ ë³´ë„ˆìŠ¤</b>ê°€ ë¶™ì–´ìš”<br>
      â€¢ ì•„ì´í…œ: ì ìˆ˜ 2ë°° / ì‹œê°„ ì •ì§€ / ë³´í˜¸ë§‰<br>
      â€¢ ì…ë ¥: <b>í•œê¸€Â·ìˆ«ìÂ·ê³µë°±</b>ë§Œ (ë„ì–´ì“°ê¸° ì •í™•íˆ)
    </p>
  </div>

  <div id="right" class="panel">
    <h3>ğŸ“˜ ì •ë‹µ ëª©ë¡ <small>(ë„ì–´ì“°ê¸° ê·¸ëŒ€ë¡œ)</small></h3>
    <div id="answers"></div>

    <h3 style="margin-top:14px;">ğŸ ì•„ì´í…œ ëª©ë¡</h3>
    <div class="answer">ì ìˆ˜ 2ë°°</div>
    <div class="answer">ì‹œê°„ ì •ì§€</div>
    <div class="answer">ë³´í˜¸ë§‰</div>
  </div>

<script>
/* =========================
   ë°ì´í„°(ê³µì‹)
   ========================= */
const FORMULAS = [
  {formula:"v = vâ‚€ + at",             answer:"ì†ë ¥ ê³µì‹",         diff:1, unit:"ìš´ë™"},
  {formula:"x = xâ‚€ + vâ‚€t + Â½atÂ²",     answer:"ë“±ê°€ì†ë„ ê³µì‹",     diff:2, unit:"ìš´ë™"},
  {formula:"F = ma",                  answer:"ë‰´í„´ ì œ2ë²•ì¹™",      diff:1, unit:"ìš´ë™"},
  {formula:"p = mv",                  answer:"ìš´ë™ëŸ‰",           diff:1, unit:"ìš´ë™"},
  {formula:"FÎ”t = Î”p",                answer:"ì¶©ê²©ëŸ‰",           diff:2, unit:"ìš´ë™"},
  {formula:"W = Fd",                  answer:"ì¼",               diff:1, unit:"ìš´ë™"},
  {formula:"K = Â½mvÂ²",                answer:"ìš´ë™ ì—ë„ˆì§€",       diff:1, unit:"ìš´ë™"},
  {formula:"U = mgh",                 answer:"ì¤‘ë ¥ í¼í…ì…œ ì—ë„ˆì§€", diff:2, unit:"ìš´ë™"},
  {formula:"E = K + U",               answer:"ì—­í•™ì  ì—ë„ˆì§€",     diff:2, unit:"ìš´ë™"},

  {formula:"a = vÂ² / r",              answer:"êµ¬ì‹¬ ê°€ì†ë„",       diff:2, unit:"ì›ìš´ë™"},
  {formula:"F = mvÂ² / r",             answer:"êµ¬ì‹¬ë ¥",           diff:2, unit:"ì›ìš´ë™"},
  {formula:"v = rÏ‰",                  answer:"ì„ ì†ë„",           diff:2, unit:"ì›ìš´ë™"},
  {formula:"Ï‰ = 2Ï€ / T",              answer:"ê°ì†ë„",           diff:2, unit:"ì›ìš´ë™"},

  {formula:"v = fÎ»",                  answer:"íŒŒë™ ì†ë ¥",        diff:1, unit:"íŒŒë™"},
  {formula:"f = 1 / T",               answer:"ì§„ë™ìˆ˜",           diff:1, unit:"íŒŒë™"},
  {formula:"y = A sin(Ï‰t)",           answer:"ë‹¨ìˆœ ì¡°í™” ìš´ë™",     diff:3, unit:"íŒŒë™"},

  {formula:"n = c / v",               answer:"êµ´ì ˆë¥ ",           diff:2, unit:"ê´‘í•™"},
  {formula:"nâ‚sinÎ¸â‚ = nâ‚‚sinÎ¸â‚‚",       answer:"ìŠ¤ë„¬ì˜ ë²•ì¹™",       diff:2, unit:"ê´‘í•™"},
  {formula:"sinÎ¸c = nâ‚‚ / nâ‚",         answer:"ì„ê³„ê°",           diff:3, unit:"ê´‘í•™"},
  {formula:"Î¸i = Î¸r",                 answer:"ë°˜ì‚¬ ë²•ì¹™",         diff:1, unit:"ê´‘í•™"},
  {formula:"d sinÎ¸ = mÎ»",             answer:"ì´ì¤‘ ìŠ¬ë¦¿",         diff:3, unit:"ê´‘í•™"},

  {formula:"V = IR",                  answer:"ì˜´ì˜ ë²•ì¹™",         diff:1, unit:"ì „ê¸°"},
  {formula:"P = VI",                  answer:"ì „ë ¥",             diff:1, unit:"ì „ê¸°"},
  {formula:"Q = It",                  answer:"ì „í•˜ëŸ‰",           diff:1, unit:"ì „ê¸°"},
  {formula:"V = Q / C",               answer:"ì¶•ì „ê¸° ê³µì‹",      diff:2, unit:"ì „ê¸°"}
];

/* =========================
   ì•„ì´í…œ
   ========================= */
const ITEMS = [
  {
    kind:"item",
    title:"ì ìˆ˜ 2ë°°",
    answer:"ì ìˆ˜ 2ë°°",
    desc:"10ì´ˆ ë™ì•ˆ ì •ë‹µ ì ìˆ˜ 2ë°°",
    apply(){ effectX2Until = millis() + 10000; }
  },
  {
    kind:"item",
    title:"ì‹œê°„ ì •ì§€",
    answer:"ì‹œê°„ ì •ì§€",
    desc:"5ì´ˆ ë™ì•ˆ ë“œë¡­ ì •ì§€",
    apply(){ freezeUntil = millis() + 5000; }
  },
  {
    kind:"item",
    title:"ë³´í˜¸ë§‰",
    answer:"ë³´í˜¸ë§‰",
    desc:"10ì´ˆ ë™ì•ˆ ë¯¸ìŠ¤ 1íšŒ ë¬´ì‹œ",
    apply(){ shieldUntil = millis() + 10000; shieldCharges = 1; }
  }
];

/* =========================
   ìš°ì¸¡ ì •ë‹µ ëª©ë¡
   ========================= */
const answersBox = document.getElementById("answers");
FORMULAS
  .map(x=>({a:x.answer,d:x.diff}))
  .sort((p,q)=>p.d-q.d || p.a.localeCompare(q.a))
  .forEach(({a,d})=>{
    const div=document.createElement("div");
    div.className="answer d"+d;
    div.textContent=a;
    answersBox.appendChild(div);
  });

/* =========================
   ì ìˆ˜/ìµœê³ ì ìˆ˜/ì½¤ë³´
   ========================= */
let score=0, bestScore=0;
let totalCorrect=0;

let combo=0;              // ì—°ì† ì •ë‹µ
let comboFlash=0;         // ì½¤ë³´ í…ìŠ¤íŠ¸ ì´í™íŠ¸ íƒ€ì´ë¨¸(í”„ë ˆì„)

const BASE_PER_CORRECT = 20;
const MISS_PENALTY = 20;

// ì½¤ë³´ ë³´ë„ˆìŠ¤: 3ì½¤ë³´ë¶€í„° +2ì”©(ìµœëŒ€ +20 ë³´ë„ˆìŠ¤)
function comboBonus(){
  if(combo < 3) return 0;
  return Math.min(20, 2 * (combo - 2));
}

function perCorrectNow(){
  const base = isX2Active() ? BASE_PER_CORRECT*2 : BASE_PER_CORRECT;
  return base + comboBonus();
}

function updateScoreUI(){
  document.getElementById("score").textContent = score;
  const x2Text = isX2Active() ? " (2ë°°)" : "";
  const bonus = comboBonus();
  document.getElementById("perCorrectBadge").textContent =
    `ì •ë‹µ +${BASE_PER_CORRECT}${x2Text}` + (bonus>0 ? ` +ì½¤ë³´${bonus}` : "");
  document.getElementById("comboBadge").textContent = `ì½¤ë³´ ${combo}`;
}

function updateBestScoreUI(animate=false){
  const container = document.getElementById("bestTop");
  const numSpan = container.querySelector(".best-number");
  numSpan.textContent = bestScore;
  if(animate){
    container.classList.remove("best-bump");
    void container.offsetWidth;
    container.classList.add("best-bump");
  }
}

window.setBestScoreFromFirebase = function(scoreFromDb){
  bestScore = Number(scoreFromDb) || 0;
  updateBestScoreUI(false);
};

/* =========================
   ë‚œì´ë„/ì†ë„
   ========================= */
let drops=[];
let lastSpawn=0;

function spawnIntervalMs(){
  return Math.max(1050, 2200 * Math.pow(0.992, totalCorrect));
}
function fallSpeedPxPerSec(){
  return Math.min(110, 35 * Math.pow(1.006, totalCorrect));
}
function speedFactor(){
  return fallSpeedPxPerSec()/35;
}

/* =========================
   ì´í™íŠ¸/ì•„ì´í…œ ìƒíƒœ
   ========================= */
let bursts=[];
function spawnBurst(x,y,good=true){
  const n = good ? 36 : 18;
  for(let i=0;i<n;i++){
    bursts.push({
      x,y,
      vx: random(-260,260),
      vy: random(-320,120),
      life: random(0.35,0.80),
      t: 0,
      good
    });
  }
}

let freezeUntil = 0;
let effectX2Until = 0;
let shieldUntil = 0;
let shieldCharges = 0;

function isFrozen(){ return millis() < freezeUntil; }
function isX2Active(){ return millis() < effectX2Until; }
function isShieldActive(){ return millis() < shieldUntil && shieldCharges > 0; }

function updateEffectBadges(){
  const x2 = document.getElementById("x2Badge");
  const fr = document.getElementById("freezeBadge");
  const sh = document.getElementById("shieldBadge");

  x2.style.display = isX2Active() ? "inline-flex" : "none";
  fr.style.display = isFrozen() ? "inline-flex" : "none";
  sh.style.display = isShieldActive() ? "inline-flex" : "none";

  if(isShieldActive()) sh.textContent = `ë³´í˜¸ë§‰ (${shieldCharges})`;
  else sh.textContent = "ë³´í˜¸ë§‰";
}

/* =========================
   ë“œë¡­ ìƒì„±
   ========================= */
const ITEM_CHANCE = 0.13;

function spawnDrop(){
  const isItem = Math.random() < ITEM_CHANCE;

  if(isItem){
    const it = random(ITEMS);
    const w = 320, h = 74;
    const x = random(w/2 + 20, width - w/2 - 20);
    const y = -40;
    drops.push({
      kind:"item",
      title: it.title,
      answer: it.answer,
      desc: it.desc,
      apply: it.apply,
      unit:"ì•„ì´í…œ",
      diff: 0,
      x,y,w,h,
      v: fallSpeedPxPerSec() * random(0.85, 1.00)
    });
    return;
  }

  const f = random(FORMULAS);
  const w = constrain(240 + f.formula.length*8, 260, 560);
  const h = 74;
  const x = random(w/2 + 20, width - w/2 - 20);
  const y = -40;
  drops.push({
    kind:"formula",
    formula:f.formula,
    answer:f.answer,
    unit:f.unit,
    diff:f.diff,
    x,y,w,h,
    v: fallSpeedPxPerSec() * random(0.92, 1.06)
  });
}

/* =========================
   ê²½ê³  ë¼ì¸ + í™”ë©´ í”ë“¤ë¦¼
   ========================= */
let shakeT = 0;
let shakePow = 0;

function triggerShake(power=1){
  shakeT = Math.max(shakeT, 10);
  shakePow = Math.max(shakePow, power);
}

function dangerLevel(){
  // ë°”ë‹¥ ê·¼ì²˜ì— ê³µì‹ì´ ìˆìœ¼ë©´ ìœ„í—˜
  const warnY = height - 34;
  let max = 0;
  for(const d of drops){
    if(d.kind !== "formula") continue;
    const y = d.y + d.h/2;
    if(y > warnY){
      const t = constrain((y - warnY)/28, 0, 1);
      max = Math.max(max, t);
    }
  }
  return max; // 0~1
}

/* =========================
   ì…ë ¥/UI refs
   ========================= */
const inputEl = document.getElementById("ans");
const msgEl   = document.getElementById("msg");

/* =========================
   êµì‹¤ ë°°ê²½(ì´ë¯¸ì§€ ì—†ì´) + ì¹ íŒ ê¸€ì”¨
   ========================= */
function drawGrid(){
  push();
  stroke(219,234,254,80);
  strokeWeight(1);
  for(let x=0;x<=width;x+=56) line(x,0,x,height);
  for(let y=0;y<=height;y+=56) line(0,y,width,y);
  pop();
}

function drawClassroomBG(){
  // ë²½(ê·¸ë¼ë°ì´ì…˜)
  noStroke();
  for(let y=0;y<height;y+=3){
    const t = y/height;
    fill(240 + 10*(1-t), 248 + 6*(1-t), 255, 255);
    rect(0,y,width,3);
  }

  // ë°”ë‹¥(ë‚˜ë¬´í†¤)
  const floorH = Math.floor(height*0.18);
  const floorY = height - floorH;
  for(let y=floorY;y<height;y+=2){
    const t = (y-floorY)/floorH;
    fill(235-25*t, 222-35*t, 195-45*t, 255);
    rect(0,y,width,2);
  }
  stroke(150,120,90,45);
  for(let x=0;x<width;x+=28) line(x,floorY,x,height);
  noStroke();

  // ì¹ íŒ
  const bx = width*0.10, by = height*0.09, bw = width*0.80, bh = height*0.38;
  fill(12, 90, 70, 255);
  rect(bx,by,bw,bh,18);
  stroke(255,255,255,22);
  noFill();
  rect(bx+6,by+6,bw-12,bh-12,14);
  noStroke();

  // ì¹ íŒ íŠ¸ë ˆì´
  fill(235, 238, 245, 210);
  rect(bx, by+bh+10, bw, 14, 10);


  // ì˜…ì€ ê·¸ë¦¬ë“œ
  drawGrid();

  // ë¹„ë„¤íŒ…
  for(let i=0;i<14;i++){
    noFill();
    stroke(0,0,0, 10);
    rect(i,i,width-2*i,height-2*i,20);
  }
  noStroke();

  // âœ… ì¹ íŒì— â€œë¯¸ì…˜/ì½¤ë³´/ì•„ì´í…œâ€ í‘œì‹œ (ë¶„í•„ ëŠë‚Œ)
  push();
  const chalkX = bx + 26;
  const chalkY = by + 34;
  textAlign(LEFT, TOP);
  textFont("system-ui");
  noStroke();

  fill(245, 250, 255, 210);
  textSize(22);
  text("ì˜¤ëŠ˜ì˜ ë¯¸ì…˜", chalkX, chalkY);

  fill(245, 250, 255, 185);
  textSize(16);
  text("ê³µì‹ì´ ë–¨ì–´ì§€ë©´ ì´ë¦„ì„ ì…ë ¥í•˜ì!", chalkX, chalkY+34);

  // ì½¤ë³´ ê°•ì¡°
  const cTxt = `ì½¤ë³´: ${combo}`;
  fill(255, 255, 255, 210);
  textSize(18);
  text(cTxt, chalkX, chalkY+66);

  // ì•„ì´í…œ ìƒíƒœ ë¼ì¸
  let line2 = [];
  if(isX2Active()) line2.push("ì ìˆ˜ 2ë°°");
  if(isFrozen()) line2.push("ì‹œê°„ ì •ì§€");
  if(isShieldActive()) line2.push(`ë³´í˜¸ë§‰(${shieldCharges})`);
  fill(255,255,255,180);
  textSize(14);
  text("ì•„ì´í…œ: " + (line2.length? line2.join(" Â· ") : "ì—†ìŒ"), chalkX, chalkY+92);

  pop();
}

/* =========================
   ë“œë¡­/ì¹´ë“œ ê·¸ë¦¬ê¸°
   ========================= */
function drawDrop(d){
  push();
  translate(d.x, d.y);

  // shadow
  noStroke();
  fill(0,0,0,18);
  rectMode(CENTER);
  rect(4,5,d.w,d.h,16);

  // card
  stroke(219,234,254);
  strokeWeight(1);
  if(d.kind === "item") fill(255, 252, 235);
  else fill(255);
  rect(0,0,d.w,d.h,16);

  // pill
  noStroke();
  if(d.kind === "item") fill(245,158,11,35);
  else fill(56,189,248,35);
  rect(-d.w/2+54,-d.h/2+14,98,22,999);

  if(d.kind === "item") fill(146,64,14);
  else fill(2,132,199);
  textAlign(CENTER,CENTER);
  textSize(11);
  text(d.unit, -d.w/2+54, -d.h/2+14);

  // text
  fill(15,23,42);
  textAlign(CENTER,CENTER);

  if(d.kind === "item"){
    textSize(20);
    text(`ğŸ ${d.title}`, 0, 4);
    textSize(11);
    fill(71,85,105);
    text(d.desc, 0, 26);
  }else{
    textSize(d.diff===3?18:20);
    text(d.formula, 0, 8);
  }

  pop();
}

/* =========================
   ë©”ì‹œì§€
   ========================= */
function setMsg(type, text){
  msgEl.classList.remove("good","bad");
  msgEl.classList.add(type);
  msgEl.textContent = text;
}

/* =========================
   p5 ë¼ì´í”„ì‚¬ì´í´
   ========================= */
function setup(){
  const c=createCanvas(window.innerWidth-664, window.innerHeight-32);
  c.parent(document.body);
  c.position(332,16);
  pixelDensity(1);
  textFont("system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif");

  inputEl.addEventListener("keydown",(e)=>{
    if(e.key==="Enter") submit();
  });

  lastSpawn = millis();
  updateScoreUI();
  updateBestScoreUI(false);
}

function windowResized(){
  resizeCanvas(window.innerWidth-664, window.innerHeight-32);
}

/* ì½¤ë³´ ì´í™íŠ¸ í…ìŠ¤íŠ¸ */
function drawComboOverlay(){
  if(comboFlash <= 0) return;
  const t = comboFlash / 18; // 1->0
  const s = 1 + (1-t)*0.25;
  push();
  translate(width*0.5, height*0.12);
  scale(s);
  textAlign(CENTER,CENTER);
  noStroke();
  fill(56,189,248, 40 + 120*t);
  textSize(54);
  text("COMBO!", 0, 0);
  fill(15,23,42, 70 + 160*t);
  textSize(34);
  text(`${combo} ì½¤ë³´`, 0, 44);
  pop();
  comboFlash--;
}

function draw(){
  // ìœ„í—˜ ê°ì§€(ì •ì§€ ì¤‘ì—” ìœ„í—˜ ì—°ì¶œ ì•½í™”)
  const danger = isFrozen() ? 0 : dangerLevel();

  // í™”ë©´ í”ë“¤ë¦¼
  if(danger > 0.55) triggerShake(0.9 + danger);
  let sx=0, sy=0;
  if(shakeT > 0){
    sx = random(-4,4) * shakePow;
    sy = random(-3,3) * shakePow;
    shakeT--;
    shakePow *= 0.88;
  }else{
    shakePow = 0;
  }

  push();
  translate(sx,sy);

  // êµì‹¤ ë°°ê²½ + ì¹ íŒ ë¯¸ì…˜/ì½¤ë³´
  drawClassroomBG();

  // ê²½ê³  ë¼ì¸(ë°”ë‹¥ ì§ì „)
  const warnY = height - 34;
  const pulse = 0.5 + 0.5*sin(frameCount*0.22);
  if(danger > 0){
    stroke(239,68,68, 80 + 120*danger*pulse);
    strokeWeight(3);
    line(18, warnY, width-18, warnY);
    noStroke();
    fill(239,68,68, 18 + 40*danger);
    rect(18, warnY-8, width-36, 16, 10);
  }

  // ìŠ¤í°(ì •ì§€ ì¤‘ì—” ìŠ¤í° ë©ˆì¶¤)
  if(!isFrozen()){
    if(millis()-lastSpawn >= spawnIntervalMs() && drops.length < 8){
      spawnDrop();
      lastSpawn = millis();
    }
  }

  const dt = deltaTime/1000;
  const floorY = height - 10;

  // ë“œë¡­ ì—…ë°ì´íŠ¸/ë¯¸ìŠ¤ ì²˜ë¦¬
  for(let i=drops.length-1;i>=0;i--){
    const d = drops[i];
    if(!isFrozen()) d.y += d.v * dt;

    drawDrop(d);

    if(d.y + d.h/2 >= floorY){
      if(d.kind === "formula"){
        if(isShieldActive()){
          shieldCharges -= 1;
          setMsg("good", "ë³´í˜¸ë§‰! ë¯¸ìŠ¤ 1íšŒ ë¬´ì‹œ");
          spawnBurst(d.x, floorY-14, true);
        }else{
          // ì½¤ë³´ ëŠê¸°
          combo = 0;
          score = Math.max(0, score - MISS_PENALTY);
          setMsg("bad", `ë¯¸ìŠ¤! (-${MISS_PENALTY}) ì •ë‹µ: ${d.answer}`);
          spawnBurst(d.x, floorY-14, false);
        }
        updateScoreUI();
      }else{
        // ì•„ì´í…œì€ ë†“ì³ë„ íŒ¨ë„í‹° ì—†ìŒ
        setMsg("bad", `ì•„ì´í…œ ë†“ì¹¨: ${d.title}`);
        spawnBurst(d.x, floorY-14, false);
      }
      drops.splice(i,1);
    }
  }

  // íŒŒí‹°í´
  for(let i=bursts.length-1;i>=0;i--){
    const p = bursts[i];
    p.t += dt;
    p.vy += 560*dt;
    p.x += p.vx*dt;
    p.y += p.vy*dt;
    if(p.t > p.life){ bursts.splice(i,1); continue; }
    const a = 1 - p.t/p.life;
    noStroke();
    if(p.good) fill(34,197,94, 220*a);
    else       fill(239,68,68, 200*a);
    circle(p.x,p.y, 4 + 6*a);
    fill(56,189,248, 120*a);
    circle(p.x,p.y, 10 + 14*a);
  }

  // ì½¤ë³´ ì˜¤ë²„ë ˆì´
  drawComboOverlay();

  pop();

  document.getElementById("speedBadge").textContent = `ì†ë„ ${speedFactor().toFixed(2)}Ã—`;
  updateEffectBadges();
}

/* =========================
   ì œì¶œ ì²˜ë¦¬(í•œê¸€+ìˆ«ì+ê³µë°± í—ˆìš©)
   ========================= */
function submit(){
  const s = inputEl.value.trim();

  if(!s){ setMsg("bad","ì…ë ¥ì´ ë¹„ì–´ ìˆì–´ìš”."); return; }

  // âœ… ìˆ«ì í—ˆìš©
  if(!/^[ê°€-í£0-9 ]+$/.test(s)){
    setMsg("bad","í•œê¸€, ìˆ«ì, ê³µë°±ë§Œ ì…ë ¥í•  ìˆ˜ ìˆì–´ìš”.");
    inputEl.value=""; return;
  }

  // ì •í™• ì¼ì¹˜(ë„ì–´ì“°ê¸° í¬í•¨), ê°€ì¥ ì•„ë˜ë¶€í„°
  let best=-1, bestY=-1;
  for(let i=0;i<drops.length;i++){
    if(drops[i].answer === s && drops[i].y > bestY){
      bestY = drops[i].y; best = i;
    }
  }

  if(best >= 0){
    const hit = drops[best];
    drops.splice(best,1);

    if(hit.kind === "item"){
      hit.apply();
      setMsg("good", `ì•„ì´í…œ íšë“! ${hit.title}`);
      spawnBurst(hit.x, hit.y, true);
    }else{
      // âœ… ì •ë‹µ: ì½¤ë³´ ì¦ê°€ + ì ìˆ˜
      combo++;
      comboFlash = 18; // ì½¤ë³´ ì´í™íŠ¸ ë°œë™

      const gain = perCorrectNow();
      score += gain;
      totalCorrect++;

      updateScoreUI();
      setMsg("good", `ì •ë‹µ! (+${gain}) â†’ ${hit.answer}`);
      spawnBurst(hit.x, hit.y, true);

      // ìµœê³ ì ìˆ˜ ê°±ì‹  + Firebase ì €ì¥
      if(score > bestScore){
        bestScore = score;
        updateBestScoreUI(true);
        if(window.saveBestScoreToFirebase) window.saveBestScoreToFirebase(bestScore);
      }
    }
  }else{
    // ì˜¤ë‹µ: ì½¤ë³´ ê¹¨ì§(ê²Œì„ ë§›)
    combo = 0;
    updateScoreUI();
    setMsg("bad","ì˜¤ë‹µ! (ë„ì–´ì“°ê¸°ê¹Œì§€ ì •í™•íˆ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸)");
    spawnBurst(width*0.5, height*0.75, false);
    triggerShake(0.9);
  }

  inputEl.value="";
}
</script>

<!-- ===== Firebase ìµœê³ ì ìˆ˜ ì—°ë™ ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
    authDomain: "simulation-67cd3.firebaseapp.com",
    projectId: "simulation-67cd3",
    storageBucket: "simulation-67cd3.appspot.com",
    messagingSenderId: "615983461615",
    appId: "1:615983461615:web:002e07bcea878eb6d5571a",
    measurementId: "G-9RGN7LYE5W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const SIM_ID = "ê³µì‹_íƒ€ì´í•‘";
  let firebaseUser = null;

  async function saveBestScore(score) {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      await setDoc(ref, { score: Number(score) || 0 }, { merge: true });
    } catch (err) {
      console.error("[ê³µì‹ íƒ€ì´í•‘] ìµœê³  ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:", err);
    }
  }

  async function loadBestScore() {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const score = Number(data.score || 0) || 0;
        if (window.setBestScoreFromFirebase) window.setBestScoreFromFirebase(score);
      }
    } catch (err) {
      console.error("[ê³µì‹ íƒ€ì´í•‘] ìµœê³  ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
    }
  }

  window.saveBestScoreToFirebase = saveBestScore;

  onAuthStateChanged(auth, async (user) => {
    firebaseUser = user;
    if (user) await loadBestScore();
  });
</script>

</body>
</html>
