<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>ë¬¼ë¦¬ ê³µì‹ ì¹ íŒ ë°°í‹€</title>

<!-- p5.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

<style>
/* ì¹ íŒ ëŠë‚Œì˜ ì†ê¸€ì”¨ í°íŠ¸ ë¡œë“œ */
@import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Noto+Sans+KR:wght@400;700&display=swap');

:root{
  --chalk-white: #f3f4f6;
  --chalk-yellow: #fde047;
  --chalk-blue: #67e8f9;
  --chalk-red: #fca5a5;
  --chalk-green: #86efac;
  
  /* ìœ ë¦¬ ì§ˆê° (ë‹¤í¬) */
  --glass-bg: rgba(0, 0, 0, 0.45);
  --glass-border: rgba(255, 255, 255, 0.15);
  --shadow: 0 4px 20px rgba(0,0,0,0.5);
}

body {
  margin: 0; padding: 0;
  overflow: hidden;
  font-family: 'Gamja Flower', cursive; /* ë©”ì¸ í°íŠ¸ ë³€ê²½ */
  background-color: #2b3a33;
  color: var(--chalk-white);
  user-select: none;
}

canvas {
  display: block;
  position: absolute;
  top: 0; left: 0;
  z-index: 0;
}

/* UI ë ˆì´ì–´ */
#ui-layer {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 10;
  pointer-events: none;
  display: flex;
  justify-content: space-between;
  padding: 20px;
}

/* === ì¢Œì¸¡: ë­í‚¹ & ì ìˆ˜ === */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 240px;
  pointer-events: auto;
}

.score-card {
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  padding: 16px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  text-align: center;
}
.score-label { font-size: 1.2rem; color: #cbd5e1; opacity: 0.8; }
.score-val { 
  font-size: 3.5rem; 
  font-weight: bold; 
  color: var(--chalk-white);
  text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
  line-height: 1;
  margin: 4px 0;
}
.combo-text { font-size: 1.4rem; color: var(--chalk-yellow); animation: pulse 1s infinite; }

/* ë­í‚¹ ë³´ë“œ */
.rank-board {
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow);
  flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
  max-height: 400px;
  display: flex;
  flex-direction: column;
}
.rank-title {
  font-size: 1.5rem; border-bottom: 1px dashed rgba(255,255,255,0.3);
  padding-bottom: 8px; margin-bottom: 10px;
  display: flex; justify-content: space-between; align-items: center;
}
.rank-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex:1; }
.rank-item {
  display: flex; justify-content: space-between;
  padding: 6px 0;
  font-size: 1.2rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.rank-item.top1 { color: var(--chalk-yellow); font-weight: bold; }
.rank-item.me { color: var(--chalk-green); }
.rank-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ë‹‰ë„¤ì„ ì…ë ¥ */
.nick-input-box {
  margin-top: 10px;
  display: flex; gap: 6px;
}
#nickname {
  width: 100%;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  padding: 6px;
  border-radius: 4px;
  font-family: 'Gamja Flower', cursive;
  font-size: 1.1rem;
  outline: none;
}
#btn-save-nick {
  background: var(--chalk-blue);
  color: #1e293b;
  border: none;
  border-radius: 4px;
  padding: 0 10px;
  cursor: pointer;
  font-family: 'Gamja Flower', cursive;
  font-weight: bold;
}

/* === ìš°ì¸¡: ì •ë‹µí‘œ === */
.right-panel {
  width: 220px;
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow);
  overflow-y: auto;
  pointer-events: auto;
  height: fit-content;
  max-height: 80%;
}
.panel-head { font-size: 1.4rem; color: #e2e8f0; margin-bottom: 12px; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 6px; }
.answer-row {
  display: block;
  font-size: 1.15rem;
  padding: 4px 8px;
  margin-bottom: 4px;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  color: #cbd5e1;
}
.answer-row.highlight { color: var(--chalk-yellow); background: rgba(255,255,255,0.1); }

/* === í•˜ë‹¨: ì…ë ¥ì°½ === */
.bottom-area {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 640px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  pointer-events: auto;
}

/* ìƒíƒœ ë°°ì§€ */
.badges { display: flex; gap: 10px; margin-bottom: 4px; }
.badge {
  padding: 4px 12px; border-radius: 20px;
  background: #fff; color: #000;
  font-weight: bold; font-size: 1.1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  display: none; align-items: center; gap: 6px;
}
.bd-x2 { background: var(--chalk-yellow); color: #854d0e; }
.bd-fr { background: var(--chalk-blue); color: #164e63; }
.bd-sh { background: var(--chalk-green); color: #14532d; }

/* ë©”ì‹œì§€ ë°•ìŠ¤ */
#msg-box {
  font-size: 1.5rem;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  min-height: 1.6em;
  text-align: center;
}

/* ì…ë ¥ì°½ wrapper */
.input-container {
  position: relative;
  width: 100%;
  padding: 0 20px;
  box-sizing: border-box;
}

#ans {
  width: 100%;
  padding: 14px 24px;
  font-size: 1.8rem;
  font-family: 'Gamja Flower', cursive; /* ì…ë ¥ì°½ë„ ì†ê¸€ì”¨ í°íŠ¸ */
  border: 3px solid rgba(255,255,255,0.5);
  border-radius: 100px; /* ë‘¥ê·¼ ìº¡ìŠí˜• */
  background: rgba(40, 40, 40, 0.85);
  backdrop-filter: blur(10px);
  color: #fff;
  text-align: center;
  outline: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}
#ans::placeholder { color: rgba(255,255,255,0.4); font-size: 1.4rem; }
#ans:focus {
  border-color: var(--chalk-blue);
  background: rgba(50, 50, 50, 0.95);
  transform: scale(1.02);
  box-shadow: 0 15px 40px rgba(103, 232, 249, 0.2);
}

@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
@keyframes shake { 
  0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
}
.shake { animation: shake 0.3s ease-in-out; }

</style>
</head>
<body>

<div id="ui-layer">
  
  <!-- ì¢Œì¸¡ íŒ¨ë„: ì ìˆ˜ & ë­í‚¹ -->
  <div class="left-panel">
    <div class="score-card">
      <div class="score-label">í˜„ì¬ ì ìˆ˜</div>
      <div class="score-val" id="score">0</div>
      <div class="combo-text" id="combo-ui">0 COMBO</div>
    </div>
    
    <div class="rank-board">
      <div class="rank-title">
        <span>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span>
        <span style="font-size:0.9rem; opacity:0.7">Top 5</span>
      </div>
      <ul class="rank-list" id="rank-list">
        <li style="text-align:center; padding:20px; opacity:0.5">ë¡œë”©ì¤‘...</li>
      </ul>
      
      <div class="nick-input-box">
        <input id="nickname" maxlength="6" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 6ì)" />
        <button id="btn-save-nick">ë³€ê²½</button>
      </div>
    </div>
  </div>

  <!-- ìš°ì¸¡ íŒ¨ë„: ì»¤ë‹ í˜ì´í¼ -->
  <div class="right-panel">
    <div class="panel-head">ğŸ“˜ ì¡±ë³´ (ì •ë‹µ ëª©ë¡)</div>
    <div id="answers-container"></div>
  </div>

  <!-- í•˜ë‹¨: ì…ë ¥ ì˜ì—­ -->
  <div class="bottom-area">
    <div class="badges">
      <div class="badge bd-x2" id="bd-x2">âš¡ ì ìˆ˜ 2ë°°</div>
      <div class="badge bd-fr" id="bd-fr">â„ï¸ ì‹œê°„ ì •ì§€</div>
      <div class="badge bd-sh" id="bd-sh">ğŸ›¡ï¸ ë³´í˜¸ë§‰ ON</div>
    </div>
    <div id="msg-box">ê³µì‹ì´ ë–¨ì–´ì§€ë©´ ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”!</div>
    <div class="input-container">
      <input id="ans" type="text" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    </div>
  </div>

</div>

<script>
/* =========================================
   ê²Œì„ ë°ì´í„°
   ========================================= */
const FORMULAS = [
  {formula:"v = vâ‚€ + at",             answer:"ì†ë ¥ ê³µì‹",      diff:1},
  {formula:"x = xâ‚€ + vâ‚€t + Â½atÂ²",     answer:"ë“±ê°€ì†ë„ ê³µì‹",  diff:2},
  {formula:"F = ma",                  answer:"ë‰´í„´ ì œ2ë²•ì¹™",   diff:1},
  {formula:"p = mv",                  answer:"ìš´ë™ëŸ‰",        diff:1},
  {formula:"FÎ”t = Î”p",                answer:"ì¶©ê²©ëŸ‰",        diff:2},
  {formula:"W = Fd",                  answer:"ì¼",            diff:1},
  {formula:"K = Â½mvÂ²",                answer:"ìš´ë™ ì—ë„ˆì§€",    diff:1},
  {formula:"U = mgh",                 answer:"í¼í…ì…œ ì—ë„ˆì§€",  diff:2},
  {formula:"E = K + U",               answer:"ì—­í•™ì  ì—ë„ˆì§€",  diff:2},
  {formula:"a = vÂ² / r",              answer:"êµ¬ì‹¬ ê°€ì†ë„",    diff:2},
  {formula:"F = mvÂ² / r",             answer:"êµ¬ì‹¬ë ¥",        diff:2},
  {formula:"v = rÏ‰",                  answer:"ì„ ì†ë„",        diff:2},
  {formula:"Ï‰ = 2Ï€ / T",              answer:"ê°ì†ë„",        diff:2},
  {formula:"v = fÎ»",                  answer:"íŒŒë™ ì†ë ¥",     diff:1},
  {formula:"f = 1 / T",               answer:"ì§„ë™ìˆ˜",        diff:1},
  {formula:"y = A sin(Ï‰t)",           answer:"ë‹¨ìˆœ ì¡°í™” ìš´ë™", diff:3},
  {formula:"n = c / v",               answer:"êµ´ì ˆë¥ ",        diff:2},
  {formula:"nâ‚sinÎ¸â‚ = nâ‚‚sinÎ¸â‚‚",       answer:"ìŠ¤ë„¬ì˜ ë²•ì¹™",    diff:2},
  {formula:"sinÎ¸c = nâ‚‚ / nâ‚",         answer:"ì„ê³„ê°",        diff:3},
  {formula:"V = IR",                  answer:"ì˜´ì˜ ë²•ì¹™",      diff:1},
  {formula:"P = VI",                  answer:"ì „ë ¥",          diff:1},
  {formula:"Q = It",                  answer:"ì „í•˜ëŸ‰",        diff:1}
];

// âœ… ìˆ˜ì •: ì•„ì´í…œì— 'answer' ì†ì„± ì¶”ê°€ (í…ìŠ¤íŠ¸ë§Œ)
const ITEMS = [
  { type:"x2", title:"ì ìˆ˜ 2ë°°", answer:"ì ìˆ˜ 2ë°°", color:"#fde047", duration:10000 },
  { type:"freeze", title:"ì‹œê°„ ì •ì§€", answer:"ì‹œê°„ ì •ì§€", color:"#67e8f9", duration:5000 },
  { type:"shield", title:"ë³´í˜¸ë§‰", answer:"ë³´í˜¸ë§‰", color:"#86efac", duration:10000 }
];

/* =========================================
   ê²Œì„ ë³€ìˆ˜ & ìƒíƒœ
   ========================================= */
let drops = [];
let particles = [];
let score = 0;
let combo = 0;
let lastSpawnTime = 0;
let shakeTime = 0; // í™”ë©´ í”ë“¤ë¦¼ íƒ€ì´ë¨¸

// íš¨ê³¼ ìƒíƒœ (ë§Œë£Œ ì‹œê°„ millis)
let effectUntil = { x2:0, freeze:0, shield:0 };
let shieldCount = 0;

// ë‚œì´ë„ ì¡°ì ˆ
let speedMultiplier = 1.0;
let spawnRate = 2000;

/* =========================================
   P5.js ì‹œê°í™” (ì¹ íŒ & ì´í™íŠ¸)
   ========================================= */

function setup(){
  createCanvas(windowWidth, windowHeight);
  // ë…¸ì´ì¦ˆ ì§ˆê°ì„ ë¯¸ë¦¬ ìƒì„±í•  ìˆ˜ë„ ìˆì§€ë§Œ, drawì—ì„œ ê°„ë‹¨íˆ ì²˜ë¦¬
  
  // ì…ë ¥ì°½ ì´ë²¤íŠ¸ ì—°ê²°
  const inp = document.getElementById("ans");
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") checkAnswer();
  });
  
  // âœ… í™”ë©´ í´ë¦­ ì‹œ ì…ë ¥ì°½ìœ¼ë¡œ í¬ì»¤ìŠ¤ ë³µê·€ (ì‚¬ìš©ì í¸ì˜)
  document.body.addEventListener("click", (e)=>{
    // ë²„íŠ¼, ì…ë ¥ì°½ ë“±ì„ í´ë¦­í•œê²Œ ì•„ë‹ˆë¼ë©´ í¬ì»¤ìŠ¤
    if(e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT"){
      inp.focus();
    }
  });
  
  inp.focus();
  
  // ì •ë‹µí‘œ ì±„ìš°ê¸°
  const ansCon = document.getElementById("answers-container");
  FORMULAS.sort((a,b)=>a.answer.localeCompare(b.answer)).forEach(f=>{
    const d = document.createElement("div");
    d.className = "answer-row";
    d.textContent = f.answer;
    ansCon.appendChild(d);
  });
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
}

function draw(){
  // 1. ë°°ê²½ ê·¸ë¦¬ê¸° (ë¦¬ì–¼ ì¹ íŒ)
  drawBlackboard();
  
  // 2. í™”ë©´ í”ë“¤ë¦¼ ì ìš©
  if(shakeTime > 0){
    const mag = map(shakeTime, 0, 15, 0, 6);
    translate(random(-mag, mag), random(-mag, mag));
    shakeTime--;
  }

  const now = millis();
  
  // 3. ìŠ¤í° ë¡œì§ & ë‚œì´ë„ ì¡°ì ˆ ìˆ˜ì •
  // ì´ˆê¸° ì†ë„ë¥¼ 0.5ë°°ë¡œ ëŒ€í­ ë‚®ì¶¤.
  // ì ìˆ˜ê°€ 5000ì ì— ë„ë‹¬í•´ì•¼ ê¸°ì¡´ì˜ ê¸°ë³¸ ì†ë„(1.0 + ì•ŒíŒŒ) ìˆ˜ì¤€ì¸ ì•½ 1.3ë°°ê°€ ë˜ë„ë¡ ì„¤ì • (ìƒí•œì„  ì ìš©)
  speedMultiplier = 0.5 + Math.min(0.8, score / 5000); 
  
  // ìŠ¤í° ì£¼ê¸°: ì´ˆê¸° 2.5ì´ˆ -> ìµœì†Œ 1ì´ˆ (ì ì°¨ ë¹¨ë¼ì§)
  spawnRate = Math.max(1000, 2500 - (score/3));

  if(now > effectUntil.freeze){
    if(now - lastSpawnTime > spawnRate){
      spawnDrop();
      lastSpawnTime = now;
    }
  }

  // 4. ë“œë¡­(ê³µì‹) ì—…ë°ì´íŠ¸ & ê·¸ë¦¬ê¸°
  const deadZone = height - 100; // ë°”ë‹¥ ê¸°ì¤€
  
  for(let i=drops.length-1; i>=0; i--){
    let d = drops[i];
    
    // ì´ë™ (Freeze ìƒíƒœë©´ ë©ˆì¶¤)
    if(now > effectUntil.freeze){
      d.y += d.speed * speedMultiplier * (deltaTime/16);
    }
    
    drawDrop(d);
    
    // ë°”ë‹¥ ë‹¿ìŒ ì²˜ë¦¬
    if(d.y > deadZone){
      if(d.isItem){
        // ì•„ì´í…œì€ ê·¸ëƒ¥ ì‚¬ë¼ì§
        uiMsg("bad", "ì•„ì´í…œì„ ë†“ì³¤ì–´ìš” ã… ã… ");
      } else {
        // ê³µì‹ ë†“ì¹¨
        if(shieldCount > 0 && now < effectUntil.shield){
          shieldCount--;
          uiMsg("good", "ğŸ›¡ï¸ ë³´í˜¸ë§‰ì´ ë°©ì–´í–ˆìŠµë‹ˆë‹¤!");
          spawnParticles(d.x, deadZone, 10, "#86efac"); // ì´ˆë¡ íŒŒí‹°í´
        } else {
          // ë°ë¯¸ì§€
          score = Math.max(0, score - 20);
          combo = 0;
          shakeTime = 15; // í™”ë©´ í”ë“¤ë¦¼
          uiMsg("bad", `ë†“ì³¤ìŠµë‹ˆë‹¤! ì •ë‹µ: ${d.answer}`);
          spawnParticles(d.x, deadZone, 20, "#fca5a5"); // ë¹¨ê°• íŒŒí‹°í´
        }
      }
      drops.splice(i, 1);
      updateUI();
    }
  }

  // 5. íŒŒí‹°í´ ì´í™íŠ¸
  for(let i=particles.length-1; i>=0; i--){
    let p = particles[i];
    p.life -= 2;
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1; // ì¤‘ë ¥
    
    noStroke();
    fill(p.r, p.g, p.b, p.life * 2.5);
    circle(p.x, p.y, p.size);
    
    if(p.life <= 0) particles.splice(i,1);
  }

  // 6. UI ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œê°„ì œí•œ ì•„ì´í…œ ë“±)
  updateBadgeUI(now);
}

// === ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜ ===

function drawBlackboard(){
  // ê¸°ë³¸ ë…¹ìƒ‰ ë°°ê²½
  background(43, 66, 56);
  
  // ë…¸ì´ì¦ˆ í…ìŠ¤ì²˜ (ë¶„í•„ ê°€ë£¨ ëŠë‚Œ)
  loadPixels();
  // ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ë§¤ í”„ë ˆì„ ì „ì²´ í”½ì…€ ì¡°ì‘ì€ ë¬´ê±°ì›€.
  // ëŒ€ì‹  ë°˜íˆ¬ëª…í•œ ë…¸ì´ì¦ˆ ì´ë¯¸ì§€ë¥¼ ë®ê±°ë‚˜, ê°„ë‹¨í•œ ê·¸ë¼ë°ì´ì…˜ ì‚¬ìš©.
  // ì—¬ê¸°ì„œëŠ” p5 ê·¸ë¦¬ê¸° í•¨ìˆ˜ë¡œ 'ì§€ìš°ê°œ ìêµ­' ëŠë‚Œë§Œ ëƒ„.
  
  noStroke();
  fill(255, 255, 255, 15); // í¬ë¯¸í•œ í•˜ì–€ìƒ‰
  
  // ê±°ì¹œ ì§€ìš°ê°œ ìêµ­ ëª‡ ê°œ
  ellipse(width*0.2, height*0.3, 400, 200);
  ellipse(width*0.7, height*0.6, 500, 300);
  
  // ë¹„ë„¤íŒ… (ê°€ì¥ìë¦¬ ì–´ë‘¡ê²Œ)
  strokeWeight(60);
  stroke(20, 30, 25, 100); // ë°˜íˆ¬ëª… ê²€ì • í…Œë‘ë¦¬
  noFill();
  rect(0,0,width,height);
  noStroke();
}

function drawDrop(d){
  push();
  translate(d.x, d.y);
  
  // ì¤‘ì•™ ê¸°ì¤€ ë“œë¡œì‰ ì„¤ì • (ì•„ì´í…œ í…ìŠ¤íŠ¸ ì •ë ¬ í•´ê²°)
  rectMode(CENTER);

  // ê·¸ë¦¼ì
  fill(0,0,0,50);
  noStroke();
  rect(3, 3, d.w, d.h, 6);
  
  // ë³¸ì²´
  if(d.isItem){
    // ì•„ì´í…œ: ìƒ‰ìƒìˆëŠ” ì¹´ë“œ
    stroke(255);
    strokeWeight(1);
    fill(d.color);
    rect(0, 0, d.w, d.h, 6);
    
    fill(50);
    textAlign(CENTER, CENTER);
    textSize(20);
    // í™”ë©´ í‘œì‹œì—ëŠ” ì´ëª¨ì§€ í¬í•¨ (ì‹œê°ì  ì¬ë¯¸), ë‹µì•ˆ ì¸ì‹ì€ answer ì†ì„±(í…ìŠ¤íŠ¸) ì‚¬ìš©
    text(`ğŸ ${d.title}`, 0, 0);
    
  } else {
    // ê³µì‹: ë–¨ë¦¼ ì œê±°í•˜ê³  ì•ˆì •ì ì¸ ì‚¬ê°í˜• ì‚¬ìš©
    stroke(255, 255, 255, 200);
    strokeWeight(2);
    noFill();
    
    // ê¸°ì¡´ì˜ random vertex ì½”ë“œë¥¼ ì œê±°í•˜ê³  ì‚¬ê°í˜•ìœ¼ë¡œ ë³€ê²½
    rect(0, 0, d.w, d.h, 6);
    
    // ë‚´ìš©
    noStroke();
    fill(255);
    textAlign(CENTER, CENTER);
    textSize(24);
    // ê³µì‹
    text(d.formula, 0, -5);
    // ë‚œì´ë„ í‘œì‹œ (ì•„ë˜ ì )
    fill(255, 255, 255, 150);
    let dots = "â€¢".repeat(d.diff);
    textSize(14);
    text(dots, 0, 18);
  }
  pop();
}

function spawnDrop(){
  const isItem = random() < 0.1; // 10% í™•ë¥ 
  
  // [ìˆ˜ì •] ì¢Œì¸¡ íŒ¨ë„(240px + 20px íŒ¨ë”©)ê³¼ ìš°ì¸¡ íŒ¨ë„(220px + 20px íŒ¨ë”©)ì„ í™•ì‹¤íˆ í”¼í•˜ê¸° ìœ„í•´ ì•ˆì „ êµ¬ì—­ ì„¤ì •
  let safeLeft = 320;
  let safeRight = width - 300;

  // ë§Œì•½ í™”ë©´ì´ ë„ˆë¬´ ì¢ì•„ì„œ(ëª¨ë°”ì¼ ë“±) ì•ˆì „ êµ¬ì—­ì´ ê¼¬ì´ë©´ ì¤‘ì•™ìœ¼ë¡œ ê°•ì œ
  if(safeLeft >= safeRight){
    safeLeft = width/2 - 20;
    safeRight = width/2 + 20;
  }
  
  const spawnX = random(safeLeft, safeRight);
  
  if(isItem){
    const item = random(ITEMS);
    drops.push({
      isItem: true,
      ...item,
      x: spawnX,
      y: -50,
      w: 160, h: 50,
      speed: 1.5,
      color: item.color
    });
  } else {
    const f = random(FORMULAS);
    drops.push({
      isItem: false,
      ...f,
      x: spawnX,
      y: -50,
      w: textWidth(f.formula)*1.2 + 60, 
      h: 60,
      speed: 1.0 + (f.diff * 0.2) // ê¸°ë³¸ ì†ë„ ê³„ìˆ˜
    });
  }
}

function spawnParticles(x, y, count, colorHex){
  const c = color(colorHex);
  for(let i=0; i<count; i++){
    particles.push({
      x: x, y: y,
      vx: random(-3, 3),
      vy: random(-4, 1),
      life: 100, // frame
      size: random(3, 8),
      r: red(c), g: green(c), b: blue(c)
    });
  }
}

/* =========================================
   ê²Œì„ ë¡œì§
   ========================================= */

function checkAnswer(){
  const inp = document.getElementById("ans");
  const rawVal = inp.value.trim();
  if(!rawVal) return;
  
  // ë„ì–´ì“°ê¸° ë¬´ì‹œë¥¼ ìœ„í•´ ê³µë°± ì œê±° í›„ ë¹„êµ
  const val = rawVal.replace(/\s+/g, "");

  // ê°€ì¥ ì•„ë˜(yê°€ í°) ë…€ì„ë¶€í„° ë§¤ì¹­
  let hitIdx = -1;
  let maxY = -9999;
  
  for(let i=0; i<drops.length; i++){
    // âœ… ì•ˆì „ ì¥ì¹˜: ì •ë‹µ ì†ì„±ì´ ì—†ëŠ” ê²½ìš° ê±´ë„ˆë›°ê¸° (ì—ëŸ¬ ë°©ì§€)
    if(!drops[i].answer) continue;

    const dropAns = drops[i].answer.replace(/\s+/g, ""); // ì •ë‹µë„ ê³µë°± ì œê±°í•˜ê³  ë¹„êµ
    if(dropAns === val && drops[i].y > maxY){
      maxY = drops[i].y;
      hitIdx = i;
    }
  }
  
  if(hitIdx !== -1){
    // ì •ë‹µ!
    const d = drops[hitIdx];
    drops.splice(hitIdx, 1);
    
    if(d.isItem){
      applyItem(d);
      uiMsg("good", `ì•„ì´í…œ íšë“: ${d.title}`);
      spawnParticles(d.x, d.y, 15, d.color);
    } else {
      combo++;
      let bonus = Math.min(20, (combo-1)*5);
      let add = 20 + bonus;
      if(millis() < effectUntil.x2) add *= 2;
      
      score += add;
      uiMsg("good", `ì •ë‹µ! +${add}`);
      spawnParticles(d.x, d.y, 25, "#f3f4f6"); // í•˜ì–€ ë¶„í•„ê°€ë£¨
      
      // ìµœê³ ì ìˆ˜ ì²´í¬
      checkBestScore();
    }
    
  } else {
    // ì˜¤ë‹µ
    combo = 0;
    score = Math.max(0, score - 10);
    shakeTime = 10;
    uiMsg("bad", "í‹€ë ¸ìŠµë‹ˆë‹¤!");
    
    // ì…ë ¥ì°½ í”ë“¤ë¦¼ CSS
    const el = document.querySelector(".input-container");
    el.classList.remove("shake");
    void el.offsetWidth;
    el.classList.add("shake");
  }
  
  inp.value = "";
  updateUI();
}

function applyItem(item){
  const now = millis();
  if(item.type === "x2") effectUntil.x2 = now + item.duration;
  if(item.type === "freeze") effectUntil.freeze = now + item.duration;
  if(item.type === "shield") {
    effectUntil.shield = now + item.duration;
    shieldCount = 1;
  }
}

function updateUI(){
  document.getElementById("score").textContent = score;
  document.getElementById("combo-ui").textContent = combo > 1 ? `${combo} COMBO!` : "";
  document.getElementById("combo-ui").style.opacity = combo > 1 ? 1 : 0;
}

function updateBadgeUI(now){
  document.getElementById("bd-x2").style.display = (now < effectUntil.x2) ? "flex" : "none";
  document.getElementById("bd-fr").style.display = (now < effectUntil.freeze) ? "flex" : "none";
  const shEl = document.getElementById("bd-sh");
  if(shieldCount > 0 && now < effectUntil.shield){
    shEl.style.display = "flex";
    shEl.textContent = `ğŸ›¡ï¸ ë³´í˜¸ë§‰ (${shieldCount})`;
  } else {
    shEl.style.display = "none";
  }
}

function uiMsg(type, text){
  const box = document.getElementById("msg-box");
  box.textContent = text;
  box.style.color = type === "good" ? "var(--chalk-green)" : "var(--chalk-red)";
  box.style.transform = "scale(1.2)";
  setTimeout(()=> box.style.transform = "scale(1)", 200);
}

/* =========================================
   Firebase ë­í‚¹ ì‹œìŠ¤í…œ
   ========================================= */
let myBestScore = 0;
let myNickname = "í•™ìƒ" + Math.floor(Math.random()*1000);

// ë¡œì»¬ ìµœê³ ì ìˆ˜ ì²´í¬ & ì„œë²„ ì €ì¥ ì‹œë„
function checkBestScore(){
  if(score > myBestScore){
    myBestScore = score;
    // Firebase ì €ì¥
    if(window.saveScoreToFirestore) window.saveScoreToFirestore(myNickname, myBestScore);
  }
}

// ë‹‰ë„¤ì„ ë³€ê²½
document.getElementById("btn-save-nick").addEventListener("click", ()=>{
  const val = document.getElementById("nickname").value.trim();
  if(val) {
    myNickname = val;
    uiMsg("good", `ë‹‰ë„¤ì„ ë³€ê²½: ${val}`);
    // ë‹‰ë„¤ì„ ë°”ê¾¸ë©´ í˜„ì¬ ìµœê³ ê¸°ë¡ìœ¼ë¡œ ë‹¤ì‹œ ì—…ë°ì´íŠ¸ (ì´ë¦„ ê°±ì‹ ìš©)
    if(myBestScore > 0 && window.saveScoreToFirestore) {
      window.saveScoreToFirestore(myNickname, myBestScore);
    }
  }
});

// ì™¸ë¶€ì—ì„œ ë­í‚¹ ë¦¬ìŠ¤íŠ¸ UI ì—…ë°ì´íŠ¸
window.updateRankingBoard = function(rankData) {
  const list = document.getElementById("rank-list");
  list.innerHTML = "";
  
  if(!rankData || rankData.length === 0){
    list.innerHTML = "<li style='padding:10px; opacity:0.6'>ê¸°ë¡ ì—†ìŒ</li>";
    return;
  }
  
  rankData.forEach((item, index) => {
    const li = document.createElement("li");
    li.className = "rank-item";
    if(index === 0) li.classList.add("top1");
    // ë‚´ ê¸°ë¡ì¸ì§€ í™•ì¸ (ê°„ë‹¨íˆ ì´ë¦„ìœ¼ë¡œ ë¹„êµí•˜ê±°ë‚˜, uid ë¹„êµê°€ ì •í™•í•˜ì§€ë§Œ ì—¬ê¸°ì„  ì‹œê°ì  ì²˜ë¦¬ë§Œ)
    if(item.name === myNickname) li.classList.add("me");
    
    li.innerHTML = `
      <span class="rank-name">${index+1}. ${item.name}</span>
      <span>${item.score}</span>
    `;
    list.appendChild(li);
  });
  
  // ë‚´ ìµœê³ ì ìˆ˜ í•­ëª© ì¶”ê°€ (ë­í‚¹ì— ì—†ìœ¼ë©´ í•˜ë‹¨ì— í‘œê¸°)
  // (ìƒëµ: ìœ„ ë¦¬ìŠ¤íŠ¸ê°€ Top 5ì´ë¯€ë¡œ, ê³µê°„ ë¶€ì¡±ì‹œ ìƒëµí•˜ê±°ë‚˜ ë³„ë„ í‘œê¸°)
};

</script>

<!-- ===== Firebase Module: ë­í‚¹ ì‹œìŠ¤í…œ ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  // 1. ì„¤ì •
  const firebaseConfig = JSON.parse(
    '{"apiKey":"AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w","authDomain":"simulation-67cd3.firebaseapp.com","projectId":"simulation-67cd3","storageBucket":"simulation-67cd3.appspot.com","messagingSenderId":"615983461615","appId":"1:615983461615:web:002e07bcea878eb6d5571a"}'
  );
  const appId = "default-app-id"; // ì „ì—­ ë³€ìˆ˜ __app_idê°€ ì—†ëŠ” ê²½ìš° ëŒ€ë¹„

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // 2. ì¸ì¦
  async function initAuth() {
    try {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    } catch (e) {
      console.error("ì¸ì¦ ì‹¤íŒ¨:", e);
    }
  }
  initAuth();

  // 3. ì ìˆ˜ ì €ì¥ í•¨ìˆ˜ (ì „ì—­ ë…¸ì¶œ)
  window.saveScoreToFirestore = async function(nickname, score) {
    if(!currentUser) return;
    
    // Public Leaderboardì— ì €ì¥
    // Path: artifacts/{appId}/public/data/leaderboard/{uid}
    // Rule 1 ì¤€ìˆ˜
    const leaderboardRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', currentUser.uid);
    
    try {
      await setDoc(leaderboardRef, {
        name: nickname,
        score: score,
        uid: currentUser.uid,
        updatedAt: Date.now()
      });
      console.log("ë­í‚¹ ì €ì¥ ì™„ë£Œ");
    } catch(e) {
      console.error("ë­í‚¹ ì €ì¥ ì‹¤íŒ¨", e);
    }
  };

  // 4. ë­í‚¹ ë¦¬ìŠ¤ë„ˆ (ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸)
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if(user){
      // ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
      // Rule 2: No complex queries. Just fetch collection or simple orderBy if possible.
      // ì—¬ê¸°ì„œëŠ” 'leaderboard' ì»¬ë ‰ì…˜ì„ êµ¬ë…. (ë°ì´í„°ê°€ ì•„ì£¼ ë§ìœ¼ë©´ limit í•„ìˆ˜ì§€ë§Œ, Rule 2 ì œì•½ ì•ˆì—ì„œ í•´ê²°)
      // *ì£¼ì˜: artifacts ê²½ë¡œ ì‚¬ìš©
      const lbCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
      
      // onSnapshotìœ¼ë¡œ ì‹¤ì‹œê°„ ìˆ˜ì‹ 
      onSnapshot(lbCol, (snapshot) => {
        let allScores = [];
        snapshot.forEach(doc => {
          allScores.push(doc.data());
        });
        
        // JSì—ì„œ ì •ë ¬ (Rule 2: Fetch all -> Sort in memory)
        allScores.sort((a,b) => b.score - a.score);
        
        // Top 5 ìë¥´ê¸°
        const top5 = allScores.slice(0, 5);
        
        // UI ì—…ë°ì´íŠ¸
        if(window.updateRankingBoard) window.updateRankingBoard(top5);
      }, (error) => {
        console.error("ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜", error);
      });
    }
  });

</script>

</body>
</html>