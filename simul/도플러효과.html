<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë„í”ŒëŸ¬ íš¨ê³¼ </title>
  <style>
    :root{
      --bg:#f7fbff; --panel:#ffffff; --ink:#0f172a; --muted:#5b657a; --accent:#2563eb; --good:#10b981; --warn:#f59e0b; --border:#e6eef9; --radius:18px; --shadow:0 10px 30px rgba(15,23,42,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:radial-gradient(1200px 800px at 10% -10%, #eef6ff, #f7fbff);
      color:var(--ink);
      font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial
    }
    header{padding:20px}
    header h1{margin:0 0 6px;font-size:clamp(22px,2.6vw,30px)}
    header p{margin:4px 0 0;color:var(--muted)}
    .wrap{
      display:grid;
      grid-template-columns:380px 1fr;
      gap:16px;
      padding:0 20px 20px
    }
/* â˜… ìˆ˜ì •: í™”ë©´ì´ ì¢ì„ ë•Œ ì‹œë®¬ë ˆì´ì…˜ì´ ìœ„ë¡œ ê°€ë„ë¡ ìˆœì„œ ë³€ê²½ â˜… */
    @media (max-width:1020px){
      .wrap {
        display: flex;
        flex-direction: column;
      }
      .viz { order: 1; }      /* ì‹œë®¬ë ˆì´ì…˜ ì¹´ë“œ ìœ„ë¡œ */
      .controls { order: 2; } /* ì¡°ì‘ íŒ¨ë„ ì•„ë˜ë¡œ */
    }

    /* â˜… ì¶”ê°€: ìº”ë²„ìŠ¤ê°€ í•´ìƒë„ëŠ” ìœ ì§€í•˜ë˜ í™”ë©´ì— ë§ì¶° ì¤„ì–´ë“¤ë„ë¡ ì„¤ì • â˜… */
    canvas {
      display: block;
      width: 100%;
      height: auto; /* ë†’ì´ ìë™ ì¡°ì ˆ (ë¹„ìœ¨ ìœ ì§€) */
      background: linear-gradient(180deg,#ffffff,#f8fbff);
    }    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow)
    }
    .controls{
      padding:14px;
      display:grid;
      gap:10px
    }
    .viz{
      padding:12px;
      display:grid;
      gap:10px;
      align-content:start;
    }
    .group{
      background:#fff;
      border:1px dashed var(--border);
      border-radius:14px;
      padding:12px
    }
    .group h3{margin:0 0 8px;font-size:15px}
    .row{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      margin:6px 0
    }
    .row label{color:var(--muted);font-size:13px}
    .row output{font-variant-numeric:tabular-nums;font-size:13px}
    input[type=range]{
      width:100%;
      appearance:none;
      height:6px;
      background:#e7eef9;
      border-radius:999px
    }
    input[type=range]::-webkit-slider-thumb{
      appearance:none;
      width:18px;height:18px;
      border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(37,99,235,.2)
    }
    input[type=range]::-moz-range-thumb{
      width:18px;height:18px;
      border-radius:50%;
      background:var(--accent)
    }
    .canvasBox{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden
    }
    canvas{display:block;width:100%;background:linear-gradient(180deg,#ffffff,#f8fbff)}
    .chip{
      display:inline-block;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      cursor:pointer;
      margin-right:6px
    }
    .chip:hover{filter:brightness(1.02)}
    .legend{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-size:12px
    }
    .dot{width:10px;height:10px;border-radius:50%}
    footer{text-align:center;color:#111827;padding:18px 12px}
    .brand{
      font-weight:800;
      letter-spacing:.08em;
      border:2px solid #111827;
      border-radius:999px;
      padding:8px 14px;
      display:inline-block
    }
    /* ì‹œë®¬ë ˆì´ì…˜ ì¹´ë“œ ì•ˆì— ë“¤ì–´ê°€ëŠ” ë„ì „ ëª¨ë“œ ì „ìš© ìŠ¤íƒ€ì¼ */
    #challengeGroup{
      margin-top:4px;
    }
 .bestScoreBox {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 16px;
  font-weight: 600;
}

.bestLabel {
  color: #374151; /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ê³¼ ì¡°í™”ë˜ë„ë¡ */
}

.bestIcon {
  font-size: 18px;
  filter: drop-shadow(0 0 4px rgba(255, 200, 0, 0.7));
}

.bestValue {
  font-size: 20px;
  font-weight: 700;
  color: #ffb300;
  text-shadow: 0 0 6px rgba(255, 190, 0, 0.8);
}

/* ===== ëª¨ë°”ì¼: ìƒë‹¨ ê³ ì • + í•˜ë‹¨ ìŠ¤í¬ë¡¤ ë ˆì´ì•„ì›ƒ ===== */
    @media (max-width: 1020px) {
      /* 1. ì‹œë®¬ë ˆì´ì…˜ í™”ë©´ì„ ìƒë‹¨ì— ê³ ì • */
      .canvasBox {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 40vh; /* í™”ë©´ ë†’ì´ì˜ 40% ì°¨ì§€ */
        z-index: 100;
        border-radius: 0;
        border: none;
        border-bottom: 2px solid #dbeafe;
      }
      
      /* ìº”ë²„ìŠ¤ê°€ ë°•ìŠ¤ ì•ˆì— ê½‰ ì°¨ë„ë¡ ê°•ì œ */
      canvas { width: 100% !important; height: 100% !important; }

      /* 2. ë‚˜ë¨¸ì§€ íŒ¨ë„ë“¤ì´ ìº”ë²„ìŠ¤ ì•„ë˜ì—ì„œ ì‹œì‘ë˜ë„ë¡ ë°€ê¸° */
      .wrap {
        display: flex;
        flex-direction: column;
        margin-top: 40vh; /* ìº”ë²„ìŠ¤ ë†’ì´ë§Œí¼ ì—¬ë°± í™•ë³´ */
        padding: 10px;
        gap: 10px;
      }

      /* 3. íŒ¨ë„ ìˆœì„œ ë³€ê²½ (ê²Œì„ ì ìˆ˜íŒ -> ì¡°ì‘ ìŠ¬ë¼ì´ë” ìˆœì„œ) */
      .viz { 
        order: 1; 
        padding: 0; border: none; background: transparent; box-shadow: none; 
      }
      .controls { 
        order: 2; 
        padding-bottom: 60px; /* ë§¨ ì•„ë˜ ì—¬ë°± */
      }

      /* 4. ê³µê°„ í™•ë³´ë¥¼ ìœ„í•´ í—¤ë”/í‘¸í„° ìˆ¨ê¹€ */
      header, footer { display: none; }
    }

  </style>
</head>
<body>
  <header>
    <h1>ë„í”ŒëŸ¬ íš¨ê³¼ ì‹œë®¬ë ˆì´í„°</h1>
    <p>ì†ë„ë¥¼ 0ìœ¼ë¡œ ë‘ë©´ ìŒì› ì¤‘ì‹¬ì˜ <strong>ë™ì‹¬ì› íŒŒë©´</strong>ì´, ì†ë„ë¥¼ ì£¼ë©´ <strong>ì´ë™í•˜ëŠ” ì›í˜• íŒŒë©´</strong>ê³¼ <em>ì••ì¶•/íŒ½ì°½ëœ íŒŒì¥</em>ì´ ë³´ì…ë‹ˆë‹¤. (ì´ˆìŒì†ì´ë©´ <strong>ë§ˆí•˜ ì½˜</strong>ë„ í‘œì‹œ)</p>
  </header>

  <div class="wrap">
    <!-- Controls -->
    <section class="card controls">
      <div class="group">
        <h3>ì„¤ì •</h3>
        <div class="row"><label>ìŒì† <em>v</em> (m/s)</label><output id="out_c">â€”</output></div>
        <input id="c" type="range" min="200" max="380" step="1" value="340" />
        <div class="row"><label>ìŒì› ì†ë„ <em>v<sub>s</sub></em> (m/s)</label><output id="out_vs">â€”</output></div>
        <input id="vs" type="range" min="-600" max="600" step="1" value="0" />
        <div class="row"><label>ì£¼íŒŒìˆ˜ <em>f</em> (Hz)</label><output id="out_f">â€”</output></div>
        <input id="f" type="range" min="0.5" max="10" step="0.1" value="2" />
        <div class="row"><label>ì‹œê°„ ë°°ì†</label><output id="out_speed">â€”</output></div>
        <input id="timescale" type="range" min="0.2" max="3" step="0.1" value="1" />
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <label style="font-size:13px;color:var(--muted)"><input id="showMach" type="checkbox" checked> ë§ˆí•˜ ì½˜ í‘œì‹œ(ì´ˆìŒì†ì—ì„œ)</label>
          <label style="font-size:13px;color:var(--muted)"><input id="showLambda" type="checkbox" checked> ì•/ë’¤ íŒŒì¥ í‘œì‹œ</label>
        </div>
      </div>
      <div class="group">
        <h3>ë¹ ë¥¸ ì˜ˆì‹œ</h3>
        <div>
          <button class="chip" data-vs="0">ì •ì§€(0 m/s)</button>
          <button class="chip" data-vs="120">ì €ì†(+)</button>
          <button class="chip" data-vs="320">ì¤€ìŒì†(+)</button>
          <button class="chip" data-vs="500">ì´ˆìŒì†(+)</button>
          <button class="chip" data-vs="-300">ë°˜ëŒ€ë°©í–¥(âˆ’)</button>
        </div>
      </div>
      <div class="group legend">
        <div class="dot" style="background:#ef4444"></div> ìŒì›(ğŸš—)
        <div class="dot" style="background:#60a5fa"></div> íŒŒë©´(ë™ì‹¬ì›)
        <div class="dot" style="background:#10b981"></div> ê´€ì°°ì
      </div>

      <!-- Theory / Formula box -->
      <div class="group" style="background:#fdfcff;border:1px solid var(--border);border-radius:14px;padding:10px 12px;margin:6px 0 8px;">
        <div style="font-weight:600;margin-bottom:6px">ì´ë¡  Â· ê³µì‹</div>
        <div class="eq">íŒŒì¥: <span style="white-space:nowrap">Î» = v / f</span></div>
        <div class="eq" style="margin-top:4px">
          ì •ì§€ ê´€ì¸¡ì, ì´ë™ ìŒì›(1ì°¨ì›): 
          ì•ìª½&nbsp;fâ€²<sub>front</sub> = <span style="white-space:nowrap">v/(vâˆ’v<sub>s</sub>)</span>Â·f,&nbsp; 
          ë’¤ìª½&nbsp;fâ€²<sub>back</sub> = <span style="white-space:nowrap">v/(v+v<sub>s</sub>)</span>Â·f
        </div>
        <div class="eq" style="margin-top:4px;color:#5b657a">
          ì¼ë°˜ì‹(ê´€ì¸¡ì ì†ë„ v<sub>o</sub> í¬í•¨): 
          <span style="white-space:nowrap">fâ€² = ((v Â± v<sub>o</sub>)/(v âˆ“ v<sub>s</sub>))Â·f</span>
          <small style="color:#94a3b8"> (Â±ëŠ” ì ‘ê·¼/ì´íƒˆ ë¶€í˜¸ ê·œì•½)</small>
        </div>
        <div style="margin-top:6px;font-size:13px;color:#374151">
          ì§€ê¸ˆ ê´€ì¸¡ì ìœ„ì¹˜ì—ì„œ: 
          fâ€²<sub>obs</sub> = <b><span id="fObs">â€”</span> Hz</b>, 
          Î»â€²<sub>obs</sub> = <b><span id="lObs">â€”</span> m</b>
        </div>
      </div>
    </section>

    <!-- Viz: ì‹œë®¬ë ˆì´ì…˜ + ë„ì „ ëª¨ë“œê°€ í•œ ì¹´ë“œ ì•ˆì— -->
    <section class="card viz">
      <div class="canvasBox">
        <canvas id="canvas" height="420"></canvas>
      </div>

      <!-- ì‹œë®¬ë ˆì´ì…˜ ì¹´ë“œ ì•ˆì— ë“¤ì–´ê°€ëŠ” ë„ì „ ëª¨ë“œ -->
      <div class="group" id="challengeGroup">
        <h3>ë„ì „ ëª¨ë“œ</h3>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
          <button id="btnChallenge" class="chip">ë„í”ŒëŸ¬ ë„ì „ ì‹œì‘</button>
          <div style="font-size:12px;color:var(--muted);">ì´ 10ë¼ìš´ë“œ Â· ì •ë‹µë‹¹ 50ì </div>
        </div>
        <div style="display:flex;gap:10px;font-size:13px;margin-bottom:4px;flex-wrap:wrap;">
          <div>ë¼ìš´ë“œ: <strong><span id="gpRound">-</span> / 10</strong></div>
          <div>ì ìˆ˜: <strong><span id="gpScore">0</span>ì </strong></div>
<div class="bestScoreBox">
  <span class="bestLabel">ìµœê³ ì ìˆ˜</span>
  <span class="bestIcon">ğŸ†</span>
  <span id="gpBest" class="bestValue">0</span>
</div>
        </div>

        <!-- 1~5ë‹¨ê³„: ê°œë… ë¬¸ì œ -->
        <div id="phase1Box" style="margin-top:4px;display:none;font-size:13px;">
          <div style="margin-bottom:4px;">
            [1â€“5ë‹¨ê³„] ì£¼ì–´ì§„ ìŒì› ì†ë„(v<sub>s</sub>)ì™€ ì£¼íŒŒìˆ˜(f)ë¥¼ ë³´ê³ ,<br>
            ê´€ì°° ì£¼íŒŒìˆ˜ê°€ <strong>ì¦ê°€ / ê°ì†Œ / ì†Œë‹‰ë¶</strong> ì¤‘ ë¬´ì—‡ì¸ì§€ ê³ ë¥´ì„¸ìš”.
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;">
            <button class="chip" id="btnAnsUp">ì£¼íŒŒìˆ˜ ì¦ê°€</button>
            <button class="chip" id="btnAnsDown">ì£¼íŒŒìˆ˜ ê°ì†Œ</button>
            <button class="chip" id="btnAnsBoom">ì†Œë‹‰ë¶(ë§ˆí•˜ ì½˜)</button>
          </div>
        </div>

        <!-- 6~10ë‹¨ê³„: ìˆ˜ì¹˜ ë§ì¶”ê¸° -->
        <div id="phase2Box" style="margin-top:4px;display:none;font-size:13px;">
          <div style="margin-bottom:4px;">
            [6â€“10ë‹¨ê³„] íŒŒì›ì˜ ì£¼íŒŒìˆ˜ fëŠ” ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>
            <strong>ìŒì› ì†ë„ v<sub>s</sub> ìŠ¬ë¼ì´ë”</strong>ë¥¼ ì¡°ì ˆí•´
            <strong>ëª©í‘œ ê´€ì¸¡ ì£¼íŒŒìˆ˜</strong>ì— ìµœëŒ€í•œ ê°€ê¹ê²Œ ë§ì¶˜ ë’¤,<br>
            ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì œì¶œí•˜ì„¸ìš”. (Â±0.1 Hz ì´ë‚´ë©´ ì •ë‹µìœ¼ë¡œ ì²˜ë¦¬)
          </div>
          <div style="margin-bottom:4px;">
            ëª©í‘œ ê´€ì¸¡ ì£¼íŒŒìˆ˜: <strong><span id="targetFreq">-</span> Hz</strong>
          </div>
          <div style="margin-bottom:4px;">
            í˜„ì¬ ê´€ì¸¡ ì£¼íŒŒìˆ˜: <strong><span id="currentFreq">-</span> Hz</strong>
          </div>
          <button id="btnSubmitFreq" class="chip">ì´ ì†ë„ë¡œ ì œì¶œ</button>
        </div>

        <div id="gpMessage" style="margin-top:6px;font-size:13px;color:var(--muted);min-height:18px;"></div>
      </div>

      <!-- í•˜ë‹¨ ì •ë³´ ë° ë²„íŠ¼ -->
      <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;padding:0 4px 4px 4px">
        <div style="font-size:13px;color:var(--muted)">
          ê´€ì°° ì£¼íŒŒìˆ˜(ì •ë©´/í›„ë°©): <span id="fFront">â€”</span> / <span id="fBack">â€”</span> Hz Â·
          íŒŒì¥: <span id="lFront">â€”</span> / <span id="lBack">â€”</span> m
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="btnReset" class="chip">ì´ˆê¸°í™”</button>
          <button id="btnPause" class="chip">ì¼ì‹œì •ì§€</button>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <div class="brand">ì™•ì™• ë¬¼ë¦¬ì‹œë®¬ë ˆì´ì…˜</div>
  </footer>

  <script>
    // ---------- Elements & helpers ----------
    const $ = id => document.getElementById(id);
    const canvas = $('canvas');
    const ctx = canvas.getContext('2d');
    const cEl=$('c'), vsEl=$('vs'), fEl=$('f'), tsEl=$('timescale');
    const out_c=$('out_c'), out_vs=$('out_vs'), out_f=$('out_f'), out_speed=$('out_speed');
    const fFrontEl=$('fFront'), fBackEl=$('fBack'), lFrontEl=$('lFront'), lBackEl=$('lBack');
    const btnReset=$('btnReset'), btnPause=$('btnPause');
    const showMach=$('showMach'), showLambda=$('showLambda');

    // ë„ì „ ëª¨ë“œ ìš”ì†Œ
    const btnChallenge = $('btnChallenge');
    const gpRoundEl = $('gpRound');
    const gpScoreEl = $('gpScore');
    const gpBestEl  = $('gpBest');
    const gpMessageEl = $('gpMessage');
    const phase1Box = $('phase1Box');
    const phase2Box = $('phase2Box');
    const btnAnsUp   = $('btnAnsUp');
    const btnAnsDown = $('btnAnsDown');
    const btnAnsBoom = $('btnAnsBoom');
    const targetFreqEl  = $('targetFreq');
    const currentFreqEl = $('currentFreq');
    const btnSubmitFreq = $('btnSubmitFreq');

    // world scale
    function resize(){ canvas.width = canvas.clientWidth; }
    window.addEventListener('resize', resize); resize();

    // simulation state
    const state = {
      t: 0, emitAcc: 0,
      x0: 120, y0: 240, // start position
      emissions: [], // {t,x,y}
      paused: false,
      fObs: NaN,      // í˜„ì¬ ê´€ì¸¡ ì£¼íŒŒìˆ˜ (ë„ì „ ëª¨ë“œì—ì„œ ì‚¬ìš©)
    };

    // ë„ì „ ëª¨ë“œ ê²Œì„ ìƒíƒœ
    const game = {
      active: false,
      round: 0,
      totalRounds: 10,
      score: 0,
      bestScore: Number(localStorage.getItem('dopplerBestScore') || 0) || 0,
      phase: 0,           // 1: ê°œë…, 2: ìˆ˜ì¹˜ ë§ì¶”ê¸°
      correctKey: null,   // 'up' | 'down' | 'boom'
      targetFreq: null,   // ëª©í‘œ ê´€ì¸¡ ì£¼íŒŒìˆ˜
    };

    const SCORE_PER_CORRECT = 50;
    const FREQ_TOL = 0.1; // Â±.01 Hz

    function updateScoreUI(){
      gpRoundEl.textContent = game.active ? game.round : '-';
      gpScoreEl.textContent = game.score;
      gpBestEl.textContent  = game.bestScore;
    }

    function setMessage(msg, isGood){
      gpMessageEl.textContent = msg || '';
      gpMessageEl.style.color = isGood ? '#16a34a' : '#5b657a';
    }

    function resetSimPosition(){
      state.t = 0;
      state.emitAcc = 0;
      state.emissions.length = 0;
      state.x0 = 120;
    }

    function applyScore(isCorrect){
      if (!isCorrect){
        setMessage('ì•„ì‰½ì§€ë§Œ ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ìŒ ë¼ìš´ë“œë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.', false);
        return;
      }
      game.score += SCORE_PER_CORRECT;
      setMessage(`ì •ë‹µì…ë‹ˆë‹¤! +${SCORE_PER_CORRECT}ì  ğŸ‰`, true);

      if (game.score > game.bestScore){
        game.bestScore = game.score;
        localStorage.setItem('dopplerBestScore', String(game.bestScore));
        // ì¸ë±ìŠ¤ì—ì„œ Firebase ì—°ë™í•  ë•Œ ì“¸ ìˆ˜ ìˆë„ë¡ ì—´ì–´ë‘ 
        if (window.saveBestScoreToFirebase){
          try { window.saveBestScoreToFirebase(game.bestScore); } catch(e){}
        }
      }
      updateScoreUI();
    }

    function endGame(){
      setMessage(`ë„ì „ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜ëŠ” ${game.score}ì ì…ë‹ˆë‹¤.`, true);
      phase1Box.style.display = 'none';
      phase2Box.style.display = 'none';
      game.active = false;
      game.phase = 0;
      gpRoundEl.textContent = '-';
      // ìŠ¬ë¼ì´ë” ë‹¤ì‹œ í’€ì–´ì£¼ê¸°
      fEl.disabled = false;
      vsEl.disabled = false;
    }

    // ----- 1~5ë‹¨ê³„: ê°œë… ë¬¸ì œ -----
    function setupPhase1Round(){
      const c = Number(cEl.value) || 340;
      cEl.value = c;

      // ì£¼íŒŒìˆ˜ëŠ” ê³ ì •(2 Hz ê·¼ì²˜ë¡œ ë‹¨ìˆœí•˜ê²Œ)
      const baseF = 2.0;
      fEl.value = baseF;
      out_f.textContent = baseF.toFixed(1) + ' Hz';

      // ë¼ìš´ë“œë³„ ì‹œë‚˜ë¦¬ì˜¤ (ë§ˆì§€ë§‰ì€ ì´ˆìŒì†)
      const scenarios = [
        {vs: -150},
        {vs: -80},
        {vs: 80},
        {vs: 160},
        {vs: 500},
      ];
      const idx = (game.round - 1) % scenarios.length;
      const vs  = scenarios[idx].vs;
      vsEl.value = vs;
      out_vs.textContent = vs + ' m/s';

      // íŒŒë™ ì´ˆê¸°í™”
      resetSimPosition();

      // ê´€ì¸¡ì ìœ„ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì ‘ê·¼/ì´íƒˆ íŒë‹¨
      const w  = canvas.width;
      const ox = w - 80;
      const approaching = (vs > 0 && state.x0 < ox) || (vs < 0 && state.x0 > ox);

      let key;
      if (Math.abs(vs) > c){
        key = 'boom';
      } else {
        key = approaching ? 'up' : 'down';
      }
      game.correctKey = key;

      phase1Box.style.display = 'block';
      phase2Box.style.display = 'none';
      // ê°œë… ë‹¨ê³„ì—ì„œëŠ” vsëŠ” ê³ ì •í•´ë‘ëŠ” í¸ì´ ì¢‹ì•„ì„œ ì ì‹œ ì ê¸ˆ
      vsEl.disabled = true;
      fEl.disabled = true;

      setMessage('í˜„ì¬ ì„¤ì •ì—ì„œ ê´€ì°° ì£¼íŒŒìˆ˜ì˜ ë³€í™”(ì¦ê°€/ê°ì†Œ/ì†Œë‹‰ë¶)ë¥¼ ê³¨ë¼ë³´ì„¸ìš”.', false);
    }

    function handlePhase1Answer(choice){
      if (!game.active || game.phase !== 1) return;
      const isCorrect = (choice === game.correctKey);
      applyScore(isCorrect);
      setTimeout(nextRound, 800);
    }

    // ----- 6~10ë‹¨ê³„: ìˆ˜ì¹˜ ë§ì¶”ê¸° -----
    function setupPhase2Round(){
      const c = Number(cEl.value) || 340;
      cEl.value = c;

      // íŒŒì›ì˜ ì£¼íŒŒìˆ˜ f ê³ ì • (3~6 Hz ë²”ìœ„)
      const baseF = 3 + Math.random() * 3;
      fEl.value = baseF.toFixed(1);
      out_f.textContent = baseF.toFixed(1) + ' Hz';

      // ëª©í‘œ ê´€ì¸¡ ì£¼íŒŒìˆ˜ ë§Œë“¤ê¸°
      const maxVs = 0.7 * c; // ì´ˆìŒì† ì§ì „ê¹Œì§€
      let vsTarget = (Math.random() < 0.5 ? -1 : 1) * (50 + Math.random() * (maxVs - 50));

      const w  = canvas.width;
      const ox = w - 80;
      const approaching = (vsTarget > 0 && state.x0 < ox) || (vsTarget < 0 && state.x0 > ox);
      const s = approaching ? +1 : -1;
      const fTarget = baseF * (c / (c - s * vsTarget));

      game.targetFreq = fTarget;
      targetFreqEl.textContent  = fTarget.toFixed(1);
      currentFreqEl.textContent = isFinite(state.fObs) ? state.fObs.toFixed(1) : 'â€”';

      // ì‹¤ì œ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ìƒíƒœëŠ” vs=0ì—ì„œ ì¶œë°œ
      vsEl.value = 0;
      out_vs.textContent = '0 m/s';
      resetSimPosition();

      // ìˆ˜ì¹˜ ë§ì¶”ê¸° ë‹¨ê³„ì—ì„œëŠ” vsëŠ” í•™ìƒì´ ì¡°ì ˆí•  ìˆ˜ ìˆì–´ì•¼ í•˜ê³  fëŠ” ê³ ì •
      vsEl.disabled = false;
      fEl.disabled = true;

      phase1Box.style.display = 'none';
      phase2Box.style.display = 'block';
      setMessage('ìŒì› ì†ë„ ìŠ¬ë¼ì´ë”ë¡œ ê´€ì¸¡ ì£¼íŒŒìˆ˜ë¥¼ ëª©í‘œ ê°’ì— ê°€ê¹ê²Œ ë§ì¶˜ ë’¤ "ì´ ì†ë„ë¡œ ì œì¶œ"ì„ ëˆŒëŸ¬ë³´ì„¸ìš”. (Â±10 Hz)', false);
    }

    function handleFreqSubmit(){
      if (!game.active || game.phase !== 2) return;
      const fObs = state.fObs;
      if (!isFinite(fObs)){
        setMessage('í˜„ì¬ ê´€ì¸¡ ì£¼íŒŒìˆ˜ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì´ˆìŒì† ë“±) ì†ë„ë¥¼ ì¡°ê¸ˆ ì¡°ì •í•´ ì£¼ì„¸ìš”.', false);
        return;
      }
      currentFreqEl.textContent = fObs.toFixed(1);
      const diff = Math.abs(fObs - game.targetFreq);
      const isCorrect = diff <= FREQ_TOL;
      applyScore(isCorrect);
      setTimeout(nextRound, 800);
    }

    // ----- ë„ì „ ëª¨ë“œ ì»¨íŠ¸ë¡¤ -----
    function startChallenge(){
      game.active = true;
      game.round  = 0;
      game.score  = 0;
      game.phase  = 0;
      setMessage('ë„ì „ ëª¨ë“œ ì‹œì‘! 1ë‹¨ê³„ë¶€í„° ì°¨ê·¼ì°¨ê·¼ í’€ì–´ë´…ì‹œë‹¤.', false);
      updateScoreUI();
      nextRound();
    }

    function nextRound(){
      if (!game.active) return;
      if (game.round >= game.totalRounds){
        endGame();
        return;
      }
      game.round++;
      updateScoreUI();

      if (game.round <= 5){
        game.phase = 1;
        setupPhase1Round();
      } else {
        game.phase = 2;
        setupPhase2Round();
      }
    }

    // ì™¸ë¶€(Firebase ëª¨ë“ˆ ë“±)ì—ì„œ ìµœê³  ì ìˆ˜ ë¡œë“œí•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡
    window.setBestScoreFromFirebase = function(score){
      game.bestScore = Number(score) || 0;
      updateScoreUI();
    };

    // ì´ˆê¸° UI ì„¸íŒ…
    updateScoreUI();
    setMessage('ë„ì „ ëª¨ë“œ ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¬¸ì œ í’€ì´ë¥¼ ì‹œì‘í•´ ë³´ì„¸ìš”.', false);

    // quick chips
    document.querySelectorAll('.chip[data-vs]').forEach(btn=>{
      btn.addEventListener('click',()=>{ vsEl.value = btn.dataset.vs; });
    });

    btnReset.addEventListener('click',()=>{
      state.t=0; state.emitAcc=0; state.emissions.length=0; state.x0=120;
    });
    btnPause.addEventListener('click',()=>{
      state.paused = !state.paused; btnPause.textContent = state.paused? 'ì¬ìƒ' : 'ì¼ì‹œì •ì§€';
    });

    // ë„ì „ ëª¨ë“œ ë²„íŠ¼ë“¤
    if (btnChallenge){
      btnChallenge.addEventListener('click', startChallenge);
    }
    if (btnAnsUp){
      btnAnsUp.addEventListener('click',   ()=>handlePhase1Answer('up'));
      btnAnsDown.addEventListener('click', ()=>handlePhase1Answer('down'));
      btnAnsBoom.addEventListener('click', ()=>handlePhase1Answer('boom'));
    }
    if (btnSubmitFreq){
      btnSubmitFreq.addEventListener('click', handleFreqSubmit);
    }

    // main update
    let last=performance.now();
    function loop(now){
      const dtRaw = (now-last)/1000; last = now;
      const ts = Number(tsEl.value);
      const dt = Math.min(0.05, dtRaw*ts);
      const c = Number(cEl.value);
      const vs = Number(vsEl.value);
      const f = Number(fEl.value);
      out_c.textContent = c + ' m/s';
      out_vs.textContent = vs + ' m/s';
      out_f.textContent = f.toFixed(1) + ' Hz';
      out_speed.textContent = ts+'x';

      // observed frequencies and wavelengths (source moving, observer ì •ì§€)
      const fFront = f * (c/(c - vs));
      const fBack  = f * (c/(c + vs));
      const lFront = (c - vs)/f; // ahead (ì••ì¶•)
      const lBack  = (c + vs)/f; // behind (íŒ½ì°½)

      // --- ê´€ì¸¡ìì—ì„œì˜ ë„í”ŒëŸ¬ ì£¼íŒŒìˆ˜/íŒŒì¥ ---
      const ox = canvas.width - 80;
      const approaching = (vs > 0 && state.x0 < ox) || (vs < 0 && state.x0 > ox);

      let fObs = NaN, lObs = NaN;
      if (Math.abs(vs) < c) {
        const s = approaching ? +1 : -1;
        fObs = f * (c / (c - s * vs));
        lObs = c / fObs;
      }
      $('fObs').textContent = isFinite(fObs) ? fObs.toFixed(2) : 'â€”';
      $('lObs').textContent = isFinite(lObs) ? lObs.toFixed(2) : 'â€”';
      fFrontEl.textContent = isFinite(fFront)? fFront.toFixed(2) : 'â€”';
      fBackEl.textContent  = isFinite(fBack)?  fBack.toFixed(2)  : 'â€”';
      lFrontEl.textContent = isFinite(lFront)? lFront.toFixed(2) : 'â€”';
      lBackEl.textContent  = isFinite(lBack)?  lBack.toFixed(2)  : 'â€”';

      // ë„ì „ ëª¨ë“œìš© í˜„ì¬ ê´€ì¸¡ ì£¼íŒŒìˆ˜ ì €ì¥
      state.fObs = fObs;
      if (currentFreqEl && game.active && game.phase === 2){
        currentFreqEl.textContent = isFinite(fObs) ? fObs.toFixed(1) : 'â€”';
      }

      if(!state.paused){
        state.t += dt;
        state.emitAcc += dt;
        const period = 1/Math.max(0.1, f);
        while(state.emitAcc >= period){
          const te = state.t - state.emitAcc + period;
          const xe = state.x0 - vs * (state.t - te);
          state.emissions.push({t: te, x: xe, y: state.y0});
          state.emitAcc -= period;
        }
        state.x0 += vs * dt;
        const margin = 200;
        if(state.x0 > canvas.width + margin) state.x0 = -margin;
        if(state.x0 < -margin)               state.x0 = canvas.width + margin;
      }

      draw(c, vs, f, lFront, lBack);
      requestAnimationFrame(loop);
    }

    function draw(c, vs, f, lFront, lBack){
      const w = canvas.width, h = canvas.height;
      ctx.clearRect(0,0,w,h);

      // grid
      ctx.strokeStyle = '#eef2ff';
      ctx.lineWidth=1;
      ctx.beginPath();
      for(let x=40;x<w;x+=40){ctx.moveTo(x,0);ctx.lineTo(x,h);}
      for(let y=40;y<h;y+=40){ctx.moveTo(0,y);ctx.lineTo(w,y);}
      ctx.stroke();

      // observer icon (right side)
      const oy = state.y0;
      const ox = w - 80;
      ctx.fillStyle='#10b981';
      ctx.fillRect(ox-3, oy-30, 6, 30);
      ctx.beginPath();
      ctx.arc(ox, oy-36, 6, 0, Math.PI*2);
      ctx.fill();

      // wavefront circles
      ctx.strokeStyle = '#60a5fa';
      ctx.lineWidth=1.6;
      const now = state.t;
      const maxAge = 6 / Math.max(0.1, f);
      const kept = [];
      for(const wf of state.emissions){
        const age = now - wf.t;
        if(age < 0) continue;
        const r = c * age;
        const px = wf.x;
        const py = wf.y;
        const R = r;
        if(R < 2 || px + R < -50 || px - R > w+50) {
          if(now - wf.t < maxAge) kept.push(wf);
          continue;
        }
        ctx.beginPath();
        ctx.arc(px, py, R, 0, Math.PI*2);
        ctx.stroke();
        if(now - wf.t < maxAge) kept.push(wf);
      }
      state.emissions = kept;

      // source (car)
      const sx = state.x0, sy = state.y0;
      ctx.fillStyle = '#ef4444';
      ctx.fillRect(sx-18, sy-12, 36, 16);
      ctx.beginPath();
      ctx.arc(sx-10, sy+5, 4, 0, Math.PI*2);
      ctx.arc(sx+10, sy+5, 4, 0, Math.PI*2);
      ctx.fillStyle='#111';
      ctx.fill();

      // direction arrow
      ctx.beginPath();
      ctx.moveTo(sx, sy-22);
      ctx.lineTo(sx + Math.sign(vs)*20, sy-22);
      ctx.lineTo(sx + Math.sign(vs)*16, sy-26);
      ctx.moveTo(sx + Math.sign(vs)*20, sy-22);
      ctx.lineTo(sx + Math.sign(vs)*16, sy-18);
      ctx.strokeStyle='#94a3b8';
      ctx.stroke();

      // Mach cone (only when |vs|>c)
      if (showMach.checked && Math.abs(vs) > c) {
        const M = Math.abs(vs) / c;
        const mu = Math.asin(1 / M);
        const ax = sx, ay = sy, len = 1200;
        const phi = (vs >= 0) ? 0 : Math.PI;
        const base = (phi + Math.PI) % (2 * Math.PI);
        const ang1 = base + mu;
        const ang2 = base - mu;

        ctx.strokeStyle = '#f59e0b';
        ctx.setLineDash([6, 6]);
        ctx.lineWidth = 2;

        ctx.beginPath();
        ctx.moveTo(ax, ay);
        ctx.lineTo(ax + len * Math.cos(ang1), ay + len * Math.sin(ang1));
        ctx.stroke();

        ctx.beginPath();
        ctx.moveTo(ax, ay);
        ctx.lineTo(ax + len * Math.cos(ang2), ay + len * Math.sin(ang2));
        ctx.stroke();

        ctx.setLineDash([]);
        ctx.lineWidth = 1.6;
      }

      // Lambda markers ahead/behind along motion direction
      if(showLambda.checked){
        const dir = Math.sign(vs) || 1;
        const front = sx + dir*30;
        const back = sx - dir*30;
        // front
        ctx.strokeStyle='#64748b';
        ctx.beginPath();
        ctx.moveTo(front, sy+16);
        ctx.lineTo(front + dir*lFront, sy+16);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(front, sy+12);
        ctx.lineTo(front, sy+20);
        ctx.moveTo(front + dir*lFront, sy+12);
        ctx.lineTo(front + dir*lFront, sy+20);
        ctx.stroke();
        ctx.fillStyle='#64748b';
        ctx.fillText('Î»â€²(front)', front + dir*lFront/2 - 18, sy+28);
        // back
        ctx.beginPath();
        ctx.moveTo(back, sy+34);
        ctx.lineTo(back - dir*lBack, sy+34);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(back, sy+30);
        ctx.lineTo(back, sy+38);
        ctx.moveTo(back - dir*lBack, sy+30);
        ctx.lineTo(back - dir*lBack, sy+38);
        ctx.stroke();
        ctx.fillText('Î»â€²(back)', back - dir*lBack/2 - 16, sy+46);
      }

      // labels
      ctx.fillStyle = '#0f172a';
      ctx.fillText(`Mach = |v_s|/v = ${(Math.abs(vs)/c).toFixed(2)}`, 14, 24);
    }

    requestAnimationFrame(loop);
  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
      authDomain: "simulation-67cd3.firebaseapp.com",
      projectId: "simulation-67cd3",
      storageBucket: "simulation-67cd3.appspot.com",
      messagingSenderId: "615983461615",
      appId: "1:615983461615:web:002e07bcea878eb6d5571a",
      measurementId: "G-9RGN7LYE5W"
    };

    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const SIM_ID = "ë„í”ŒëŸ¬_íš¨ê³¼";
    let firebaseUser = null;

    async function saveBestScore(score) {
      if (!firebaseUser) return;
      try {
        const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
        await setDoc(ref, { score: Number(score) || 0 }, { merge: true });
      } catch (err) {
        console.error("[ë„í”ŒëŸ¬ íš¨ê³¼] ìµœê³  ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:", err);
      }
    }

    async function loadBestScore() {
      if (!firebaseUser) return;
      try {
        const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data  = snap.data();
          const score = Number(data.score || 0) || 0;
          if (window.setBestScoreFromFirebase) {
            window.setBestScoreFromFirebase(score);
          }
        }
      } catch (err) {
        console.error("[ë„í”ŒëŸ¬ íš¨ê³¼] ìµœê³  ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
      }
    }

    window.saveBestScoreToFirebase = saveBestScore;

    onAuthStateChanged(auth, async (user) => {
      firebaseUser = user;
      if (user) {
        await loadBestScore();
      }
    });
  </script>
</body>
</html>
