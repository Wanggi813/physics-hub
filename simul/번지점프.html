<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¬¼ë¦¬ ë²ˆì§€ì í”„: ëª¨ë°”ì¼ ì—ë””ì…˜</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #252525;
            --accent-color: #00e5ff;
            --highlight-color: #ffd700;
            --danger-color: #ff4444;
            --e-pot: #ffcc00; --e-kin: #44ff44; --e-spr: #ff4444; --e-mec: #c77dff;
        }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-color); color: #fff;
            font-family: 'Pretendard', sans-serif;
            display: flex; height: 100vh; overflow: hidden;
            /* ëª¨ë°”ì¼ì—ì„œ í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
            user-select: none; -webkit-user-select: none;
        }

        /* ì„¸ë¡œ ëª¨ë“œ ê²½ê³  ì˜¤ë²„ë ˆì´ */
        #portrait-warning {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: none; /* JSë¡œ ì œì–´ */
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        #portrait-warning .icon { font-size: 3rem; margin-bottom: 20px; animation: rotate-phone 2s infinite; }
        @keyframes rotate-phone { 0% { transform: rotate(0deg); } 25% { transform: rotate(90deg); } 50% { transform: rotate(90deg); } 100% { transform: rotate(0deg); } }

        /* ì™¼ìª½: ê²Œì„ í™”ë©´ */
        #game-view {
            position: relative; flex: 2; /* í™”ë©´ ë¹„ìœ¨ ì¡°ì • */
            border-right: 2px solid #444; overflow: hidden; cursor: crosshair;
            background: #87CEEB;
        }
        canvas { display: block; width: 100%; height: 100%; }

        #photo-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; pointer-events: none; transition: opacity 0.1s;
        }

        /* ì˜¤ë¥¸ìª½: ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #control-panel {
            flex: 1; min-width: 280px; max-width: 400px; /* ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ ì œí•œ */
            background: var(--panel-bg);
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.5); z-index: 10;
        }

        h2 { margin: 0 0 5px 0; color: var(--accent-color); text-align: center; border-bottom: 1px solid #444; padding-bottom: 5px; font-size: 1.2rem; }
        
        .info-box {
            background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;
            border-left: 4px solid var(--accent-color); min-height: 40px;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-weight: bold; line-height: 1.3;
            transition: all 0.3s; font-size: 0.9rem;
        }
        .info-box.highlight { background: rgba(0, 229, 255, 0.1); border-left-color: var(--highlight-color); color: var(--highlight-color); }
        .info-box.danger { background: rgba(255, 68, 68, 0.1); border-left-color: var(--danger-color); color: var(--danger-color); }

        .section { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 2px; }
        .section-title { font-size: 0.8rem; color: #aaa; margin-bottom: 8px; display: block; font-weight: bold; }

        /* ìŠ¤ìœ„ì¹˜ & ìŠ¬ë¼ì´ë” ë“± UI ìš”ì†Œ í¬ê¸° ì¡°ì • */
        .toggle-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* ì—ë„ˆì§€ ë°” */
        .energy-bar-container { display: flex; align-items: center; gap: 5px; margin-bottom: 4px; font-size: 0.75rem; }
        .bar-label { width: 50px; font-weight: bold; }
        .bar-bg { 
            flex: 1; height: 10px; background-color: #444; border-radius: 5px; overflow: hidden; 
            background-image: linear-gradient(90deg, transparent 0%, transparent 98%, rgba(255,255,255,0.3) 98%, rgba(255,255,255,0.3) 100%);
            background-size: 10% 100%;
        }
        .bar-fill { height: 100%; transition: width 0.05s linear; }

        input[type="range"] { width: 100%; accent-color: var(--accent-color); cursor: pointer; height: 20px; } /* í„°ì¹˜í•˜ê¸° í¸í•˜ê²Œ ë†’ì´ ì¦ê°€ */
        
        button#jumpBtn {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            background: var(--accent-color); border: none; border-radius: 8px;
            cursor: pointer; color: #000; margin-top: auto; transition: 0.1s;
            touch-action: manipulation; /* í„°ì¹˜ ë”œë ˆì´ ì œê±° */
        }
        button#jumpBtn:active { transform: scale(0.98); }
        button#jumpBtn:disabled { background: #555; color: #888; }

        #resetBtn {
            width: 100%; padding: 10px; background: #444; border: none; border-radius: 8px;
            color: #fff; cursor: pointer; margin-top: 5px; font-size: 0.9rem;
            touch-action: manipulation;
        }

        /* ëª¨ë‹¬ (ìƒë‹¨ ë°°ì¹˜) */
        #result-modal {
            position: absolute; top: 10%; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); padding: 20px; border-radius: 15px;
            text-align: center; border: 2px solid var(--accent-color); display: none; z-index: 100;
            width: 80%; max-width: 320px; box-shadow: 0 5px 30px rgba(0,0,0,0.5);
        }
        #modal-title.fail { color: #ff4444; }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ì²˜ë¦¬ */
        @media (max-width: 800px) {
            h2 { font-size: 1rem; }
            .info-box { font-size: 0.8rem; padding: 8px; }
            #control-panel { min-width: 220px; padding: 10px; }
        }
    </style>
</head>
<body>

<div id="portrait-warning">
    <div class="icon">ğŸ“±ğŸ”„</div>
    <h2>ê°€ë¡œë¡œ íšŒì „í•´ì£¼ì„¸ìš”</h2>
    <p>ì´ ì‹¤í—˜ì€ ê°€ë¡œ ëª¨ë“œì— ìµœì í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.<br>í•¸ë“œí°ì„ ëŒë ¤ì£¼ì„¸ìš”.</p>
</div>

<div id="game-view">
    <canvas id="simCanvas"></canvas>
    <div id="photo-flash"></div>
    <div id="result-modal">
        <h2 id="modal-title">ê²°ê³¼</h2>
        <p id="modal-desc" style="font-size:1rem; line-height:1.5;">ë‚´ìš©</p>
        <button onclick="resetGame()" style="padding:10px 25px; background:#444; color:white; border:none; border-radius:5px; cursor:pointer; margin-top:15px; font-size:0.9rem;">ë‹¤ì‹œ ì„¤ê³„í•˜ê¸°</button>
    </div>
</div>

<div id="control-panel">
    <h2>ğŸ”¬ ë¬¼ë¦¬ ì‹¤í—˜ì‹¤ v3.7 (Mobile)</h2>

    <div id="guide-box" class="info-box">
        ì•ˆì „í•œ ë²ˆì§€ì í”„ë¥¼ ì„¤ê³„í•˜ì„¸ìš”.<br>
        <span style="font-size:0.8rem; color:#aaa; font-weight:normal;">1ì°¨ ì‹œê¸° ë¯¸ì…˜: ìµœí•˜ì ì—ì„œ [SPACE] ì´¬ì˜!</span>
    </div>

    <div id="analysis-controls" class="section" style="display:none;">
        <span class="section-title" style="color:var(--highlight-color)">â±ï¸ íƒ€ì„ ì»¨íŠ¸ë¡¤ëŸ¬</span>
        <div style="font-size:0.75rem; margin-bottom:5px;">ìŠ¬ë¼ì´ë”ë¡œ ì—ë„ˆì§€ ë¶„ì„</div>
        <div style="display:flex; align-items:center; gap:5px;">
            <span>âª</span><input type="range" id="time-slider" min="0" max="100" value="100" step="1"><span>â©</span>
        </div>
    </div>

    <div id="energy-section" class="section">
        <div class="toggle-wrapper">
            <span class="section-title" style="margin:0;">ğŸ“Š ê³µê¸° ì €í•­ (Air Drag)</span>
            <label class="switch">
                <input type="checkbox" id="air-toggle" checked>
                <span class="slider"></span>
            </label>
        </div>
        
        <div class="energy-bar-container"><span class="bar-label" style="color:var(--e-pot);">ìœ„ì¹˜(P)</span><div class="bar-bg"><div id="bar-pe" class="bar-fill" style="background:var(--e-pot); width:0%;"></div></div></div>
        <div class="energy-bar-container"><span class="bar-label" style="color:var(--e-kin);">ìš´ë™(K)</span><div class="bar-bg"><div id="bar-ke" class="bar-fill" style="background:var(--e-kin); width:0%;"></div></div></div>
        <div class="energy-bar-container"><span class="bar-label" style="color:var(--e-spr);">íƒ„ì„±(E)</span><div class="bar-bg"><div id="bar-se" class="bar-fill" style="background:var(--e-spr); width:0%;"></div></div></div>
        <div class="energy-bar-container" style="margin-top:5px; border-top:1px solid #444; padding-top:5px;"><span class="bar-label" style="color:var(--e-mec);">ì—­í•™ì </span><div class="bar-bg"><div id="bar-mec" class="bar-fill" style="background:var(--e-mec); width:0%;"></div></div></div>
    </div>

    <div class="section">
        <span class="section-title">âš™ï¸ ì¥ë¹„ ì„¤ê³„</span>
        
        <div style="margin-bottom: 8px; font-weight:bold; color:#fff; background:#444; padding:5px; border-radius:4px; text-align:center; font-size:0.8rem;">
            í˜„ì¬ ë°”ë‹¥ ë†’ì´: <span id="val-ground-height" style="color:var(--accent-color)">--</span> m
        </div>

        <label style="font-size:0.8rem;">ì¤„ì˜ íƒ„ì„± (k): <span id="val-k" style="float:right; color:var(--accent-color)">40</span></label>
        <input type="range" id="input-k" min="30" max="300" value="40" step="5">
        
        <label style="font-size:0.8rem; margin-top:5px; display:block;">ì¤„ì˜ ê¸¸ì´ (L): <span id="val-l" style="float:right; color:var(--accent-color)">30</span></label>
        <input type="range" id="input-l" min="20" max="50" value="30" step="1">
    </div>

    <div class="section" id="photo-section" style="padding: 5px; display:none;"> <div id="photo-status" style="color:#aaa; text-align:center; font-size:0.8rem;">ğŸ“¸ ë¯¸ì…˜ ëŒ€ê¸° ì¤‘...</div>
    </div>

    <button id="jumpBtn">JUMP! (ë‚™í•˜ ì‹œì‘)</button>
    <button id="resetBtn">ì„¤ì • ì´ˆê¸°í™”</button>
</div>

<script>
    // --- ë¬¼ë¦¬ ë° ê²Œì„ ìƒìˆ˜ ---
    const G = 9.8;
    const MASS = 60;
    const DEFAULT_DAMPING = 0.997; 
    const NO_DAMPING = 1.0;        
    let SCALE = 10; 
    const BLACKOUT_G = 4.0;
    const FATAL_G = 6.0; 

    let phase = 0; 
    let replayData = []; 
    let trees = [];

    const state = {
        y: 2, v: 0, a: 0,
        k: 40, l: 30,
        damping: DEFAULT_DAMPING,
        isRunning: false,
        timeScale: 1.0,
        zoom: 1.0, targetZoom: 1.0,
        photoTaken: false, photoScore: 0,
        maxRecordG: 0,
        isBlackout: false 
    };

    // --- DOM ìš”ì†Œ ---
    const ui = {
        canvas: document.getElementById('simCanvas'),
        ctx: document.getElementById('simCanvas').getContext('2d'),
        k: document.getElementById('input-k'), l: document.getElementById('input-l'),
        valK: document.getElementById('val-k'), valL: document.getElementById('val-l'),
        valGround: document.getElementById('val-ground-height'),
        jumpBtn: document.getElementById('jumpBtn'), resetBtn: document.getElementById('resetBtn'),
        guide: document.getElementById('guide-box'),
        energySec: document.getElementById('energy-section'),
        analysisPanel: document.getElementById('analysis-controls'),
        timeSlider: document.getElementById('time-slider'),
        photoStat: document.getElementById('photo-status'),
        airToggle: document.getElementById('air-toggle'),
        bars: { pe:document.getElementById('bar-pe'), ke:document.getElementById('bar-ke'), se:document.getElementById('bar-se'), mec:document.getElementById('bar-mec') },
        flash: document.getElementById('photo-flash'),
        modal: document.getElementById('result-modal'),
        mTitle: document.getElementById('modal-title'), mDesc: document.getElementById('modal-desc'),
        warning: document.getElementById('portrait-warning')
    };

    // --- í™”ë©´ ë°©í–¥ ë° ë¦¬ì‚¬ì´ì§• ---
    function checkOrientation() {
        if (window.innerHeight > window.innerWidth) {
            ui.warning.style.display = 'flex';
        } else {
            ui.warning.style.display = 'none';
            resize(); // ê°€ë¡œ ëª¨ë“œì¼ ë•Œë§Œ ë¦¬ì‚¬ì´ì§• ìˆ˜í–‰
        }
    }
    window.addEventListener('resize', checkOrientation);
    
    function resize() {
        if (!ui.canvas) return;
        const container = document.getElementById('game-view');
        // Retina Display ëŒ€ì‘ (ì„ ëª…í•˜ê²Œ)
        const dpr = window.devicePixelRatio || 1;
        const rect = container.getBoundingClientRect();
        
        ui.canvas.width = rect.width * dpr;
        ui.canvas.height = rect.height * dpr;
        
        // CSS í¬ê¸° ì„¤ì •ì€ 100%ë¡œ ë‘ê³ , ë“œë¡œì‰ ìŠ¤ì¼€ì¼ ì¡°ì •
        ui.ctx.scale(dpr, dpr);

        // ë…¼ë¦¬ì  ë†’ì´ (CSS í”½ì…€ ê¸°ì¤€)
        const logicalHeight = rect.height;
        
        // í™”ë©´ ë†’ì´ë¥¼ ì•½ 55më¡œ ê°€ì •í•˜ì—¬ ìŠ¤ì¼€ì¼ ê³„ì‚°
        SCALE = logicalHeight / 55; 
        ui.valGround.innerText = (logicalHeight / SCALE).toFixed(1);
        
        initTrees(rect.width, logicalHeight);
    }

    function initTrees(w, h) {
        trees = [];
        for (let i = -50; i <= w + 50; i += 30) {
            const height = Math.random() * 80 + 100; 
            const type = Math.random() > 0.5 ? 0 : 1; 
            trees.push({ x: i, h: height, t: type, offset: Math.random()*10 });
        }
    }

    // --- ê²Œì„ ë¡œì§ ---
    function resetGame() {
        state.y = 2; state.v = 0; state.a = 0;
        state.isRunning = false; 
        state.timeScale = 1.0; state.zoom = 1.0; state.targetZoom = 1.0;
        state.photoTaken = false; state.photoScore = 0; state.maxRecordG = 0;
        state.isBlackout = false; 

        state.damping = ui.airToggle.checked ? DEFAULT_DAMPING : NO_DAMPING;

        phase = 0; replayData = [];

        ui.modal.style.display = 'none'; ui.mTitle.classList.remove('fail');
        ui.jumpBtn.disabled = false; ui.jumpBtn.innerText = "JUMP! (ë‚™í•˜ ì‹œì‘)";
        ui.photoStat.innerText = "ğŸ“¸ ë¯¸ì…˜ ëŒ€ê¸° ì¤‘..."; ui.photoStat.style.color = "#aaa";
        ui.guide.className = "info-box";
        ui.guide.innerHTML = "ì•ˆì „í•œ ë²ˆì§€ì í”„ë¥¼ ì„¤ê³„í•˜ì„¸ìš”.<br><span style='font-size:0.8rem; font-weight:normal;'>1ì°¨ ì‹œê¸°: ìµœí•˜ì ì—ì„œ [SPACE] ì´¬ì˜</span>";
        ui.analysisPanel.style.display = "none";
        ui.energySec.style.opacity = "0.6"; 
        updateEnergyUI(); 
    }

    // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
    ui.k.addEventListener('input', e => { state.k = +e.target.value; ui.valK.innerText = state.k; });
    ui.l.addEventListener('input', e => { state.l = +e.target.value; ui.valL.innerText = state.l; });
    ui.jumpBtn.addEventListener('click', startJump);
    ui.resetBtn.addEventListener('click', resetGame);
    ui.airToggle.addEventListener('change', e => { state.damping = e.target.checked ? DEFAULT_DAMPING : NO_DAMPING; });
    
    window.addEventListener('keydown', (e) => {
        if (e.code === 'Space' && state.isRunning && phase === 1 && !state.photoTaken) takePhoto();
    });
    // ëª¨ë°”ì¼ í„°ì¹˜ë¡œ ì‚¬ì§„ ì°ê¸° (í™”ë©´ í„°ì¹˜ ì‹œ)
    ui.canvas.addEventListener('touchstart', (e) => {
        if (state.isRunning && phase === 1 && !state.photoTaken) {
            e.preventDefault();
            takePhoto();
        }
    });

    ui.timeSlider.addEventListener('input', handleTimeSlider);

    function startJump() {
        if(!state.isRunning) { 
            state.isRunning = true; phase = 1; 
            ui.jumpBtn.disabled = true; ui.jumpBtn.innerText = "ë‚™í•˜ ì¤‘..."; 
            ui.guide.innerHTML = "ë–¨ì–´ì§‘ë‹ˆë‹¤!<br><span style='color:var(--accent-color)'>ìµœí•˜ì ì—ì„œ [í™”ë©´ í„°ì¹˜] ë˜ëŠ” [SPACE]!</span>";
            ui.energySec.style.opacity = "1";
        }
    }

    function takePhoto() {
        state.photoTaken = true;
        const speed = Math.abs(state.v);
        let msg = "";
        ui.flash.style.opacity = 0.8; setTimeout(() => ui.flash.style.opacity = 0, 100);

        if (speed < 2.5) { state.photoScore = 100; msg = "ğŸ“¸ NICE SHOT! (ì™„ë²½)"; ui.photoStat.style.color = "#44ff44"; } 
        else { state.photoScore = 50; msg = "ğŸ“¸ ì°°ì¹µ! (í”ë“¤ë¦¼)"; ui.photoStat.style.color = "#ffd700"; }
        ui.photoStat.innerText = msg;
        ui.guide.innerHTML = msg + "<br><span style='font-size:0.8rem; font-weight:normal;'>ë°˜ë™ í›„ 'ì •ë°€ ë¶„ì„ ëª¨ë“œ'ë¡œ ì§„ì…í•©ë‹ˆë‹¤.</span>";
    }

    function handleTimeSlider(e) {
        if (phase === 4) {
            const idx = parseInt(e.target.value);
            if (replayData[idx]) {
                const frame = replayData[idx];
                state.y = frame.y; state.v = frame.v; state.a = frame.a;
                updateEnergyUI();
            }
        }
    }

    // --- ë©”ì¸ ë£¨í”„ ---
    function update() {
        if (!state.isRunning || phase === 4) return;

        const dt = 0.016 * state.timeScale;

        // 1. ë¬¼ë¦¬ ê³„ì‚°
        let force = MASS * G; 
        if (state.y > state.l) force += -state.k * (state.y - state.l); 
        force -= 0.5 * state.v * (state.damping === NO_DAMPING ? 0 : 1);

        state.a = force / MASS;
        state.v += state.a * dt;
        state.y += state.v * dt;
        state.v *= state.damping;

        const currentG = Math.abs(state.a) / G;
        state.maxRecordG = Math.max(state.maxRecordG, currentG);

        // [ê¸°ì ˆ ë¡œì§]
        if (state.y > state.l && currentG > BLACKOUT_G) {
            state.isBlackout = true;
        }

        const container = document.getElementById('game-view');
        const logicalHeight = container.getBoundingClientRect().height;
        const groundM = logicalHeight / SCALE;
        
        // (A) ë°”ë‹¥ ì¶©ëŒ
        if (state.y + 1.8 >= groundM) {
            endGame("ì‹¤íŒ¨: ë°”ë‹¥ ì¶©ëŒ!", "ì¤„ì´ ë„ˆë¬´ ê¸¸ê±°ë‚˜ íƒ„ì„±ì´ ë¶€ì¡±í–ˆìŠµë‹ˆë‹¤.<br>ì¤„ì˜ ê¸¸ì´(L)ë¥¼ ì¤„ì—¬ë³´ì„¸ìš”.");
            return;
        }

        // (B) ì‹¤ì‹œê°„ ìœ„í—˜ ì•Œë¦¼
        if (currentG > FATAL_G && state.y > state.l) {
            ui.guide.className = "info-box danger";
            ui.guide.innerHTML = `âš ï¸ <strong>ìœ„í—˜: ${currentG.toFixed(1)}G</strong><br>íŒŒì¼ëŸ¿ì´ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤!`;
        }

        // 3. ì‹œë‚˜ë¦¬ì˜¤ ì§„í–‰
        if (phase === 1 && state.v < 0) phase = 2; 
        if (phase === 2 && state.v > 0) { 
            phase = 3; 
            ui.guide.className = "info-box";
            ui.guide.innerHTML = "ğŸ”» 2ì°¨ ë‚™í•˜ ì¤‘ (ê¸°ë¡) ğŸ”»<br><span style='font-size:0.8rem;'>ì ì‹œ í›„ ë¶„ì„ ëª¨ë“œê°€ ë©ë‹ˆë‹¤.</span>";
            replayData = []; 
        }
        if (phase === 3) {
            replayData.push({ y: state.y, v: state.v, a: state.a }); 
            if (state.y > state.l && state.v < -0.5) enterAnalysisMode();
        }
        
        state.zoom += (state.targetZoom - state.zoom) * 0.1;
        updateEnergyUI();
    }

    function enterAnalysisMode() {
        if (state.isBlackout) {
            endGame("ì‹¤íŒ¨: íŒŒì¼ëŸ¿ ê¸°ì ˆ!", `ìµœëŒ€ ${state.maxRecordG.toFixed(1)}Gë¡œ ê¸°ì ˆí–ˆìŠµë‹ˆë‹¤.<br>ì¤„ì˜ íƒ„ì„±(k)ì„ ì¤„ì—¬ì„œ ë¶€ë“œëŸ½ê²Œ ë§Œë“¤ì–´ë³´ì„¸ìš”.`);
            return;
        }

        phase = 4; state.targetZoom = 2.0; 
        ui.analysisPanel.style.display = "block";
        ui.guide.className = "info-box highlight";
        ui.guide.innerHTML = "âœ‹ <strong>ë¶„ì„ ëª¨ë“œ</strong><br>ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”.";
        ui.timeSlider.max = replayData.length - 1;
        ui.timeSlider.value = replayData.length - 1;
    }

    function updateEnergyUI() {
        const container = document.getElementById('game-view');
        const groundM = container.getBoundingClientRect().height / SCALE;
        const h = Math.max(0, groundM - state.y);
        
        const pe = MASS * G * h; 
        const ke = 0.5 * MASS * state.v * state.v; 
        const extension = Math.max(0, state.y - state.l);
        const se = 0.5 * state.k * extension * extension;
        const mec = pe + ke + se; 

        const maxE = MASS * G * groundM; 
        
        ui.bars.pe.style.width = Math.min(100, (pe / maxE) * 100) + "%";
        ui.bars.ke.style.width = Math.min(100, (ke / maxE) * 100) + "%";
        ui.bars.se.style.width = Math.min(100, (se / maxE) * 100) + "%";
        ui.bars.mec.style.width = Math.min(100, (mec / maxE) * 100) + "%";
    }

    function endGame(title, desc) {
        state.isRunning = false;
        ui.mTitle.innerText = title; ui.mTitle.classList.add('fail');
        ui.mDesc.innerHTML = desc;
        ui.modal.style.display = 'block';
    }

    // --- ë Œë”ë§ ---
    function draw() {
        const ctx = ui.ctx; 
        // ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ í”½ì…€ í¬ê¸°ê°€ ì•„ë‹ˆë¼ CSS ë ˆì´ì•„ì›ƒ í¬ê¸°ë¥¼ ê°€ì ¸ì˜´ (ë…¼ë¦¬ì  ì¢Œí‘œê³„ ì‚¬ìš©)
        const container = document.getElementById('game-view');
        const w = container.getBoundingClientRect().width;
        const h = container.getBoundingClientRect().height;

        // ì „ì²´ ì§€ìš°ê¸° (ë…¼ë¦¬ì  í¬ê¸° ê¸°ì¤€)
        ctx.clearRect(0, 0, w, h);
        ctx.save();

        // 1. ë°°ê²½ (í•˜ëŠ˜)
        const skyGrad = ctx.createLinearGradient(0, 0, 0, h);
        skyGrad.addColorStop(0, "#4facfe"); skyGrad.addColorStop(1, "#00f2fe");
        ctx.fillStyle = skyGrad; ctx.fillRect(0, 0, w, h);

        // ì›ê²½ ì‚° (Parallax)
        const mountOffset = state.y * SCALE * 0.1; 
        ctx.save();
        ctx.translate(0, -mountOffset);
        ctx.fillStyle = "#2c5f2d";
        ctx.beginPath(); ctx.moveTo(0, h+300);
        ctx.lineTo(0, h-100); 
        ctx.lineTo(w/3, h-250); ctx.lineTo(w*2/3, h-180); ctx.lineTo(w, h-120);
        ctx.lineTo(w, h+300); ctx.fill();
        ctx.restore();

        // ì¹´ë©”ë¼ ì ìš©
        ctx.translate(w/2, h/2); ctx.scale(state.zoom, state.zoom);
        const charY = state.y * SCALE; const charX = w/2;
        ctx.translate(-charX, -charY);

        // 2. ìˆ²/ë‚˜ë¬´/ë•…
        const groundY = h;
        for (let t of trees) {
            const treeBottom = groundY;
            const treeX = t.x;
            ctx.fillStyle = "#5d4037"; ctx.fillRect(treeX + t.offset, treeBottom - t.h/3, 15, t.h/3);
            ctx.fillStyle = t.t === 0 ? "#2e7d32" : "#1b5e20"; 
            ctx.beginPath(); ctx.moveTo(treeX - 25 + t.offset, treeBottom - t.h/4);
            ctx.lineTo(treeX + 7 + t.offset, treeBottom - t.h);
            ctx.lineTo(treeX + 40 + t.offset, treeBottom - t.h/4);
            ctx.fill();
        }

        // ë°”ë‹¥
        ctx.fillStyle = "#4e342e"; ctx.fillRect(0, groundY, w, 500);
        ctx.fillStyle = "#388e3c"; ctx.fillRect(0, groundY, w, 15);

        // ì í”„ëŒ€
        ctx.fillStyle = "#5d4037"; ctx.fillRect(charX - 70, -25, 140, 25);
        ctx.strokeStyle = "#3e2723"; ctx.lineWidth=2; ctx.strokeRect(charX - 70, -25, 140, 25);

        // í‰í˜•ì 
        const lineY = state.l * SCALE;
        if (state.y > state.l || phase === 4) {
            ctx.save();
            ctx.strokeStyle = "rgba(0, 229, 255, 0.6)"; ctx.lineWidth = 2 / state.zoom; 
            ctx.setLineDash([10, 10]);
            ctx.beginPath(); ctx.moveTo(charX-w, lineY); ctx.lineTo(charX+w, lineY); ctx.stroke();
            ctx.fillStyle = "rgba(0, 229, 255, 0.9)"; ctx.font = "12px Arial";
            ctx.fillText("í‰í˜•ì  (L)", charX + 80, lineY + 4);
            ctx.restore();
        }

        // 3. ì¤„ ê·¸ë¦¬ê¸° (ìì—°ìŠ¤ëŸ¬ìš´ ì½”ì¼ ìŠ¤í”„ë§)
        const isTaut = state.y > state.l;
        ctx.beginPath(); 
        ctx.strokeStyle = "#e0e0e0"; 
        ctx.lineWidth = isTaut ? 3 : 5;
        
        // ì½”ì¼ ê·¸ë¦¬ê¸° (Quadratic Curves)
        const startY = 0;
        const endY = charY - 25; // ë¨¸ë¦¬ ìœ„
        const springLen = endY - startY;
        const coils = 12; // ì½”ì¼ ê°œìˆ˜
        const coilH = springLen / coils;
        const width = isTaut ? 10 : 25; // ëŠ˜ì–´ë‚˜ë©´ í­ì´ ì¢ì•„ì§

        ctx.moveTo(charX, startY);
        for (let i = 0; i < coils; i++) {
            const cy = startY + coilH * i;
            // ì™¼ìª½ìœ¼ë¡œ ë‘¥ê¸€ê²Œ, ì˜¤ë¥¸ìª½ìœ¼ë¡œ ë‘¥ê¸€ê²Œ ë°˜ë³µ
            ctx.quadraticCurveTo(charX - width, cy + coilH/4, charX, cy + coilH/2);
            ctx.quadraticCurveTo(charX + width, cy + coilH*0.75, charX, cy + coilH);
        }
        ctx.stroke();


        // ìºë¦­í„°
        drawCharacter(ctx, charX, charY, state.a, isTaut);
        ctx.restore();
    }

    function drawCharacter(ctx, x, y, a, isTaut) {
        const gForce = Math.abs(a) / G;
        const showBlackout = state.isBlackout; 

        ctx.save(); ctx.translate(x, y);

        // ëª¸í†µ
        ctx.fillStyle = showBlackout ? "#555" : "#ff5722"; 
        ctx.fillRect(-12, -5, 24, 25);
        
        ctx.strokeStyle = showBlackout ? "#555" : "#ff5722"; ctx.lineWidth = 6;
        const armAngle = Math.min(Math.PI/2, gForce * 0.2);
        ctx.beginPath(); ctx.moveTo(-12, 0); ctx.lineTo(-25, -5 - gForce*2); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(12, 0); ctx.lineTo(25, -5 - gForce*2); ctx.stroke();

        // ë¨¸ë¦¬
        ctx.fillStyle = showBlackout ? "#999" : "#ffdbac";
        ctx.beginPath(); ctx.arc(0, -18, 16, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = "#4e342e";
        ctx.beginPath(); ctx.arc(0, -22, 16, Math.PI, Math.PI*2); ctx.fill();

        // í‘œì •
        ctx.fillStyle = "#000";
        if (showBlackout) {
            ctx.font = "bold 16px sans-serif"; ctx.textAlign = "center";
            ctx.fillText("X  X", 0, -16); 
            ctx.beginPath(); ctx.ellipse(0, -8, 3, 5, 0, 0, Math.PI); ctx.stroke(); 
        } else {
            ctx.beginPath(); ctx.arc(-6, -18, 2.5, 0, Math.PI*2); ctx.arc(6, -18, 2.5, 0, Math.PI*2); ctx.fill(); 
            const mouthOpen = Math.min(gForce, 10);
            ctx.beginPath(); ctx.ellipse(0, -8, 4, 2 + mouthOpen/2, 0, 0, Math.PI, false); ctx.stroke(); 
        }

        // HUD
        if (state.isRunning || phase === 4) {
            ctx.font = "bold 14px Pretendard"; ctx.textAlign = "left";
            ctx.fillStyle = "#44ff44"; ctx.fillText(`v=${state.v.toFixed(1)}`, 35, -20);
            if (isTaut) {
                ctx.fillStyle = showBlackout ? "#ff4444" : "#00e5ff";
                ctx.fillText(`${gForce.toFixed(1)} G`, 35, 5);
            }
            drawVector(ctx, 30, -10, 0, state.v * 2, "#44ff44");
            drawVector(ctx, -30, -10, 0, state.a * 3, "#ff4444");
        }
        ctx.restore();
    }

    function drawVector(ctx, x, y, dx, dy, color) {
        if (Math.abs(dy) < 0.5) return;
        ctx.save(); ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + dx, y + dy); ctx.stroke();
        const angle = Math.atan2(dy, dx); const head = 10;
        ctx.beginPath(); ctx.moveTo(x+dx, y+dy);
        ctx.lineTo(x+dx - head * Math.cos(angle-Math.PI/6), y+dy - head * Math.sin(angle-Math.PI/6));
        ctx.lineTo(x+dx - head * Math.cos(angle+Math.PI/6), y+dy - head * Math.sin(angle+Math.PI/6));
        ctx.fill(); ctx.restore();
    }

    // ì´ˆê¸° ì‹¤í–‰
    checkOrientation();
    
    function loop() {
        update(); draw(); requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>