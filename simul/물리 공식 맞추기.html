<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>ë¬¼ë¦¬ ê³µì‹ ì¹ íŒ ë°°í‹€</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

<style>
/* ì¹ íŒ ëŠë‚Œì˜ ì†ê¸€ì”¨ í°íŠ¸ ë¡œë“œ */
@import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Noto+Sans+KR:wght@400;700&display=swap');

:root{
  --chalk-white: #f3f4f6;
  --chalk-yellow: #fde047;
  --chalk-blue: #67e8f9;
  --chalk-red: #fca5a5;
  --chalk-green: #86efac;
  
  /* ìœ ë¦¬ ì§ˆê° (ë‹¤í¬) */
  --glass-bg: rgba(0, 0, 0, 0.45);
  --glass-border: rgba(255, 255, 255, 0.15);
  --shadow: 0 4px 20px rgba(0,0,0,0.5);
}

body {
  margin: 0; padding: 0;
  overflow: hidden;
  font-family: 'Gamja Flower', cursive; /* ë©”ì¸ í°íŠ¸ ë³€ê²½ */
  background-color: #2b3a33;
  color: var(--chalk-white);
  user-select: none;
}

canvas {
  display: block;
  position: absolute;
  top: 0; left: 0;
  z-index: 0;
}

/* UI ë ˆì´ì–´ */
#ui-layer {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 10;
  pointer-events: none;
  display: flex;
  justify-content: space-between;
  padding: 20px;
}

/* === ì¢Œì¸¡: ë­í‚¹ & ì ìˆ˜ === */
.left-panel {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 240px;
  pointer-events: auto;
}

.score-card {
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  padding: 16px;
  border-radius: 12px;
  box-shadow: var(--shadow);
  text-align: center;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.score-section {
  display: flex;
  flex-direction: column;
  align-items: center;
}
.score-divider {
  height: 1px;
  background: rgba(255,255,255,0.15);
  width: 80%;
  margin: 4px auto;
}

.score-label { font-size: 1.2rem; color: #cbd5e1; opacity: 0.8; }
.score-label.small { font-size: 1rem; opacity: 0.7; }

.score-val { 
  font-size: 3.5rem; 
  font-weight: bold; 
  color: var(--chalk-white);
  text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
  line-height: 1;
  margin: 4px 0;
}
.best-score-val {
  font-size: 2rem;
  font-weight: bold;
  color: var(--chalk-yellow);
  text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
  line-height: 1;
  margin: 2px 0;
}

/* í•˜íŠ¸ ìŠ¤íƒ€ì¼ */
.lives-val {
  font-size: 1.8rem;
  color: var(--chalk-red);
  letter-spacing: 4px;
  text-shadow: 0 0 8px rgba(252, 165, 165, 0.6);
  margin-bottom: 4px;
}

.combo-text { 
  font-size: 1.4rem; 
  color: var(--chalk-yellow); 
  animation: pulse 1s infinite; 
  margin-top: 4px;
  min-height: 1.5em; /* ê³µê°„ í™•ë³´ */
}

/* ë­í‚¹ ë³´ë“œ */
.rank-board {
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow);
  flex-grow: 1; /* ë‚¨ì€ ê³µê°„ ì°¨ì§€ */
  max-height: 400px;
  display: flex;
  flex-direction: column;
}
.rank-title {
  font-size: 1.5rem; border-bottom: 1px dashed rgba(255,255,255,0.3);
  padding-bottom: 8px; margin-bottom: 10px;
  display: flex; justify-content: space-between; align-items: center;
}
.rank-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex:1; }
.rank-item {
  display: flex; justify-content: space-between;
  padding: 6px 0;
  font-size: 1.2rem;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.rank-item.top1 { color: var(--chalk-yellow); font-weight: bold; }
.rank-item.me { color: var(--chalk-green); }
.rank-name { max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* [ì‚­ì œë¨] ë‹‰ë„¤ì„ ì…ë ¥ CSS ì œê±°
*/

/* === ìš°ì¸¡: ì •ë‹µí‘œ === */
.right-panel {
  width: 220px;
  background: var(--glass-bg);
  backdrop-filter: blur(8px);
  border: 1px solid var(--glass-border);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--shadow);
  overflow-y: auto;
  pointer-events: auto;
  height: fit-content;
  max-height: 80%;
}
.panel-head { font-size: 1.4rem; color: #e2e8f0; margin-bottom: 12px; border-bottom: 1px dashed rgba(255,255,255,0.3); padding-bottom: 6px; }
.answer-row {
  display: block;
  font-size: 1.15rem;
  padding: 4px 8px;
  margin-bottom: 4px;
  background: rgba(255,255,255,0.05);
  border-radius: 6px;
  color: #cbd5e1;
}
.answer-row.highlight { color: var(--chalk-yellow); background: rgba(255,255,255,0.1); }

/* === í•˜ë‹¨: ì…ë ¥ì°½ === */
.bottom-area {
  position: absolute;
  bottom: 40px;
  left: 50%;
  transform: translateX(-50%);
  width: 100%;
  max-width: 640px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  pointer-events: auto;
}

/* ìƒíƒœ ë°°ì§€ */
.badges { display: flex; gap: 10px; margin-bottom: 4px; }
.badge {
  padding: 4px 12px; border-radius: 20px;
  background: #fff; color: #000;
  font-weight: bold; font-size: 1.1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  display: none; align-items: center; gap: 6px;
}
.bd-x2 { background: var(--chalk-yellow); color: #854d0e; }
.bd-fr { background: var(--chalk-blue); color: #164e63; }
.bd-sh { background: var(--chalk-green); color: #14532d; }

/* ë©”ì‹œì§€ ë°•ìŠ¤ */
#msg-box {
  font-size: 1.5rem;
  color: #fff;
  text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  min-height: 1.6em;
  text-align: center;
}

/* ì…ë ¥ì°½ wrapper */
.input-container {
  position: relative;
  width: 100%;
  padding: 0 20px;
  box-sizing: border-box;
}

#ans {
  width: 100%;
  padding: 14px 24px;
  font-size: 1.8rem;
  font-family: 'Gamja Flower', cursive; /* ì…ë ¥ì°½ë„ ì†ê¸€ì”¨ í°íŠ¸ */
  border: 3px solid rgba(255,255,255,0.5);
  border-radius: 100px; /* ë‘¥ê·¼ ìº¡ìŠí˜• */
  background: rgba(40, 40, 40, 0.85);
  backdrop-filter: blur(10px);
  color: #fff;
  text-align: center;
  outline: none;
  box-shadow: 0 10px 30px rgba(0,0,0,0.4);
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
}
#ans::placeholder { color: rgba(255,255,255,0.4); font-size: 1.4rem; }
#ans:focus {
  border-color: var(--chalk-blue);
  background: rgba(50, 50, 50, 0.95);
  transform: scale(1.02);
  box-shadow: 0 15px 40px rgba(103, 232, 249, 0.2);
}

@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }
@keyframes shake { 
  0% { transform: translateX(0); } 25% { transform: translateX(-5px); }
  50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); }
}
.shake { animation: shake 0.3s ease-in-out; }

/* ë””ë²„ê·¸ ë¡œê·¸ (ì‘ê²Œ í‘œì‹œ) */
#debug-log {
  position: absolute; top: 0; left: 0; 
  width: 100%; padding: 4px;
  background: rgba(0,0,0,0.5); color: #fff;
  font-size: 10px; z-index: 9999;
  text-align: center; pointer-events: none;
}

/* === Game Over Overlay === */
#game-over-layer {
  position: absolute; top:0; left:0; right:0; bottom:0;
  background: rgba(0,0,0,0.85);
  z-index: 200;
  display: none; /* JSì—ì„œ flexë¡œ ë³€ê²½ */
  justify-content: center; align-items: center;
  backdrop-filter: blur(8px);
  pointer-events: auto;
}
.game-over-box {
  background: rgba(30, 41, 59, 0.95);
  border: 4px solid var(--chalk-red);
  padding: 50px 80px;
  border-radius: 24px;
  text-align: center;
  box-shadow: 0 0 50px rgba(252, 165, 165, 0.3);
  animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
@keyframes popIn { 0%{transform:scale(0.8);opacity:0;} 100%{transform:scale(1);opacity:1;} }

.go-title {
  font-size: 4rem; color: var(--chalk-red); font-weight: bold; margin-bottom: 20px;
  font-family: 'Gamja Flower', cursive;
  text-shadow: 4px 4px 0px rgba(0,0,0,0.5);
}
.go-score {
  font-size: 2.5rem; color: #fff; margin-bottom: 40px;
  font-family: 'Gamja Flower', cursive;
}
.restart-btn {
  background: var(--chalk-white); color: #1e293b;
  border: none; padding: 12px 32px; font-size: 1.5rem;
  border-radius: 50px; cursor: pointer; font-weight: bold;
  font-family: 'Gamja Flower', cursive;
  transition: transform 0.2s, box-shadow 0.2s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.restart-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(255,255,255,0.4); }

</style>
</head>
<body>

<div id="debug-log">ì‹œìŠ¤í…œ ì¤€ë¹„ì¤‘...</div>

<div id="game-over-layer">
  <div class="game-over-box">
    <div class="go-title">GAME OVER</div>
    <div class="go-score">ìµœì¢… ì ìˆ˜: <span id="final-score">0</span></div>
    <button class="restart-btn" onclick="location.reload()">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
  </div>
</div>

<div id="ui-layer">
  <div class="left-panel">
    <div class="score-card">
      <div class="score-section">
        <div class="score-label">í˜„ì¬ ì ìˆ˜</div>
        <div class="score-val" id="score">0</div>
      </div>
      <div class="score-section" style="margin-bottom:4px;">
        <div class="score-label small">ë‚¨ì€ ê¸°íšŒ</div>
        <div class="lives-val" id="lives-val">â¤â¤â¤</div>
      </div>
      <div class="score-divider"></div>
      <div class="score-section">
        <div class="score-label small">ë‚´ ìµœê³  ê¸°ë¡</div>
        <div class="best-score-val" id="best-score-val">0</div>
      </div>
      <div class="combo-text" id="combo-ui">0 COMBO</div>
    </div>
    
    <div class="rank-board">
      <div class="rank-title">
        <span>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span>
        <span style="font-size:0.9rem; opacity:0.7">Top 5</span>
      </div>
      <ul class="rank-list" id="rank-list">
        <li style="text-align:center; padding:20px; opacity:0.5">ë¡œë”©ì¤‘...</li>
      </ul>
      </div>
  </div>

  <div class="right-panel">
    <div class="panel-head">ğŸ“˜ ì¡±ë³´ (ì •ë‹µ ëª©ë¡)</div>
    <div id="answers-container"></div>
  </div>

  <div class="bottom-area">
    <div class="badges">
      <div class="badge bd-x2" id="bd-x2">âš¡ ì ìˆ˜ 2ë°°</div>
      <div class="badge bd-fr" id="bd-fr">â„ï¸ ì‹œê°„ ì •ì§€</div>
      <div class="badge bd-sh" id="bd-sh">ğŸ›¡ï¸ ë³´í˜¸ë§‰ ON</div>
    </div>
    <div id="msg-box">ê³µì‹ì´ ë–¨ì–´ì§€ë©´ ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”!</div>
    <div class="input-container">
      <input id="ans" type="text" placeholder="ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
    </div>
  </div>
</div>

<script>
/* =========================================
   ê²Œì„ ë°ì´í„°
   ========================================= */
const FORMULAS = [
  {formula:"v = vâ‚€ + at",             answer:"ì†ë ¥ ê³µì‹",      diff:1},
  {formula:"x = xâ‚€ + vâ‚€t + Â½atÂ²",     answer:"ë“±ê°€ì†ë„ ê³µì‹",  diff:2},
  {formula:"F = ma",                  answer:"ë‰´í„´ ì œ2ë²•ì¹™",   diff:1},
  {formula:"p = mv",                  answer:"ìš´ë™ëŸ‰",        diff:1},
  {formula:"FÎ”t = Î”p",                answer:"ì¶©ê²©ëŸ‰",        diff:2},
  {formula:"W = Fd",                  answer:"ì¼",            diff:1},
  {formula:"K = Â½mvÂ²",                answer:"ìš´ë™ ì—ë„ˆì§€",    diff:1},
  {formula:"U = mgh",                 answer:"í¼í…ì…œ ì—ë„ˆì§€",  diff:2},
  {formula:"E = K + U",               answer:"ì—­í•™ì  ì—ë„ˆì§€",  diff:2},
  {formula:"a = vÂ² / r",              answer:"êµ¬ì‹¬ ê°€ì†ë„",    diff:2},
  {formula:"F = mvÂ² / r",             answer:"êµ¬ì‹¬ë ¥",        diff:2},
  {formula:"v = rÏ‰",                  answer:"ì„ ì†ë„",        diff:2},
  {formula:"Ï‰ = 2Ï€ / T",              answer:"ê°ì†ë„",        diff:2},
  {formula:"v = fÎ»",                  answer:"íŒŒë™ ì†ë ¥",     diff:1},
  {formula:"f = 1 / T",               answer:"ì§„ë™ìˆ˜",        diff:1},
  {formula:"y = A sin(Ï‰t)",           answer:"ë‹¨ìˆœ ì¡°í™” ìš´ë™", diff:3},
  {formula:"n = c / v",               answer:"êµ´ì ˆë¥ ",        diff:2},
  {formula:"nâ‚sinÎ¸â‚ = nâ‚‚sinÎ¸â‚‚",       answer:"ìŠ¤ë„¬ì˜ ë²•ì¹™",    diff:2},
  {formula:"sinÎ¸c = nâ‚‚ / nâ‚",         answer:"ì„ê³„ê°",        diff:3},
  {formula:"V = IR",                  answer:"ì˜´ì˜ ë²•ì¹™",      diff:1},
  {formula:"P = VI",                  answer:"ì „ë ¥",          diff:1},
  {formula:"Q = It",                  answer:"ì „í•˜ëŸ‰",        diff:1}
];

const ITEMS = [
  { type:"x2", title:"ì ìˆ˜ 2ë°°", answer:"ì ìˆ˜ 2ë°°", color:"#fde047", duration:10000 },
  { type:"freeze", title:"ì‹œê°„ ì •ì§€", answer:"ì‹œê°„ ì •ì§€", color:"#67e8f9", duration:5000 },
  { type:"shield", title:"ë³´í˜¸ë§‰", answer:"ë³´í˜¸ë§‰", color:"#86efac", duration:10000 }
];

/* =========================================
   ê²Œì„ ë³€ìˆ˜
   ========================================= */
let drops = [];
let particles = [];
let score = 0;
let combo = 0;
let lastSpawnTime = 0;
let shakeTime = 0; 

let effectUntil = { x2:0, freeze:0, shield:0 };
let shieldCount = 0;

let speedMultiplier = 1.0;
let spawnRate = 2000;

let lives = 3;
let isGameOver = false;

window.myBestScore = 0; 

/* =========================================
   P5.js
   ========================================= */
function setup(){
  createCanvas(windowWidth, windowHeight);
  
  const inp = document.getElementById("ans");
  inp.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") checkAnswer();
  });
  
  document.body.addEventListener("click", (e)=>{
    if(e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT"){
      inp.focus();
    }
  });
  
  inp.focus();
  
  const ansCon = document.getElementById("answers-container");
  FORMULAS.sort((a,b)=>a.answer.localeCompare(b.answer)).forEach(f=>{
    const d = document.createElement("div");
    d.className = "answer-row";
    d.textContent = f.answer;
    ansCon.appendChild(d);
  });

  updateLivesUI();
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
}

function draw(){
  drawBlackboard();
  
  if(isGameOver) return;

  if(shakeTime > 0){
    const mag = map(shakeTime, 0, 15, 0, 6);
    translate(random(-mag, mag), random(-mag, mag));
    shakeTime--;
  }

  const now = millis();
  
  // ì†ë„ ìƒí•œ ì œê±°
  speedMultiplier = 0.5 + (score / 2000); 
  spawnRate = Math.max(500, 2500 - (score / 2));

  if(now > effectUntil.freeze){
    if(now - lastSpawnTime > spawnRate){
      spawnDrop();
      lastSpawnTime = now;
    }
  }

  const deadZone = height - 100;
  
  for(let i=drops.length-1; i>=0; i--){
    let d = drops[i];
    
    if(now > effectUntil.freeze){
      d.y += d.speed * speedMultiplier * (deltaTime/16);
    }
    
    drawDrop(d);
    
    if(d.y > deadZone){
      if(d.isItem){
        uiMsg("bad", "ì•„ì´í…œì„ ë†“ì³¤ì–´ìš” ã… ã… ");
      } else {
        if(shieldCount > 0 && now < effectUntil.shield){
          shieldCount--;
          uiMsg("good", "ğŸ›¡ï¸ ë³´í˜¸ë§‰ì´ ë°©ì–´í–ˆìŠµë‹ˆë‹¤!");
          spawnParticles(d.x, deadZone, 10, "#86efac"); 
        } else {
          // ìƒëª… ê°ì†Œ
          lives--;
          updateLivesUI();
          
          score = Math.max(0, score - 20);
          combo = 0;
          shakeTime = 15;
          spawnParticles(d.x, deadZone, 20, "#fca5a5");

          if(lives <= 0){
            gameOver();
          } else {
            uiMsg("bad", `ë†“ì³¤ìŠµë‹ˆë‹¤! ì •ë‹µ: ${d.answer}`);
          }
        }
      }
      drops.splice(i, 1);
      updateUI();
    }
  }

  for(let i=particles.length-1; i>=0; i--){
    let p = particles[i];
    p.life -= 2;
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.1; 
    
    noStroke();
    fill(p.r, p.g, p.b, p.life * 2.5);
    circle(p.x, p.y, p.size);
    
    if(p.life <= 0) particles.splice(i,1);
  }

  updateBadgeUI(now);
}

function gameOver(){
  isGameOver = true;
  if(score > window.myBestScore){
    window.myBestScore = score;
    if(window.saveBestScore) window.saveBestScore(window.myBestScore);
  }
  document.getElementById("final-score").textContent = score;
  document.getElementById("game-over-layer").style.display = "flex";
  document.getElementById("ans").blur();
}

function updateLivesUI(){
  const el = document.getElementById("lives-val");
  let str = "";
  for(let i=0; i<lives; i++) str += "â¤";
  el.textContent = str;
  if(lives <= 1) el.style.color = "#ef4444"; 
  else el.style.color = "var(--chalk-red)";
}

function drawBlackboard(){
  background(43, 66, 56);
  noStroke();
  fill(255, 255, 255, 15);
  ellipse(width*0.2, height*0.3, 400, 200);
  ellipse(width*0.7, height*0.6, 500, 300);
  strokeWeight(60);
  stroke(20, 30, 25, 100);
  noFill();
  rect(0,0,width,height);
  noStroke();
}

function drawDrop(d){
  push();
  translate(d.x, d.y);
  rectMode(CENTER);

  fill(0,0,0,50);
  noStroke();
  rect(3, 3, d.w, d.h, 6);
  
  if(d.isItem){
    stroke(255);
    strokeWeight(1);
    fill(d.color);
    rect(0, 0, d.w, d.h, 6);
    fill(50);
    textAlign(CENTER, CENTER);
    textSize(20);
    text(`ğŸ ${d.title}`, 0, 0);
  } else {
    stroke(255, 255, 255, 200);
    strokeWeight(2);
    noFill();
    rect(0, 0, d.w, d.h, 6);
    noStroke();
    fill(255);
    textAlign(CENTER, CENTER);
    textSize(24);
    text(d.formula, 0, -5);
    fill(255, 255, 255, 150);
    let dots = "â€¢".repeat(d.diff);
    textSize(14);
    text(dots, 0, 18);
  }
  pop();
}

function spawnDrop(){
  const isItem = random() < 0.1;
  let safeLeft = 320;
  let safeRight = width - 300;
  if(safeLeft >= safeRight){ safeLeft = width/2 - 20; safeRight = width/2 + 20; }
  
  const spawnX = random(safeLeft, safeRight);
  
  if(isItem){
    const item = random(ITEMS);
    drops.push({
      isItem: true, ...item,
      x: spawnX, y: -50, w: 160, h: 50, speed: 1.5, color: item.color
    });
  } else {
    const f = random(FORMULAS);
    drops.push({
      isItem: false, ...f,
      x: spawnX, y: -50,
      w: textWidth(f.formula)*1.2 + 60, h: 60,
      speed: 1.0 + (f.diff * 0.2)
    });
  }
}

function spawnParticles(x, y, count, colorHex){
  const c = color(colorHex);
  for(let i=0; i<count; i++){
    particles.push({
      x: x, y: y,
      vx: random(-3, 3), vy: random(-4, 1),
      life: 100, size: random(3, 8),
      r: red(c), g: green(c), b: blue(c)
    });
  }
}

/* =========================================
   ê²Œì„ ë¡œì§
   ========================================= */
function checkAnswer(){
  if(isGameOver) return; 

  const inp = document.getElementById("ans");
  const rawVal = inp.value.trim();
  if(!rawVal) return;
  const val = rawVal.replace(/\s+/g, "");

  let hitIdx = -1;
  let maxY = -9999;
  
  for(let i=0; i<drops.length; i++){
    if(!drops[i].answer) continue;
    const dropAns = drops[i].answer.replace(/\s+/g, "");
    if(dropAns === val && drops[i].y > maxY){
      maxY = drops[i].y;
      hitIdx = i;
    }
  }
  
  if(hitIdx !== -1){
    const d = drops[hitIdx];
    drops.splice(hitIdx, 1);
    
    if(d.isItem){
      applyItem(d);
      uiMsg("good", `ì•„ì´í…œ íšë“: ${d.title}`);
      spawnParticles(d.x, d.y, 15, d.color);
    } else {
      combo++;
      let bonus = Math.min(20, (combo-1)*5);
      let add = 20 + bonus;
      if(millis() < effectUntil.x2) add *= 2;
      
      score += add;
      uiMsg("good", `ì •ë‹µ! +${add}`);
      spawnParticles(d.x, d.y, 25, "#f3f4f6");
      
      if(score > window.myBestScore) {
        window.myBestScore = score;
        updateBestScoreUI();
        if(window.saveBestScore) window.saveBestScore(window.myBestScore);
      }
    }
  } else {
    combo = 0;
    score = Math.max(0, score - 10);
    shakeTime = 10;
    uiMsg("bad", "í‹€ë ¸ìŠµë‹ˆë‹¤!");
    const el = document.querySelector(".input-container");
    el.classList.remove("shake");
    void el.offsetWidth;
    el.classList.add("shake");
  }
  inp.value = "";
  updateUI();
}

function applyItem(item){
  const now = millis();
  if(item.type === "x2") effectUntil.x2 = now + item.duration;
  if(item.type === "freeze") effectUntil.freeze = now + item.duration;
  if(item.type === "shield") {
    effectUntil.shield = now + item.duration;
    shieldCount = 1;
  }
}

function updateUI(){
  document.getElementById("score").textContent = score;
  document.getElementById("combo-ui").textContent = combo > 1 ? `${combo} COMBO!` : "";
  document.getElementById("combo-ui").style.opacity = combo > 1 ? 1 : 0;
}

function updateBestScoreUI(){
  const el = document.getElementById("best-score-val");
  if(el) el.textContent = window.myBestScore;
}

function updateBadgeUI(now){
  document.getElementById("bd-x2").style.display = (now < effectUntil.x2) ? "flex" : "none";
  document.getElementById("bd-fr").style.display = (now < effectUntil.freeze) ? "flex" : "none";
  const shEl = document.getElementById("bd-sh");
  if(shieldCount > 0 && now < effectUntil.shield){
    shEl.style.display = "flex";
    shEl.textContent = `ğŸ›¡ï¸ ë³´í˜¸ë§‰ (${shieldCount})`;
  } else {
    shEl.style.display = "none";
  }
}

function uiMsg(type, text){
  const box = document.getElementById("msg-box");
  box.textContent = text;
  box.style.color = type === "good" ? "var(--chalk-green)" : "var(--chalk-red)";
  box.style.transform = "scale(1.2)";
  setTimeout(()=> box.style.transform = "scale(1)", 200);
}

window.logDebug = function(msg) {
  const el = document.getElementById("debug-log");
  if(el) el.textContent = msg;
  console.log("[DEBUG]", msg);
};

/* =========================================
   UI í•¸ë“¤ë§ (ë‹‰ë„¤ì„ ë“±)
   ========================================= */
// ë‹‰ë„¤ì„ ìë™ ìƒì„± (ìˆ˜ì • ê¸°ëŠ¥ ì‚­ì œë¨)
window.myNickname = "í•™ìƒ" + Math.floor(Math.random()*1000);



window.updateRankingBoard = function(rankData) {
  const list = document.getElementById("rank-list");
  list.innerHTML = "";
  if(!rankData || rankData.length === 0){
    list.innerHTML = "<li style='padding:10px; opacity:0.6'>ê¸°ë¡ ì—†ìŒ</li>";
    return;
  }
  rankData.forEach((item, index) => {
    const li = document.createElement("li");
    li.className = "rank-item";
    if(index === 0) li.classList.add("top1");
    if(item.name === window.myNickname) li.classList.add("me");
    li.innerHTML = `
      <span class="rank-name">${index+1}. ${item.name}</span>
      <span>${item.score}</span>
    `;
    list.appendChild(li);
  });
};

window.setInitialBestScore = function(val) {
  window.myBestScore = val || 0;
  updateBestScoreUI();
  window.logDebug(`ìµœê³ ì ìˆ˜ ë¡œë“œë¨: ${window.myBestScore}`);
};
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDoc, collectionGroup, onSnapshot,
  query, orderBy, limit, where
} from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // ì‚¬ìš©ìê°€ ì œê³µí•œ Config
  const firebaseConfig = {
    apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
    authDomain: "simulation-67cd3.firebaseapp.com",
    projectId: "simulation-67cd3",
    storageBucket: "simulation-67cd3.appspot.com",
    messagingSenderId: "615983461615",
    appId: "1:615983461615:web:002e07bcea878eb6d5571a",
    measurementId: "G-9RGN7LYE5W"
  };
  
  // App ID ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸° (Canvas í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” Fallback)
  // *ì£¼ì˜: ì‚¬ìš©ìì˜ 'í† í¬ì™€ í‰í˜•.html'ì´ ì‘ë™í•˜ëŠ” ì´ìœ ëŠ” ì˜¬ë°”ë¥¸ AppIDë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì¼ ìˆ˜ ìˆìŒ.
  // ì—¬ê¸°ì„œëŠ” ì•ˆì „í•œ 'default-app-id'ë¥¼ ì‚¬ìš©í•˜ë˜, Canvas ë°–ì´ë©´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì²˜ëŸ¼ ì‘ë™í•  ìˆ˜ ìˆìŒ.
  const appId = typeof __app_id !== 'undefined' ? __app_id : "default-app-id";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  const SIM_ID = "ê³µì‹_íƒ€ì´í•‘";
  let isRankingListening = false; 

// âœ… ì´ë¯¸ ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ìˆìœ¼ë©´ ìœ ì§€.
// âœ… ì•„ë¬´ë„ ë¡œê·¸ì¸ ì•ˆ ëœ ìƒíƒœì¼ ë•Œë§Œ(Top5 ì¡°íšŒ ëª©ì ) ìµëª… ë¡œê·¸ì¸
async function ensureAuthIfNeeded(user) {
  if (user) return; // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœë©´ ì ˆëŒ€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

  try {
    if (window.logDebug) window.logDebug("ë¡œê·¸ì¸ ì—†ìŒ â†’ Top5ìš© ìµëª… ë¡œê·¸ì¸ ì‹œë„...");
    await signInAnonymously(auth);
  } catch (e) {
    if (window.logDebug) window.logDebug("ìµëª… ë¡œê·¸ì¸ ì‹¤íŒ¨(ê·œì¹™/í™˜ê²½): " + e.code);
    console.warn("Anonymous sign-in failed:", e);
  }
}

  // 2. ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œê·¸ì¸ ìƒê´€ì—†ì´ ì‹œë„)
async function fetchUserId(uid){
  try{
    const uref = doc(db, "users", uid);
    const usnap = await getDoc(uref);
    if(usnap.exists()){
      const u = usnap.data() || {};
      return u.ID || u.userId || "";
    }
  }catch(e){}
  return "";
}

function loadRanking() {
  if (isRankingListening) return;
  isRankingListening = true;

  const sims = collectionGroup(db, "simulations");

  // âœ… simId í•„í„° ì œê±° â†’ ê¸°ì¡´ ë°ì´í„°ë„ ì¡í˜
  const q = query(
    sims,
    orderBy("score", "desc"),
    limit(300) // ìœ ì € ìˆ˜ì— ë§ì¶° 200~1000 ì •ë„
  );

  onSnapshot(q, async (snapshot) => {
    const rows = [];

snapshot.forEach((snap) => {
  const data = snap.data() || {};

  // âœ… í•œê¸€ docId ë¹„êµëŠ” ì •ê·œí™”í•´ì„œ ë¹„êµ (NFC)
  const docId = (snap.id || "").normalize("NFC");
  const target = (SIM_ID || "").normalize("NFC");

  // âœ… ê¸°ì¡´ ë¬¸ì„œ(=simId ì—†ìŒ)ëŠ” docIdë¡œ, ìƒˆ ë¬¸ì„œ(=simId ìˆìŒ)ëŠ” simIdë¡œë„ í†µê³¼
  const simIdField = (data.simId || "").normalize("NFC");
  if (docId !== target && simIdField !== target) return;

  const uid = snap.ref.parent?.parent?.id || "";

  rows.push({
    uid,
    score: Number(data.score || 0),
    localName: data.playerId || data.ID || data.userId || data.nickname || ""
  });
});

    // Top5ë§Œ ë½‘ê¸°
    rows.sort((a,b)=>b.score-a.score);
    const top5 = rows.slice(0,5);

    // publicProfilesì—ì„œ ID ê°€ì ¸ì˜¤ê¸° (ìˆìœ¼ë©´)
    const ids = await Promise.all(top5.map(x => fetchPublicId(x.uid)));
    const finalTop5 = top5.map((x,i)=>({
      uid: x.uid,
      score: x.score,
      name: ids[i] || x.localName || ("UID-" + x.uid.slice(0,5))
    }));

    updateRankingBoard(finalTop5);
  }, (err) => {
    console.warn("Ranking Load Error:", err.code, err.message);
    isRankingListening = false;
  });
}
  // 3. ê°œì¸ ìµœê³  ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadMyBestScore() {
    if(!currentUser) return;
 // âœ… ìµëª…ì€ ë‚´ ìµœê³ ì ìˆ˜ í‘œì‹œ ì•ˆ í•¨(0 ë˜ëŠ” â€œë¡œê·¸ì¸ í•„ìš”â€ ì²˜ë¦¬)
  if (currentUser.isAnonymous) {
    if(window.setInitialBestScore) window.setInitialBestScore(0);
    if(window.logDebug) window.logDebug("ìµëª…: ë‚´ ìµœê³ ì ìˆ˜ëŠ” ë¡œê·¸ì¸ í›„ í™•ì¸ ê°€ëŠ¥");
    return;
  }
const docRef = doc(db, "users", currentUser.uid, "simulations", SIM_ID);
    
    try {
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        const score = data.score || 0;
        if(window.setInitialBestScore) window.setInitialBestScore(score);
      } else {
        if(window.setInitialBestScore) window.setInitialBestScore(0);
      }
    } catch (err) {
      if(window.logDebug) window.logDebug("ì ìˆ˜ ë¡œë“œ ì‹¤íŒ¨: " + err.code);
      console.error("Load Best Score Error:", err);
    }
  }

  // 4. ì ìˆ˜ ì €ì¥
window.saveBestScore = async function(score) {
  if(!currentUser) return;

  if (currentUser.isAnonymous) {
    uiMsg("bad", "ë¡œê·¸ì¸ í›„ì—ë§Œ ê¸°ë¡ì´ ì €ì¥ë¼ìš”!");
    return;
  }

  const nickname = (window.myNickname || "í•™ìƒ").trim();
  const privateRef = doc(db, "users", currentUser.uid, "simulations", SIM_ID);

 let playerId = "";
try {
  const usnap = await getDoc(doc(db, "users", currentUser.uid));
  if (usnap.exists()) {
    const u = usnap.data() || {};
    playerId = u.ID || u.userId || "";
  }
} catch (e) {}

await setDoc(privateRef, {
  simId: SIM_ID,
  score,
  nickname,
  playerId,
  updatedAt: Date.now()
}, { merge: true });

// âœ… ì¶”ê°€: ì ìˆ˜ ì €ì¥í•  ë•Œ ê³µê°œ í”„ë¡œí•„ë„ ê°™ì´ ê°±ì‹  (Top5ì— ì¦‰ì‹œ ID í‘œì‹œ)
if (playerId) {
  await setDoc(doc(db, "publicProfiles", currentUser.uid), {
    ID: playerId,
    updatedAt: Date.now()
  }, { merge: true });
}
};
  // 5. ë­í‚¹ ë³´ë“œ ì—…ë°ì´íŠ¸
  window.saveScoreToLeaderboard = async function(nickname, score) {
    if(!currentUser) return;
const leaderboardRef = doc(db, "leaderboard", currentUser.uid);
    try {
      await setDoc(leaderboardRef, {
        name: nickname,
        score: score,
        uid: currentUser.uid,
        updatedAt: Date.now()
      });
    } catch(e) { console.error(e); }
  };

async function upsertPublicProfile() {
  if (!currentUser || currentUser.isAnonymous) return;

  try {
    // 1) ë‚´ users/{uid} ë¬¸ì„œì—ì„œ ID ì½ê¸°
    const usnap = await getDoc(doc(db, "users", currentUser.uid));
    if (!usnap.exists()) return;

    const u = usnap.data() || {};
    const playerId = u.ID || u.userId || "";
    if (!playerId) return;

    // 2) ê³µê°œ í”„ë¡œí•„ publicProfiles/{uid}ì— ID ì €ì¥
    await setDoc(doc(db, "publicProfiles", currentUser.uid), {
      ID: playerId,
      updatedAt: Date.now()
    }, { merge: true });

    if (window.logDebug) window.logDebug("publicProfiles ê°±ì‹ : " + playerId);
  } catch (e) {
    console.warn("upsertPublicProfile error:", e);
  }
}
async function fetchPublicId(uid) {
  try {
    const psnap = await getDoc(doc(db, "publicProfiles", uid));
    if (psnap.exists()) {
      const p = psnap.data() || {};
      return p.ID || "";
    }
  } catch (e) {}
  return "";
}

  // 6. ë¦¬ìŠ¤ë„ˆ ì„¤ì •
  loadRanking(); // ì•± ì‹œì‘ ì‹œ ë°”ë¡œ ì‹œë„

onAuthStateChanged(auth, async (user) => {
  // 1) ë¡œê·¸ì¸ ìœ ì§€ or (ì—†ìœ¼ë©´) ìµëª… ì‹œë„
  await ensureAuthIfNeeded(user);

  // 2) ensureAuthIfNeededê°€ ìµëª… ë¡œê·¸ì¸ì„ ì„±ê³µì‹œí‚¤ë©´, auth.currentUserê°€ ìƒê¹€
  currentUser = auth.currentUser;

  if (currentUser) {
if (window.logDebug) window.logDebug(
  "AUTH: " + (currentUser.isAnonymous ? "ìµëª…" : "ë¡œê·¸ì¸") + " / " + currentUser.uid.slice(0,5)
);
    await loadMyBestScore();   // ìµëª…ì€ ë‚´ë¶€ì—ì„œ 0 ì²˜ë¦¬ë˜ë„ë¡ ì´ë¯¸ ë§Œë“¤ì–´ë‘ 
    await upsertPublicProfile(); 

  } else {
    if (window.logDebug) window.logDebug("AUTH: ì—†ìŒ (ë­í‚¹ë§Œ ì‹œë„)");
  }

  loadRanking(); // Top5ëŠ” ë¡œê·¸ì¸/ìµëª…/ë¬´ë¡œê·¸ì¸ ì •ì±…ì— ë”°ë¼ ì½í˜
});

</script>

</body>
</html>