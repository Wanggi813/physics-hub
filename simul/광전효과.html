<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê´‘ì „íš¨ê³¼</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <style>
    :root{
      --bg:#f9fafb; --card:#ffffff; --border:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0; padding:0; height: 100%;
      background: radial-gradient(circle at top,#dbeafe 0,#f9fafb 55%);
      color:var(--ink);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",system-ui,sans-serif;
      overscroll-behavior: none; /* ëª¨ë°”ì¼ ìƒˆë¡œê³ ì¹¨ ë°©ì§€ */
    }

    /* === ë ˆì´ì•„ì›ƒ ê³µí†µ === */
    .wrap{
      max-width:1200px; margin:20px auto 40px; padding:0 16px;
    }
    h1{ margin:0 0 4px; font-size:24px; display:flex; align-items:center; gap:8px; }
    h1 span.badge{ font-size:11px; padding:3px 8px; border-radius:999px; background:rgba(59,130,246,0.06); border:1px solid rgba(59,130,246,0.25); color:#1d4ed8; }
    .subtitle{ font-size:12px; color:var(--muted); margin-bottom:14px; }
    
    /* ë°ìŠ¤í¬íƒ‘ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
    .grid{ display:grid; grid-template-columns:minmax(260px,340px) minmax(480px,1fr); gap:16px; align-items:start; }

    /* íŒ¨ë„ ë””ìì¸ */
    .panel, .card {
      background:var(--card); border-radius:18px; border:1px solid var(--border);
      box-shadow:0 18px 40px rgba(15,23,42,0.08); padding:14px;
    }
    .panel h2{ margin:0 0 6px; font-size:17px; }
    
    /* ì…ë ¥ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    .row{ display:grid; grid-template-columns:100px 1fr 60px; gap:6px; align-items:center; margin:6px 0; }
    .row label{ font-size:12px; color:var(--muted); }
    input[type="range"]{ width:100%; }
    select, .out{ font-size:12px; border-radius:999px; border:1px solid var(--border); padding:5px 7px; background:#f9fafb; text-align:center; font-variant-numeric:tabular-nums; }
    .out{ background:#eff6ff; color:#1d4ed8; }
    
    /* ê²°ê³¼ê°’ í‘œì‹œ */
    .readout{ display:grid; grid-template-columns:repeat(2,1fr); gap:6px; margin-top:8px; font-size:11px; }
    .readout-item{ background:#eef2ff; border-radius:12px; padding:5px 8px; border:1px solid #e0e7ff; }
    .readout-key{ color:var(--muted); font-size:10px; }
    .readout-val{ font-weight:600; }
    
    /* ìƒíƒœ ì¹© */
    .statusChip{ display:inline-flex; align-items:center; gap:4px; padding:4px 9px; border-radius:999px; font-size:11px; margin-top:8px; border:1px solid transparent; }
    .statusChip.off{ background:#f3f4f6; color:#6b7280; border-color:#e5e7eb; }
    .statusChip.emit{ background:#dcfce7; color:#166534; border-color:#86efac; }
    .statusChip.stop{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }

    /* ì‹œë®¬ë ˆì´ì…˜ ì»¨í…Œì´ë„ˆ */
    #sim-holder{ width:100%; min-height:500px; border-radius: 12px; overflow: hidden; }

    /* ë„ì „ ëª¨ë“œ ìŠ¤íƒ€ì¼ */
    .challenge-group{ margin-top:10px; padding:10px 12px; border-radius:14px; border:1px dashed #d4d4d8; background:#faf5ff; font-size:13px; }
    .chip-btn{ display:inline-flex; align-items:center; justify-content:center; padding:6px 12px; border-radius:999px; border:1px solid #e5e7eb; background:#ffffff; font-size:12px; cursor:pointer; gap:4px; }
    .bestScoreBox{ display:flex; align-items:center; gap:4px; font-size:13px; font-weight:600; }
    .bestValue{ font-size:18px; font-weight:700; color:#ffb300; text-shadow:0 0 6px rgba(255,190,0,0.8); }
    .input-row{ margin-top:4px; display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    .input-row input[type="number"]{ border-radius:999px; border:1px solid #d4d4d8; padding:4px 8px; font-size:12px; width:90px; }

    /* =========================================
       â˜… ëª¨ë°”ì¼ ìµœì í™” (Split View) CSS â˜…
       ========================================= */
    @media (max-width: 768px) {
      body { overflow: hidden; } /* ì „ì²´ ìŠ¤í¬ë¡¤ ë°©ì§€ */

      /* 1. ìƒë‹¨ ê³ ì • ì˜ì—­: ì‹œë®¬ë ˆì´ì…˜ (45%) */
      #fixed-sim-area {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 45vh; /* í™”ë©´ì˜ 45% */
        background: #f0f9ff;
        z-index: 5;
        border-bottom: 1px solid #cbd5e1;
      }
      #sim-holder {
        width: 100% !important;
        height: 100% !important;
        min-height: auto !important; /* ê¸°ì¡´ min-height ë¬´ì‹œ */
        border-radius: 0;
      }
      /* P5 ìº”ë²„ìŠ¤ê°€ ì´ ì•ˆì—ì„œ ê½‰ ì°¨ê²Œ ë Œë”ë§ë¨ */
      #sim-holder canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
      }

      /* 2. í•˜ë‹¨ ìŠ¤í¬ë¡¤ ì˜ì—­: UI (55%) */
      #scroll-ui-area {
        position: fixed;
        top: 45vh;
        left: 0;
        width: 100%;
        height: 55vh;
        overflow-y: auto; /* ì„¸ë¡œ ìŠ¤í¬ë¡¤ */
        background: #f9fafb;
        padding: 10px 0 60px 0; /* í•˜ë‹¨ ì—¬ë°± í™•ë³´ */
        z-index: 10;
      }

      /* ë‚´ë¶€ ìš”ì†Œ ìŠ¤íƒ€ì¼ ì¡°ì • */
      .wrap { margin: 0; padding: 0; max-width: none; }
      
      /* í—¤ë” ìˆ¨ê¸°ê±°ë‚˜ ê°„ì†Œí™” */
      h1, .subtitle, .brand { display: none; } 
      
      /* íŒ¨ë„ê³¼ ë„ì „ë°•ìŠ¤ë¥¼ ë¸”ë¡ìœ¼ë¡œ ë°°ì¹˜ */
      .grid { display: block; padding: 0 10px; }
      .panel, .card, .challenge-group {
        margin-bottom: 12px;
        width: 100%;
        border-radius: 12px;
      }
      .card { 
        padding: 0; border: none; box-shadow: none; background: transparent; 
      }
      
      /* í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì ˆ */
      .panel h2 { font-size: 15px; font-weight: 700; color: #334155; }
    }
  </style>
</head>
<body>

<div id="fixed-sim-area">
  <div id="sim-holder"></div>
</div>

<div id="scroll-ui-area">
  <div class="wrap">
    <h1>ê´‘ì „íš¨ê³¼ ì‹œë®¬ë ˆì´ì…˜ <span class="badge">p5.js</span></h1>
    <div class="subtitle">íŒŒì¥Â·ì„¸ê¸°Â·ì „ì••ì„ ì¡°ì ˆí•˜ì—¬ ê´‘ì „íš¨ê³¼ì™€ I-V íŠ¹ì„±ì„ ê´€ì°°í•˜ì„¸ìš”.</div>

    <div class="grid">
      <div class="panel">
        <h2>ì‹¤í—˜ ì„¤ì •</h2>

        <div class="row">
          <label>ê¸ˆì†(Ï†)</label>
          <select id="material">
            <option value="Sodium|2.28" selected>ë‚˜íŠ¸ë¥¨ (2.28)</option>
            <option value="Potassium|2.30">ì¹¼ë¥¨ (2.30)</option>
            <option value="Cesium|1.90">ì„¸ìŠ˜ (1.90)</option>
            <option value="Calcium|2.90">ì¹¼ìŠ˜ (2.90)</option>
            <option value="Aluminum|4.08">ì•Œë£¨ë¯¸ëŠ„ (4.08)</option>
            <option value="Zinc|4.30">ì•„ì—° (4.30)</option>
            <option value="Copper|4.70">êµ¬ë¦¬ (4.70)</option>
          </select>
          <div class="out" id="phiOut">2.28</div>
        </div>

        <div class="row">
          <label>íŒŒì¥ Î»</label>
          <input id="lambda" type="range" min="200" max="800" step="1" value="500">
          <div class="out" id="lambdaOut">500</div>
        </div>

        <div class="row">
          <label>ì„¸ê¸° I</label>
          <input id="intensity" type="range" min="0" max="1" step="0.01" value="0.60">
          <div class="out" id="intensityOut">0.60</div>
        </div>

        <div class="row">
          <label>ì „ì•• V</label>
          <input id="voltage" type="range" min="-5" max="5" step="0.1" value="0">
          <div class="out" id="voltageOut">0.0</div>
        </div>

        <div class="readout">
          <div class="readout-item">
            <div class="readout-key">ê´‘ì ì—ë„ˆì§€ E (eV)</div>
            <div class="readout-val" id="Eev">â€“</div>
          </div>
          <div class="readout-item">
            <div class="readout-key">ë¬¸í„± íŒŒì¥ Î»â‚€ (nm)</div>
            <div class="readout-val" id="lam0">â€“</div>
          </div>
          <div class="readout-item">
            <div class="readout-key">K<sub>max</sub> (eV)</div>
            <div class="readout-val" id="Kmax">â€“</div>
          </div>
          <div class="readout-item">
            <div class="readout-key">ì •ì§€ì „ì•• V<sub>stop</sub> (V)</div>
            <div class="readout-val" id="Vstop">â€“</div>
          </div>
        </div>

        <div id="statusChip" class="statusChip off">â— ì „ì ë°©ì¶œ ì—†ìŒ</div>
      </div>

      <div class="card">
        <div class="challenge-group" id="challengeGroup">
          <h3>ë„ì „ ëª¨ë“œ</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:4px;">
            <button id="btnChallenge" class="chip-btn">ë„ì „ ì‹œì‘</button>
            <div style="font-size:12px;color:var(--muted);">ì´ 10ë¼ìš´ë“œ</div>
          </div>
          <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:4px;font-size:13px;">
            <div>ë¼ìš´ë“œ: <strong><span id="gpRound">-</span> / 10</strong></div>
            <div>ì ìˆ˜: <strong><span id="gpScore">0</span>ì </strong></div>
            <div class="bestScoreBox">
              <span class="bestLabel">ìµœê³ </span>
              <span class="bestIcon">ğŸ†</span>
              <span id="gpBest" class="bestValue">0</span>
            </div>
          </div>

          <div id="phase1Box" style="display:none;">
            <div style="font-size:12px;color:#374151;">
              [1â€“5ë¼ìš´ë“œ] ì¡°ê±´ì—ì„œ <b>ê´‘ì „ë¥˜ê°€ íë¥¼ê¹Œìš”?</b>
            </div>
            <div class="challenge-cond" id="phase1Cond"></div>
            <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap;">
              <button class="chip-btn" id="btnFlowYes">ì „ë¥˜ íë¦„</button>
              <button class="chip-btn" id="btnFlowNo">ì „ë¥˜ ì•ˆ íë¦„</button>
            </div>
          </div>

          <div id="phase2Box" style="display:none;">
            <div style="font-size:12px;color:#374151;">
              [6â€“10ë¼ìš´ë“œ] <b>ì •ì§€ì „ì•• V<sub>stop</sub></b>ì„ ê³„ì‚°í•˜ì„¸ìš”.
            </div>
            <div class="challenge-cond" id="phase2Cond"></div>
            <div class="input-row">
              <label style="font-size:12px;">V<sub>stop</sub>:</label>
              <input type="number" id="ansVstop" step="0.01" placeholder="0.00" />
              <button class="chip-btn" id="btnSubmitVstop">ì œì¶œ</button>
            </div>
          </div>

          <div id="gpMessage" class="challenge-message">
            ë„ì „ ëª¨ë“œë¥¼ ì‹œì‘í•˜ë©´ ë¬¸ì œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </div>
        </div>
      </div>
    </div>
    <div class="brand">ì™•ì™• ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
<script>
  // ===== DOM + ì „ì—­ ìƒíƒœ =====
  const matSel = document.getElementById('material');
  const phiOut = document.getElementById('phiOut');
  const lambdaSlider = document.getElementById('lambda');
  const lambdaOut = document.getElementById('lambdaOut');
  const intSlider = document.getElementById('intensity');
  const intOut = document.getElementById('intensityOut');
  const volSlider = document.getElementById('voltage');
  const volOut = document.getElementById('voltageOut');
  const EevOut = document.getElementById('Eev');
  const lam0Out = document.getElementById('lam0');
  const KmaxOut = document.getElementById('Kmax');
  const VstopOut = document.getElementById('Vstop');
  const statusChip = document.getElementById('statusChip');

  // ë„ì „ ëª¨ë“œ DOM
  const btnChallenge = document.getElementById('btnChallenge');
  const gpRoundEl = document.getElementById('gpRound');
  const gpScoreEl = document.getElementById('gpScore');
  const gpBestEl  = document.getElementById('gpBest');
  const gpMessageEl = document.getElementById('gpMessage');
  const phase1Box = document.getElementById('phase1Box');
  const phase2Box = document.getElementById('phase2Box');
  const phase1CondEl = document.getElementById('phase1Cond');
  const phase2CondEl = document.getElementById('phase2Cond');
  const btnFlowYes = document.getElementById('btnFlowYes');
  const btnFlowNo  = document.getElementById('btnFlowNo');
  const ansVstopEl = document.getElementById('ansVstop');
  const btnSubmitVstop = document.getElementById('btnSubmitVstop');

  let phi_eV = 2.28;
  let lambda_nm = 500;
  let intensity = 0.60;
  let V = 0;

  // íŒŒí‹°í´
  let electrons = [];
  let photons = [];

  // ê¸°í•˜
  let cathX, anodeX, regionTop, regionBottom, gapX;

  // ì‹œê°„
  let lastMillis = 0;

  // ìƒìˆ˜
  const h_eV_nm = 1240;

  const MATERIALS = [
    { name:'ë‚˜íŠ¸ë¥¨', key:'Sodium', phi:2.28, value:'Sodium|2.28' },
    { name:'ì¹¼ë¥¨',   key:'Potassium', phi:2.30, value:'Potassium|2.30' },
    { name:'ì„¸ìŠ˜',   key:'Cesium', phi:1.90, value:'Cesium|1.90' },
    { name:'ì¹¼ìŠ˜',   key:'Calcium', phi:2.90, value:'Calcium|2.90' },
    { name:'ì•Œë£¨ë¯¸ëŠ„', key:'Aluminum', phi:4.08, value:'Aluminum|4.08' },
    { name:'ì•„ì—°',   key:'Zinc', phi:4.30, value:'Zinc|4.30' },
    { name:'êµ¬ë¦¬',   key:'Copper', phi:4.70, value:'Copper|4.70' },
  ];

  const game = {
    active:false, round:0, totalRounds:10, score:0,
    bestScore:Number(localStorage.getItem('photoelectricBestScore') || 0) || 0,
    phase:0, correctFlow:false, targetVstop:null, hard:false
  };
  const SCORE_PER_CORRECT = 50;

  function updateScoreUI(){
    gpRoundEl.textContent = game.active ? game.round : '-';
    gpScoreEl.textContent = game.score;
    gpBestEl.textContent  = game.bestScore;
  }
  function setMessage(msg, good){
    gpMessageEl.textContent = msg || '';
    gpMessageEl.style.color = good ? '#16a34a' : '#6b7280';
  }

  updateScoreUI();

  matSel.addEventListener('change', () => {
    const [,phi] = matSel.value.split('|');
    phi_eV = parseFloat(phi);
    phiOut.textContent = phi_eV.toFixed(2);
    resetParticles();
  });
  lambdaSlider.addEventListener('input', () => {
    lambda_nm = parseFloat(lambdaSlider.value);
    lambdaOut.textContent = lambda_nm.toFixed(0);
  });
  intSlider.addEventListener('input', () => {
    intensity = parseFloat(intSlider.value);
    intOut.textContent = intensity.toFixed(2);
  });
  volSlider.addEventListener('input', () => {
    V = parseFloat(volSlider.value);
    volOut.textContent = V.toFixed(1);
  });

  function resetParticles(){ electrons = []; photons = []; }
  function disableControls(flag){
    matSel.disabled = flag; lambdaSlider.disabled = flag;
    intSlider.disabled = flag; volSlider.disabled = flag;
  }

  function startChallenge(){
    game.active = true; game.round = 0; game.score = 0; game.phase = 0;
    setMessage('ë„ì „ ì‹œì‘! ë¬¸ì œë¥¼ í’€ì–´ë³´ì„¸ìš”.', false);
    nextRound();
  }
  function endChallenge(){
    setMessage(`ë„ì „ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜ ${game.score}ì `, true);
    game.active = false; game.phase = 0;
    phase1Box.style.display = 'none'; phase2Box.style.display = 'none';
    gpRoundEl.textContent = '-';
    disableControls(false);
  }
  function applyScore(isCorrect){
    if(isCorrect){
      game.score += SCORE_PER_CORRECT;
      setMessage(`ì •ë‹µ! +${SCORE_PER_CORRECT}ì `, true);
      if(game.score > game.bestScore){
        game.bestScore = game.score;
        localStorage.setItem('photoelectricBestScore', String(game.bestScore));
        if(window.saveBestScoreToFirebase) try{ window.saveBestScoreToFirebase(game.bestScore); }catch(e){}
      }
      updateScoreUI();
    }else{
      setMessage('ì˜¤ë‹µì…ë‹ˆë‹¤.', false);
    }
  }
  function nextRound(){
    if(!game.active) return;
    if(game.round >= game.totalRounds){ endChallenge(); return; }
    game.round++; updateScoreUI();
    if(game.round <= 5){ game.phase = 1; setupPhase1Round(); }
    else{ game.phase = 2; game.hard = (game.round >= 9); setupPhase2Round(); }
  }

  function setupPhase1Round(){
    phase2Box.style.display = 'none'; phase1Box.style.display = 'block';
    disableControls(true); resetParticles();
    
    const mat = MATERIALS[Math.floor(Math.random()*MATERIALS.length)];
    matSel.value = mat.value; phi_eV = mat.phi; phiOut.textContent = phi_eV.toFixed(2);
    const lam0 = h_eV_nm / phi_eV;
    const willFlow = Math.random() < 0.5;
    let lam, I, v;

    if(willFlow){
      lam = lam0 * (0.4 + 0.4*Math.random()); 
      lam = Math.max(200, Math.min(780, lam));
      const E = h_eV_nm / lam; const Kmax = Math.max(0, E - phi_eV); const Vstop = Kmax;
      I = 0.4 + 0.6*Math.random();
      v = -0.5*Vstop + (2*Vstop + 2)*Math.random(); // -0.5Vstop ~ 1.5Vstop+2 roughly
      // Ensure V > -Vstop
      if (v <= -Vstop) v = -Vstop + 0.1; 
    }else{
      if(Math.random()<0.5){ // hf < phi
        lam = lam0 * (1.05 + 0.6*Math.random());
        lam = Math.max(200, Math.min(800, lam));
        I = 0.4 + 0.6*Math.random(); v = -3 + 6*Math.random();
      }else{ // hf > phi but V <= -Vstop
        lam = lam0 * (0.4 + 0.4*Math.random());
        lam = Math.max(200, Math.min(780, lam));
        const E = h_eV_nm / lam; const Kmax = Math.max(0, E - phi_eV); const Vstop = Kmax;
        I = 0.4 + 0.6*Math.random();
        v = -1.4*Vstop - 1 + (0.4*Vstop + 1)*Math.random(); // less than -Vstop
        if (v > -Vstop) v = -Vstop - 0.1;
      }
    }
    lambda_nm = lam; lambdaSlider.value = lam.toFixed(0); lambdaOut.textContent = lam.toFixed(0);
    intensity = I; intSlider.value = I.toFixed(2); intOut.textContent = I.toFixed(2);
    V = v; volSlider.value = v.toFixed(1); volOut.textContent = v.toFixed(1);

    const {Kmax_eV} = computePhysics();
    const Itest = currentForVoltage(V);
    const flows = (Kmax_eV>0 && intensity>0 && Itest>0.01);
    game.correctFlow = flows;

    phase1CondEl.innerHTML = `ê¸ˆì†:<b>${mat.name}</b> Î»:<b>${lambda_nm.toFixed(0)}nm</b> I:<b>${intensity.toFixed(2)}</b> V:<b>${V.toFixed(2)}V</b>`;
    setMessage('ì „ë¥˜ íë¦„ / ì•ˆ íë¦„ ì„ íƒ', false);
  }

  function handlePhase1Answer(choice){
    if(!game.active || game.phase!==1) return;
    const isCorrect = (choice === 'flow') === game.correctFlow;
    applyScore(isCorrect); setTimeout(nextRound, 900);
  }

  function setupPhase2Round(){
    phase1Box.style.display = 'none'; phase2Box.style.display = 'block';
    disableControls(true); resetParticles();

    const mat = MATERIALS[Math.floor(Math.random()*MATERIALS.length)];
    matSel.value = mat.value; phi_eV = mat.phi; phiOut.textContent = phi_eV.toFixed(2);
    const lam0 = h_eV_nm / phi_eV;
    let lam = game.hard ? lam0 * (0.90 + 0.09*Math.random()) : lam0 * (0.6 + 0.25*Math.random());
    lam = Math.max(200, Math.min(780, lam));

    lambda_nm = lam; lambdaSlider.value = lam.toFixed(0); lambdaOut.textContent = lam.toFixed(0);
    intensity = 0.5 + 0.5*Math.random(); intSlider.value = intensity.toFixed(2); intOut.textContent = intensity.toFixed(2);

    const {Vstop_V} = computePhysics();
    const minV = -0.4*Vstop_V; const maxV = Vstop_V + 2;
    V = minV + (maxV-minV)*Math.random();
    volSlider.value = V.toFixed(1); volOut.textContent = V.toFixed(1);

    game.targetVstop = Vstop_V;
    KmaxOut.textContent = '???'; VstopOut.textContent = '???';
    phase2CondEl.innerHTML = `ê¸ˆì†:<b>${mat.name}</b> Î»:<b>${lambda_nm.toFixed(0)}nm</b> I:<b>${intensity.toFixed(2)}</b> V:<b>${V.toFixed(2)}V</b>`;
    ansVstopEl.value = '';
    setMessage('ì •ì§€ì „ì••ì„ ê³„ì‚°í•˜ì„¸ìš”.', false);
  }

  function handleSubmitVstop(){
    if(!game.active || game.phase!==2 || game.targetVstop==null) return;
    const val = parseFloat(ansVstopEl.value);
    if(isNaN(val)){ setMessage('ìˆ«ì ì…ë ¥ í•„ìš”', false); return; }
    const tol = game.hard ? 0.05 : 0.10;
    const isCorrect = Math.abs(val - game.targetVstop) <= tol;
    applyScore(isCorrect);
    setTimeout(()=>{
      const {Kmax_eV, Vstop_V} = computePhysics();
      KmaxOut.textContent = Kmax_eV.toFixed(2); VstopOut.textContent = Vstop_V.toFixed(2);
      nextRound();
    }, 900);
  }

  window.setBestScoreFromFirebase = function(score){
    game.bestScore = Number(score) || 0; updateScoreUI();
  };

  if(btnChallenge) btnChallenge.addEventListener('click', startChallenge);
  if(btnFlowYes) btnFlowYes.addEventListener('click', ()=>handlePhase1Answer('flow'));
  if(btnFlowNo) btnFlowNo.addEventListener('click', ()=>handlePhase1Answer('noflow'));
  if(btnSubmitVstop) btnSubmitVstop.addEventListener('click', handleSubmitVstop);

  // ===== P5.js Instance =====
  new p5(p => {
    p.setup = function(){
      const holder = p.select('#sim-holder');
      // ëª¨ë°”ì¼ ê°ì§€: í­ 768px ì´í•˜
      let w = holder.width;
      let h = w * 0.75;
      
      // ëª¨ë°”ì¼(ì„¸ë¡œëª¨ë“œ ë“±)ì—ì„œëŠ” ìº”ë²„ìŠ¤ ë†’ì´ë¥¼ CSSë¡œ ê³ ì •ëœ ì˜ì—­(45vh)ì— ë§ì¶¤
      if (window.innerWidth <= 768) {
         h = window.innerHeight * 0.45;
         // ê°€ë¡œí­ì€ 100%
      }
      
      const cnv = p.createCanvas(w, h);
      cnv.parent('sim-holder');
      p.pixelDensity(window.devicePixelRatio || 1);
      setupGeometry();
      lastMillis = p.millis();
    };

    p.windowResized = function(){
      const holder = p.select('#sim-holder');
      let w = holder.width;
      let h = w * 0.75;
      
      if (window.innerWidth <= 768) {
         h = window.innerHeight * 0.45;
      }

      p.resizeCanvas(w,h);
      p.pixelDensity(window.devicePixelRatio || 1);
      setupGeometry();
    };

    function setupGeometry(){
      cathX = p.width * 0.22;
      anodeX = p.width * 0.78;
      regionTop = p.height * 0.13;
      regionBottom = p.height * 0.58;
      gapX = (anodeX - 14) - (cathX + 14);
      resetParticles();
    }

    p.draw = function(){
      const now = p.millis();
      const dt = Math.min(0.05, (now - lastMillis)/1000);
      lastMillis = now;
      updatePhysicsReadout();
      updateParticles(dt);
      drawScene();
      drawIVGraph();
    };

    function computePhysics(){
      const E_eV = h_eV_nm / lambda_nm;
      const lam0_nm = h_eV_nm / phi_eV;
      const Kmax_eV = Math.max(0, E_eV - phi_eV);
      const Vstop_V = Kmax_eV;
      return {E_eV, lam0_nm, Kmax_eV, Vstop_V};
    }
    window.computePhysics = computePhysics;

    function updatePhysicsReadout(){
      const {E_eV, lam0_nm, Kmax_eV, Vstop_V} = computePhysics();
      EevOut.textContent = E_eV.toFixed(2);
      lam0Out.textContent = lam0_nm.toFixed(0);
      if(game.active && game.phase===2){
        KmaxOut.textContent = '???'; VstopOut.textContent = '???';
      }else{
        KmaxOut.textContent = Kmax_eV.toFixed(2);
        VstopOut.textContent = Vstop_V.toFixed(2);
      }
      if (Kmax_eV <= 0 || intensity <= 0){
        statusChip.textContent = 'â— ì „ì ë°©ì¶œ ì—†ìŒ'; statusChip.className = 'statusChip off';
      } else if (V < -Vstop_V + 0.05){
        statusChip.textContent = 'â— ë°©ì¶œ ìˆìœ¼ë‚˜ ì „ë¥˜â‰ˆ0'; statusChip.className = 'statusChip stop';
      } else {
        statusChip.textContent = 'â— ì „ë¥˜ íë¦„'; statusChip.className = 'statusChip emit';
      }
    }

    function currentForVoltage(Vtest){
      const {Kmax_eV} = computePhysics();
      if (Kmax_eV <= 0 || intensity <= 0) return 0;
      const Vstop = Kmax_eV;
      const I_sat = intensity * Math.max(0.3, Kmax_eV);
      if (Vtest <= -Vstop) return 0;
      const Veff = Vtest + Vstop;
      return I_sat * (1 - Math.exp(-Veff/1.2));
    }
    window.currentForVoltage = currentForVoltage;

    function wavelengthColor(wl){
      if (wl<380) wl=380; if (wl>780) wl=780;
      let r=0,g=0,b=0;
      if (wl<440){ r=-(wl-440)/(60); b=1; }
      else if (wl<490){ g=(wl-440)/(50); b=1; }
      else if (wl<510){ g=1; b=-(wl-510)/(20); }
      else if (wl<580){ r=(wl-510)/(70); g=1; }
      else if (wl<645){ r=1; g=-(wl-645)/(65); }
      else{ r=1; }
      return p.color(r*255,g*255,b*255);
    }

    function spawnPhotons(dt){
      if (intensity <= 0) return;
      const baseRate = 260;
      const want = baseRate * intensity * dt;
      let n = Math.floor(want);
      if (p.random() < want-n) n++;
      const col = wavelengthColor(lambda_nm);
      const lampX = p.width * 0.06;
      const lampY = (regionTop + regionBottom) / 2;

      for (let i=0;i<n;i++){
        const angle = p.random(-0.35, 0.35);
        const speed = p.random(p.width*0.7, p.width*0.9);
        photons.push({
          x: lampX + Math.cos(angle)*24, y: lampY + Math.sin(angle)*24,
          vx: speed * Math.cos(angle), vy: speed * Math.sin(angle),
          col, life:0
        });
        if (photons.length > 600) photons.shift();
      }
    }

    function spawnElectron(Kmax_eV){
      if (Kmax_eV <= 0) return;
      if(game.active && game.phase===1) return; // 1~5ë¼ì—” ì• ë‹ˆë©”ì´ì…˜ ìƒëµ

      const x0 = cathX + 14;
      const minT=1.2, maxT=0.5;
      const tCross = p.map(Kmax_eV, 0,5, minT, maxT, true);
      const baseSpeed = gapX / tCross;
      let willReachAnode = true, maxX = anodeX - 14, ax = 0;

      if (V < 0 && Math.abs(V) >= Kmax_eV){
        const frac = Kmax_eV / Math.abs(V);
        maxX = x0 + gapX * Math.min(frac, 1) * 0.96;
        willReachAnode = false;
        const dist = Math.max(10, maxX - x0);
        ax = - (baseSpeed * baseSpeed) / (2 * dist);
      }
      electrons.push({
        x: x0, y: p.random(regionTop+8, regionBottom-8),
        vx: baseSpeed, vy: p.random(-10,10), ax, life:0,
        maxX, willReachAnode
      });
      if (electrons.length > 350) electrons.shift();
    }

    function updateParticles(dt){
      const {Kmax_eV} = computePhysics();
      const canEmit = Kmax_eV > 0 && intensity>0;
      spawnPhotons(dt);

      for (let i=photons.length-1;i>=0;i--){
        const ph = photons[i];
        ph.x += ph.vx * dt; ph.y += ph.vy * dt; ph.life += dt;
        if (ph.x >= cathX-10 && ph.x <= cathX+4 && ph.y >= regionTop-12 && ph.y <= regionBottom+12){
          if (canEmit && p.random() < 0.35) spawnElectron(Kmax_eV);
          photons.splice(i,1);
        } else if (ph.x>anodeX+40||ph.x<-40||ph.y<regionTop-60||ph.y>regionBottom+60||ph.life>2.4){
          photons.splice(i,1);
        }
      }
      for (let i=electrons.length-1;i>=0;i--){
        const e = electrons[i];
        e.vx += e.ax * dt; e.x += e.vx*dt; e.y += e.vy*dt; e.life += dt; e.vy *= 0.98;
        if (e.y < regionTop+5 || e.y > regionBottom-5) e.vy *= -1;
        
        if (!e.willReachAnode){
          if (e.vx > 0 && e.x > e.maxX){ e.x = e.maxX; e.vx = 0; }
          if (e.vx < 0 && e.x <= cathX+14){ electrons.splice(i,1); continue; }
        } else {
          if (e.x >= anodeX-12){ electrons.splice(i,1); continue; }
        }
        if (e.x < -40 || e.x > p.width+40 || e.life>4) electrons.splice(i,1);
      }
    }

    function drawScene(){
      p.background(245, 248, 255);
      const midY = p.height*0.60;

      // ë°°ê²½
      p.noStroke(); p.fill(229, 231, 235); p.rect(0,0,p.width,midY);
      
      // ì±”ë²„
      p.fill(234,237,255,220); p.rect(0,regionTop-12,p.width,regionBottom-regionTop+24,16);

      // ì „ê·¹
      p.stroke(148,163,184,180); p.strokeWeight(2); p.fill(250,250,255);
      p.rect(cathX-14, regionTop, 28, regionBottom-regionTop, 8); // ìŒê·¹
      p.rect(anodeX-14, regionTop, 28, regionBottom-regionTop, 8); // ì–‘ê·¹

      // ì „ì••ê³„/ì „ì„ 
      const arrowY = regionBottom + 18;
      let colV = p.color(148,163,184);
      if (V>0) colV = p.color(34,197,94); else if (V<0) colV = p.color(239,68,68);
      p.stroke(colV); p.strokeWeight(1.8);
      p.line(cathX, arrowY, anodeX, arrowY);
      if (V>0) drawArrowHead(anodeX,arrowY,0); else if (V<0) drawArrowHead(cathX,arrowY,Math.PI);
      p.noStroke(); p.fill(55,65,81); p.textAlign(p.CENTER,p.BOTTOM); p.textSize(11);
      p.text(`V = ${V.toFixed(1)} V`, (cathX+anodeX)/2, arrowY-6);

      // ê´‘ì›
      const lampX = p.width*0.06; const lampY = (regionTop+regionBottom)/2;
      p.push(); p.noStroke();
      const beamCol = wavelengthColor(lambda_nm);
      const baseAlpha = p.map(intensity, 0,1, 10, 55);
      p.fill(p.red(beamCol), p.green(beamCol), p.blue(beamCol), baseAlpha);
      p.beginShape(); p.vertex(lampX+18, lampY-40); p.vertex(cathX-20, regionTop-10);
      p.vertex(cathX-20, regionBottom+10); p.vertex(lampX+18, lampY+40);
      p.endShape(p.CLOSE); p.pop();
      p.fill(255); p.circle(lampX, lampY, 48);
      p.fill(beamCol); p.circle(lampX, lampY, 32);

      // ì…ì ê·¸ë¦¬ê¸°
      for (const ph of photons){
        p.noStroke(); p.fill(ph.col); p.circle(ph.x, ph.y, 4);
      }
      for (const e of electrons){
        p.noStroke(); p.fill(59,130,246); p.circle(e.x,e.y,6);
      }
      // êµ¬ë¶„ì„ 
      p.stroke(226,232,240); p.strokeWeight(1); p.line(0, midY, p.width, midY);
    }

    function drawArrowHead(x,y,angle){
      const len=9; p.push(); p.translate(x,y); p.rotate(angle);
      p.beginShape(); p.vertex(0,0); p.vertex(-len, len*0.6); p.vertex(-len, -len*0.6);
      p.endShape(p.CLOSE); p.pop();
    }

    function drawIVGraph(){
      const top = p.height*0.64; const bottom = p.height*0.96;
      const left = p.width*0.10; const right = p.width*0.90;
      p.noStroke(); p.fill(249,250,251); p.rect(0,top-8,p.width,bottom-top+12);
      
      // ì¶•
      p.stroke(209,213,219); p.strokeWeight(1);
      p.line(left, bottom, right, bottom); p.line(left, bottom, left, top);
      const xZero = p.map(0,-5,5,left,right);
      p.stroke(209,213,219,180); p.line(xZero, bottom, xZero, top);

      // ë¼ë²¨
      p.noStroke(); p.fill(107,114,128); p.textAlign(p.CENTER,p.TOP); p.textSize(10);
      p.text('ì „ì•• V', (left+right)/2, bottom+3);
      
      // ê·¸ë˜í”„
      const samples=80; let maxI=0; const data=[];
      for(let i=0;i<=samples;i++){
        const Vtest = p.map(i,0,samples,-5,5); const I = currentForVoltage(Vtest);
        data.push({V:Vtest,I}); if(I>maxI) maxI=I;
      }
      if(maxI<=0) maxI=1;
      
      p.noFill(); p.stroke(56,189,248); p.strokeWeight(2);
      p.beginShape();
      for(let d of data){
        p.vertex(p.map(d.V,-5,5,left,right), p.map(d.I,0,maxI,bottom,top+6));
      }
      p.endShape();

      // í˜„ì¬ì 
      const Icur = currentForVoltage(V);
      p.noStroke(); p.fill(34,197,94);
      p.circle(p.map(V,-5,5,left,right), p.map(Icur,0,maxI,bottom,top+6), 7);
    }
  });
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
    authDomain: "simulation-67cd3.firebaseapp.com",
    projectId: "simulation-67cd3",
    storageBucket: "simulation-67cd3.appspot.com",
    messagingSenderId: "615983461615",
    appId: "1:615983461615:web:002e07bcea878eb6d5571a",
    measurementId: "G-9RGN7LYE5W"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const SIM_ID = "ê´‘ì „íš¨ê³¼";
  let firebaseUser = null;

  async function saveBestScore(score) {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      await setDoc(ref, { score: Number(score) || 0 }, { merge: true });
    } catch (err) { console.error(err); }
  }

  async function loadBestScore() {
    if (!firebaseUser) return;
    try {
      const ref = doc(db, "users", firebaseUser.uid, "simulations", SIM_ID);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        const score = Number(data.score || 0) || 0;
        if (window.setBestScoreFromFirebase) window.setBestScoreFromFirebase(score);
      }
    } catch (err) { console.error(err); }
  }

  window.saveBestScoreToFirebase = saveBestScore;
  onAuthStateChanged(auth, async (user) => {
    firebaseUser = user;
    if (user) await loadBestScore();
  });
</script>
</body>
</html>