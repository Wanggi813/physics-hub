<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ë¡œìŠ¤ í•„ë“œ: ì…ì ê°€ì† ì‹œë®¬ë ˆì´í„°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Share+Tech+Mono&display=swap');

        :root {
            --bg-color: #050a14;
            --panel-bg: rgba(15, 23, 42, 0.7);
            --text-color: #e0e6ed;
            --accent-color: #00f2fe; /* Cyan */
            --danger-color: #ff4757; /* Electric */
            --warning-color: #ffa502; /* Magnetic */
            --success-color: #2ed573;
            --obstacle-color: #ff6b6b;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000; /* ë°°ê²½ì„ ê²€ê²Œ ì²˜ë¦¬ */
            color: var(--text-color);
        }
        /* [ì‹ ê·œ] ê²Œì„ ì»¨í…Œì´ë„ˆ: ê¸°ì¤€ í•´ìƒë„(1280x720)ë¡œ ê³ ì • */
        #game-container {
            position: relative; /* absoluteì—ì„œ relativeë¡œ ë³€ê²½ */
            width: 100vw;       /* í™”ë©´ ì „ì²´ ë„ˆë¹„ */
            height: 100vh;      /* í™”ë©´ ì „ì²´ ë†’ì´ */  
            overflow: hidden;
        }

        /* [ìˆ˜ì •] ìº”ë²„ìŠ¤: ì»¨í…Œì´ë„ˆì— ê½‰ ì°¨ê²Œ */
        #simCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* [ì‹ ê·œ] ê°€ë¡œ ëª¨ë“œ ìœ ë„ í™”ë©´ (ê¸°ë³¸ì€ ìˆ¨ê¹€) */
        #rotate-warning {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #050a14;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .phone-icon { font-size: 3rem; animation: rotatePhone 1.5s infinite; margin-bottom: 20px; }
        
        @keyframes rotatePhone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
            100% { transform: rotate(0deg); }
        }

        /* [ì‹ ê·œ] ë¯¸ë””ì–´ ì¿¼ë¦¬: ì„¸ë¡œ ëª¨ë“œì¼ ë•Œ ê²½ê³ ì°½ í‘œì‹œ */
        @media screen and (orientation: portrait) {
            #rotate-warning { display: flex; }
            #game-container { display: none; } /* ê²Œì„ ìˆ¨ê¹€ */
        }

        /* [ê¸°ì¡´ UI ìˆ˜ì •] ìœ„ì¹˜ë¥¼ ì ˆëŒ€ê°’ì´ ì•„ë‹Œ í¼ì„¼íŠ¸ë‚˜ í”½ì…€ë¡œ ì¡°ê¸ˆ ì¡°ì • */
        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ì´ ë„ˆë¬´ ë°”ë‹¥ì— ë¶™ì§€ ì•Šê²Œ ì¡°ì • */
        #controls { 
            width: 90%; 
            max-width: 600px; /* ë„ˆë¬´ ë„“ì–´ì§€ì§€ ì•Šê²Œ ì œí•œ */
            bottom: 20px;
        }
        
        /* ìŠ¬ë¼ì´ë” í„°ì¹˜ í¸ì˜ì„±: ëª¨ë°”ì¼ì—ì„œ ì˜ ëˆŒë¦¬ê²Œ ì˜ì—­ í™•ëŒ€ */
        input[type=range] { height: 20px; margin: 15px 0; }
        input[type=range]::-webkit-slider-thumb { width: 24px; height: 24px; margin-top: -10px; }

        /* ìº”ë²„ìŠ¤ */
        #simCanvas {
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            cursor: crosshair;
            z-index: 1;
        }

        /* ìƒë‹¨: ìˆ˜ì‹ ëŒ€ì‹œë³´ë“œ (HUD) */
        #hud {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            z-index: 10;
        }

        .hud-box {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Share Tech Mono', monospace;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            min-width: 140px;
        }
        .hud-label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        .hud-val { font-size: 1.2rem; font-weight: bold; }
        .force-eq { font-size: 1.5rem; font-weight: bold; color: #555; align-self: center;}
        .force-eq.balanced { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }

        /* ì¢Œì¸¡ ìƒë‹¨: ì…ì ì„ íƒê¸° */
        #particleSelector {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            z-index: 20;
        }
        .p-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.6;
            transition: 0.2s;
        }
        .p-option:hover, .p-option.active { opacity: 1; }
        .p-option.active { color: var(--accent-color); font-weight: bold; }
        .p-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; background: #fff; }

        /* ìš°ì¸¡ ìƒë‹¨: ê²Œì„ ëª¨ë“œ ë²„íŠ¼ */
        #gameModePanel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            text-align: right;
        }
        .level-badge {
            display: none;
            background: var(--warning-color);
            color: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 10px;
            box-shadow: 0 0 10px var(--warning-color);
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--panel-bg);
            padding: 20px 40px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            display: flex;
            gap: 30px;
            align-items: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            z-index: 100;
        }

        .control-group { display: flex; flex-direction: column; align-items: center; min-width: 140px; }
        .control-group label { font-size: 0.85rem; margin-bottom: 8px; font-weight: 600; text-shadow: 0 0 5px currentColor; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 10px 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -6px; cursor: pointer; transition: 0.2s; }
        input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.2); }
        
        #eSlider::-webkit-slider-thumb { background: var(--danger-color); box-shadow: 0 0 10px var(--danger-color); }
        #bSlider::-webkit-slider-thumb { background: var(--warning-color); box-shadow: 0 0 10px var(--warning-color); }
        #vSlider::-webkit-slider-thumb { background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }

        .value-display { font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; margin-top: 5px; color: #ccc; }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 30px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
        }
        #launchBtn { background: var(--accent-color); color: #000; }
        #launchBtn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-color); }
        
        #challengeBtn { background: transparent; border: 2px solid var(--warning-color); color: var(--warning-color); }
        #challengeBtn:hover, #challengeBtn.active { background: var(--warning-color); color: #000; box-shadow: 0 0 20px var(--warning-color); }
        /* [ì¶”ê°€] ì˜¤ë¡œë¼ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì‹ ë¹„ë¡œìš´ ë³´ë¼ìƒ‰/ì˜¤ë¡œë¼ ëŠë‚Œ) */
        #auroraBtn { 
            background: transparent; 
            border: 2px solid #a29bfe; /* ì—°í•œ ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ */
            color: #a29bfe; 
        }
        #auroraBtn:hover { 
            background: #a29bfe; 
            color: #000; 
            box-shadow: 0 0 20px #a29bfe; /* ë³´ë¼ìƒ‰ ë„¤ì˜¨ íš¨ê³¼ */
            transform: translateY(-2px);
        }
        /* ë©”ì‹œì§€ */
        #message {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem; font-weight: 800;
            text-align: center;
            opacity: 0; pointer-events: none;
            transition: 0.3s;
            z-index: 200; text-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="rotate-warning">
        <div class="phone-icon">ğŸ“±</div>
        <p>ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì£¼ì„¸ìš”<br>(Please Rotate Your Device)</p>
    </div>

    <div id="game-container">
        
        <div id="hud">...</div>
        <div id="particleSelector">...</div>
        <div id="gameModePanel">...</div>
        <div id="message">...</div>
        <canvas id="simCanvas"></canvas>
        <div id="controls">...</div>

    <div id="hud">
        <div class="hud-box" style="border-color: var(--danger-color);">
            <div class="hud-label">ELECTRIC FORCE (Fe = qE)</div>
            <div class="hud-val" id="hudFe" style="color: var(--danger-color);">0.00</div>
        </div>
        <div class="force-eq" id="eqSign">â‰ </div>
        <div class="hud-box" style="border-color: var(--warning-color);">
            <div class="hud-label">MAGNETIC FORCE (Fb = qvB)</div>
            <div class="hud-val" id="hudFb" style="color: var(--warning-color);">0.00</div>
        </div>
    </div>

    <div id="particleSelector">
        <div class="hud-label" style="margin-bottom:10px;">PARTICLE TYPE</div>
        <div class="p-option active" onclick="setParticle('proton', this)">
            <div class="p-dot" style="background: #ff4757;"></div> Proton (p+)
        </div>
        <div class="p-option" onclick="setParticle('electron', this)">
            <div class="p-dot" style="background: #00f2fe;"></div> Electron (e-)
        </div>
        <div class="p-option" onclick="setParticle('alpha', this)">
            <div class="p-dot" style="background: #2ed573;"></div> Alpha (He2+)
        </div>
    </div>

    <div id="gameModePanel">
        <div id="levelBadge" class="level-badge">LEVEL 1</div>
        <button id="auroraBtn" class="btn" style="margin-right: 15px;">PROJECT: AURORA</button>
        <button id="challengeBtn" class="btn">CHALLENGE MODE</button>
    </div>

    <div id="message"></div>

    <canvas id="simCanvas"></canvas>

    <div id="controls">
        <div class="control-group">
            <label style="color:var(--danger-color)">E-FIELD</label>
            <input type="range" id="eSlider" min="-5" max="5" step="0.1" value="0">
            <div class="value-display" id="eVal">0.0</div>
        </div>
        <div class="control-group">
            <label style="color:var(--warning-color)">B-FIELD</label>
            <input type="range" id="bSlider" min="-2" max="2" step="0.1" value="0">
            <div class="value-display" id="bVal">0.0</div>
        </div>
        <div class="control-group">
            <label style="color:var(--accent-color)">VELOCITY</label>
            <input type="range" id="vSlider" min="1" max="10" step="0.5" value="5">
            <div class="value-display" id="vVal">5.0</div>
        </div>
        <button id="launchBtn" class="btn">LAUNCH</button>
    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let animationId;
        let time = 0;
        
        // --- 1. ìƒíƒœ ë° ë¬¼ë¦¬ ì„¤ì • ---
        const physics = {
            proton: { m: 2.0, q: 1, color: '#ff4757', name: 'Proton' },
            electron: { m: 0.5, q: -1, color: '#00f2fe', name: 'Electron' }, // ì‹¤ì œ ë¹„ìœ¨ë³´ë‹¤ ê³¼ì¥ë¨ (ê²Œì„ì„±)
            alpha: { m: 8.0, q: 2, color: '#2ed573', name: 'Alpha' }
        };

        const state = {
            E: 0, B: 0, v0: 5,
            running: false,
            mode: 'free', // 'free' or 'challenge'
            level: 1,
            particleType: 'proton'
        };

        let particle = {
            x: 0, y: 0, vx: 0, vy: 0,
            trail: []
        };

        let target = { x: 0, y: 0, radius: 30, active: false };
        let obstacles = []; // {x, y, w, h}

        // --- 2. ì´ˆê¸°í™” ---
        function init() {
            resize();
            window.addEventListener('resize', resize);
            
            // ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
            document.getElementById('eSlider').addEventListener('input', updateUI);
            document.getElementById('bSlider').addEventListener('input', updateUI);
            document.getElementById('vSlider').addEventListener('input', updateUI);
            document.getElementById('launchBtn').addEventListener('click', launch);
            document.getElementById('challengeBtn').addEventListener('click', toggleChallenge);
            document.getElementById('auroraBtn').addEventListener('click', function() {window.location.href = 'ì˜¤ë¡œë¼.html';});

            updateUI();
            resetSystem();
            loop();
        }

 function resize() {
            // 1. í™”ë©´ í¬ê¸° ì—…ë°ì´íŠ¸
            width = window.innerWidth;
            height = window.innerHeight;

            // 2. ìº”ë²„ìŠ¤ í•´ìƒë„ ì¡°ì •
            canvas.width = width;
            canvas.height = height;

            // 3. ì»¨í…Œì´ë„ˆ ìŠ¤ì¼€ì¼ ì´ˆê¸°í™” (ë°˜ì‘í˜• í’€ìŠ¤í¬ë¦° ì‚¬ìš© ì‹œ)
            const container = document.getElementById('game-container');
            if(container) container.style.transform = 'none';

            // 4. ë ˆë²¨ ë° ì¥ì• ë¬¼ ìœ„ì¹˜ ì¬ê³„ì‚°
            if (state.mode === 'challenge') {
                setupLevel(state.level); 
            } else {
                target.x = width - 100;
                target.y = height / 2;
            }

            // [í•µì‹¬ ì¶”ê°€] ì…ìë¥¼ "ì›ë˜ ìœ„ì¹˜"ë¡œ ë¦¬ì…‹
            // í™”ë©´ì´ ë°”ë€Œë©´ ë‚ ì•„ê°€ë˜ ì…ìë¥¼ ì·¨ì†Œí•˜ê³ , ìƒˆë¡œìš´ í™”ë©´ì˜ ì¤‘ì•™ ë†’ì´ë¡œ ì…ìë¥¼ ë˜ëŒë¦½ë‹ˆë‹¤.
            resetSystem(); 
        }

        // ... ë‚˜ë¨¸ì§€ setupLevel, updatePhysics ë“±ì—ì„œ...
        // 'width'ì™€ 'height' ë³€ìˆ˜ë¥¼ ì“°ë˜ ê³³ì„ ëª¨ë‘ 'DESIGN_WIDTH', 'DESIGN_HEIGHT'ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.
        // í˜¹ì€ ì•„ë˜ì²˜ëŸ¼ ì „ì—­ ë³€ìˆ˜ë¡œ ë§¤í•‘í•´ì¤˜ë„ ë©ë‹ˆë‹¤.
        
        // [í¸ì˜ë¥¼ ìœ„í•´ ì „ì—­ ë³€ìˆ˜ ì¬ì„ ì–¸] (init í•¨ìˆ˜ ë°–, ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨ì— ë‘ì„¸ìš”)

        // --- 3. ë¡œì§ ì œì–´ ---
        function setParticle(type, el) {
            state.particleType = type;
            // UI ì—…ë°ì´íŠ¸
            document.querySelectorAll('.p-option').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
            
            // ì¬ì„¤ì •
            if(state.running) launch();
            else resetSystem();
        }

        function updateUI() {
            state.E = parseFloat(document.getElementById('eSlider').value);
            state.B = parseFloat(document.getElementById('bSlider').value);
            state.v0 = parseFloat(document.getElementById('vSlider').value);

            document.getElementById('eVal').textContent = state.E.toFixed(1);
            document.getElementById('bVal').textContent = state.B.toFixed(1);
            document.getElementById('vVal').textContent = state.v0.toFixed(1);

            updateHUD();
        }

        function updateHUD() {
            const p = physics[state.particleType];
            // í˜ì˜ í¬ê¸° (ì ˆëŒ“ê°’) ê³„ì‚°
            const Fe = Math.abs(p.q * state.E);
            const Fb = Math.abs(p.q * state.v0 * state.B); // ì´ˆê¸° ì†ë„ ê¸°ì¤€ ê·¼ì‚¬ì¹˜

            const hudFe = document.getElementById('hudFe');
            const hudFb = document.getElementById('hudFb');
            const eqSign = document.getElementById('eqSign');

            hudFe.textContent = Fe.toFixed(2);
            hudFb.textContent = Fb.toFixed(2);

            // í‰í˜• ìƒíƒœ ì‹œê°í™” (ì˜¤ì°¨ ë²”ìœ„ ë‚´)
            if (state.running && Math.abs(Fe - Fb) < 0.1 && Fe > 0) {
                eqSign.textContent = "=";
                eqSign.classList.add('balanced');
            } else {
                eqSign.textContent = "vs";
                eqSign.classList.remove('balanced');
            }
        }

        function toggleChallenge() {
            const btn = document.getElementById('challengeBtn');
            const badge = document.getElementById('levelBadge');
            
            if (state.mode === 'free') {
                state.mode = 'challenge';
                state.level = 1;
                btn.classList.add('active');
                btn.textContent = "EXIT CHALLENGE";
                badge.style.display = 'block';
                setupLevel(1);
                showMsg("LEVEL 1 START", "#fff");
            } else {
                state.mode = 'free';
                btn.classList.remove('active');
                btn.textContent = "CHALLENGE MODE";
                badge.style.display = 'none';
                target.active = false;
                obstacles = [];
            }
            resetSystem();
        }

function setupLevel(lvl) {
            target.active = true;
            obstacles = [];
            document.getElementById('levelBadge').textContent = `LEVEL ${lvl}`;

            const cx = width / 2;
            const cy = height / 2;

            if (lvl === 1) {
                // [LEVEL 1: ê³„ë‹¨í˜• í„°ë„ (The Step-Up)]
                // ì •ë©´ì´ ë§‰í˜€ìˆì–´ ìœ„ìª½ í„°ë„ë¡œ ì§„ì…í•´ì•¼ í•©ë‹ˆë‹¤.
                // "ê³¡ì„  ì´ë™" í›„ "ì§ì„  ì£¼í–‰(í‰í˜•)" ëŠ¥ë ¥ì„ ëª¨ë‘ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
                
                // íƒ€ê²Ÿì„ ìœ„ìª½ í„°ë„ ëìœ¼ë¡œ ì´ë™
                const tunnelY = cy - 120; // í„°ë„ì˜ ì¤‘ì‹¬ ë†’ì´ (ìœ„ìª½)
                target.x = width - 80;
                target.y = tunnelY;

                // 1. ì •ë©´ì„ ë§‰ëŠ” ê±°ëŒ€í•œ ë²½ (ì•„ë˜ìª½ ë¸”ë¡)
                // ì¤‘ì•™(cy)ë³´ë‹¤ ì‚´ì§ ìœ„ê¹Œì§€ ë§‰ì•„ì„œ ë¬´ì¡°ê±´ ìƒìŠ¹í•˜ê²Œ ìœ ë„
                obstacles.push({ x: 300, y: tunnelY + 40, w: width - 300, h: height }); 

                // 2. í„°ë„ ì²œì¥ (ìœ„ìª½ ë¸”ë¡)
                // ë„ˆë¬´ ë†’ê²Œ ë‚ ì•„ê°€ëŠ” ê²ƒì„ ë°©ì§€ (ì¢ì€ í„°ë„ í˜•ì„±)
                obstacles.push({ x: 300, y: 0, w: width - 300, h: tunnelY - 40 });

                // (ì˜µì…˜) ì‹œì‘ ì§€ì  ë°”ë¡œ ì•ì€ ë¹„ì›Œë‘ì–´ ì…ìê°€ ìƒìŠ¹í•  ê³µê°„(x=80~300)ì„ ì¤ë‹ˆë‹¤.

            } else if (lvl === 2) {
                // [LEVEL 2: ì§€ê·¸ì¬ê·¸ ìµìŠ¤íŠ¸ë¦¼ (Triple Zig-Zag)]
                // "ìœ„ -> ì•„ë˜ -> ìœ„"ë¡œ 3ë²ˆ êº¾ì–´ì•¼ í•˜ëŠ” ê³ ë‚œì´ë„ ì½”ìŠ¤ì…ë‹ˆë‹¤.
                // ì¥ì• ë¬¼ì´ ì´˜ì´˜í•˜ê²Œ ë°°ì¹˜ë˜ì–´ ë¹ ë¥¸ ì»¨íŠ¸ë¡¤ì´ í•„ìš”í•©ë‹ˆë‹¤.

                target.x = width - 60;
                target.y = cy - 100; // ë§ˆì§€ë§‰ì—” ìœ„ë¡œ ì†Ÿêµ¬ì¹œ ìƒíƒœì—ì„œ ê³¨ì¸í•´ì•¼ í•¨

                // ì¥ì• ë¬¼ ë°°ì¹˜ ê°„ê²© ê³„ì‚° (í™”ë©´ í¬ê¸°ì— ë§ì¶° ìë™ ì¡°ì •)
                const startX = 200; // ì²« ì¥ì• ë¬¼ ì‹œì‘ ìœ„ì¹˜
                const interval = (width - 300) / 3; // ì¥ì• ë¬¼ ì‚¬ì´ ê°„ê²©
                const wallWidth = 30;
                const holeSize = 120; // êµ¬ë© í¬ê¸° (ì‘ì„ìˆ˜ë¡ ì–´ë ¤ì›€)

                // 1. ì²« ë²ˆì§¸ ë²½ (ì•„ë˜ì—ì„œ ì†ŸìŒ) -> ì…ìë¥¼ 'ìœ„'ë¡œ ìœ ë„
                obstacles.push({ 
                    x: startX, 
                    y: cy - holeSize/2, // ì¤‘ì•™ë³´ë‹¤ ì‚´ì§ ìœ„ê¹Œì§€ ë§‰ìŒ
                    w: wallWidth, 
                    h: height 
                });

                // 2. ë‘ ë²ˆì§¸ ë²½ (ìœ„ì—ì„œ ë‚´ë ¤ì˜´) -> ì…ìë¥¼ 'ì•„ë˜'ë¡œ ìœ ë„
                obstacles.push({ 
                    x: startX + interval, 
                    y: 0, 
                    w: wallWidth, 
                    h: cy + holeSize/2 // ì¤‘ì•™ë³´ë‹¤ ì‚´ì§ ì•„ë˜ê¹Œì§€ ë§‰ìŒ
                });

                // 3. ì„¸ ë²ˆì§¸ ë²½ (ì•„ë˜ì—ì„œ ì†ŸìŒ) -> ì…ìë¥¼ ë‹¤ì‹œ 'ìœ„'ë¡œ ìœ ë„
                obstacles.push({ 
                    x: startX + interval * 2, 
                    y: cy - holeSize/2, 
                    w: wallWidth, 
                    h: height 
                });

                // ì²œì¥/ë°”ë‹¥ ì œí•œ (ë„ˆë¬´ ë†’ê²Œ/ë‚®ê²Œ í”¼í•˜ëŠ” ê¼¼ìˆ˜ ë°©ì§€)
                obstacles.push({ x: 0, y: 0, w: width, h: 30 }); // ì²œì¥
                obstacles.push({ x: 0, y: height - 30, w: width, h: 30 }); // ë°”ë‹¥

            } else if (lvl === 3) {
                // íƒ€ê²Ÿì´ 'ã„·'ì ë°•ìŠ¤ ì•ˆì— ê°‡í˜€ìˆê³ , ì…êµ¬ëŠ” ë°˜ëŒ€í¸(ì˜¤ë¥¸ìª½)ì…ë‹ˆë‹¤.
                // ì…ìê°€ íƒ€ê²Ÿì„ ì§€ë‚˜ì³ì„œ -> í¬ê²Œ ì›ì„ ê·¸ë¦¬ë©° íšŒì „(ìê¸°ì¥) -> ë’¤ë¡œ ì§„ì…í•´ì•¼ í•¨.
                target.x = cx;
                target.y = cy;

                // 'ã„·'ì í˜•íƒœì˜ ê°ì˜¥ ë§Œë“¤ê¸°
                const boxSize = 80;
                // ì™¼ìª½ ë²½ (ë§‰í˜)
                obstacles.push({ x: cx - boxSize, y: cy - boxSize, w: 20, h: boxSize * 2 });
                // ìœ„ìª½ ë²½
                obstacles.push({ x: cx - boxSize, y: cy - boxSize, w: boxSize * 2, h: 20 });
                // ì•„ë˜ìª½ ë²½
                obstacles.push({ x: cx - boxSize, y: cy + boxSize - 20, w: boxSize * 2, h: 20 });
                
                // í™”ë©´ ìœ„ì•„ë˜ì— ì¥ì• ë¬¼ì„ ë‘ì–´ ë„ˆë¬´ í¬ê²Œ ë„ëŠ” ê²ƒì„ ë°©ì§€ (ì •ë°€í•œ ì œì–´ ìš”êµ¬)
                obstacles.push({ x: cx, y: 0, w: 20, h: 100 });
                obstacles.push({ x: cx, y: height - 100, w: 20, h: 100 });
            }
        }

        function resetSystem() {
            particle.x = 80;
            particle.y = height / 2;
            particle.vx = state.v0;
            particle.vy = 0;
            particle.trail = [];
            state.running = false;
            
            // ììœ  ëª¨ë“œì¼ ë•Œ íƒ€ê²Ÿ ìˆ¨ê¹€
            if(state.mode === 'free') target.active = false;
            
            document.getElementById('message').style.opacity = 0;
            document.getElementById('eqSign').classList.remove('balanced');
        }

        function launch() {
            resetSystem();
            
            // [ìˆ˜ì •] ë°œì‚¬ ì†ë„ì—ë„ ìŠ¤ì¼€ì¼ ì ìš©
            const DESIGN_WIDTH = 1200;
            const scale = Math.min(1.0, width / DESIGN_WIDTH);
            
            particle.vx = state.v0 * scale; // í™”ë©´ì´ ì‘ìœ¼ë©´ ëŠë¦¬ê²Œ ë°œì‚¬
            state.running = true;
        }

        // --- 4. ë¬¼ë¦¬ ì—”ì§„ ---
       // --- 4. ë¬¼ë¦¬ ì—”ì§„ (ìˆ˜ì •ë¨: ì •ë°€ë„ í–¥ìƒ) ---
        function updatePhysics() {
            if (!state.running) return;

            // [í•µì‹¬ ë³€ê²½ ì‚¬í•­] í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ë§ íŒ©í„° ê³„ì‚°
            // ê¸°ì¤€ ë„ˆë¹„(1200px)ë³´ë‹¤ í™”ë©´ì´ ì‘ìœ¼ë©´, ì†ë„ì™€ ì „ê¸°ì¥ë„ ê·¸ë§Œí¼ ì¤„ì…ë‹ˆë‹¤.
            const DESIGN_WIDTH = 1200; 
            const scale = Math.min(1.0, width / DESIGN_WIDTH); 

            // ê¸°ì¡´ ì •ë°€ë„ ë³´ì • (Sub-stepping)
            const originalDt = 0.2; 
            const steps = 20; 
            const dt = originalDt / steps; 

            const pProp = physics[state.particleType];

            // ìª¼ê°œì§„ íšŸìˆ˜ë§Œí¼ ë°˜ë³µ ê³„ì‚°
            for (let i = 0; i < steps; i++) {
                
                // [ìŠ¤ì¼€ì¼ ì ìš© 1] ì „ê¸°ì¥ (E) -> ìŠ¤ì¼€ì¼ ì ìš© O
                // ê±°ë¦¬ê°€ ì¤„ì–´ë“  ë§Œí¼ í˜(ê°€ì†ë„)ë„ ì¤„ì–´ì•¼ ê¶¤ì  ëª¨ì–‘ì´ ìœ ì§€ë¨
                const scaledE = state.E * scale;
                const Fe_y = pProp.q * scaledE;

                // [ìŠ¤ì¼€ì¼ ì ìš© 2] ì…ì ì†ë„ (v) -> ìŠ¤ì¼€ì¼ ì ìš© O
                // ì´ë¯¸ ì¤„ì–´ë“  ì†ë„(vx, vy)ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ì¶”ê°€ ì—°ì‚° ë¶ˆí•„ìš”
                
                // [ìŠ¤ì¼€ì¼ ì ìš© 3] ìê¸°ì¥ (B) -> ìŠ¤ì¼€ì¼ ì ìš© X
                // ìê¸°ë ¥ F = qvBì—ì„œ vê°€ ì´ë¯¸ ì¤„ì–´ë“¤ì—ˆìœ¼ë¯€ë¡œ, 
                // Bê¹Œì§€ ì¤„ì´ë©´ í˜ì´ ë„ˆë¬´ ì•½í•´ì ¸ì„œ ê¶¤ì ì´ í¼ì ¸ë²„ë¦¼ (BëŠ” ìœ ì§€!)
                
                // ìê¸°ë ¥ ê³„ì‚° (í˜„ì¬ ì…ìì˜ ì†ë„ vx, vyëŠ” ì´ë¯¸ scaleì— ì˜í•´ ì‘ì•„ì§„ ìƒíƒœì„)
                const Fb_x = pProp.q * particle.vy * state.B;
                const Fb_y = -pProp.q * particle.vx * state.B;

                const Fnet_x = Fb_x;
                const Fnet_y = Fe_y + Fb_y;

                // ê°€ì†ë„ (F = ma)
                const ax = Fnet_x / pProp.m;
                const ay = Fnet_y / pProp.m;

                // ì†ë„ ë° ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                particle.vx += ax * dt;
                particle.vy += ay * dt;
                particle.x += particle.vx * dt;
                particle.y += particle.vy * dt;
            }

            // ê¶¤ì  ì €ì¥
            particle.trail.push({x: particle.x, y: particle.y});

            // í™”ë©´ ì´íƒˆ í™•ì¸
            if (particle.x > width + 50 || particle.x < -50 || particle.y > height + 50 || particle.y < -50) {
                state.running = false;
                if(state.mode === 'challenge') failLevel();
            }

            // ì¶©ëŒ ë° ê²Œì„ ë¡œì§
            if (state.mode === 'challenge') checkCollisions();
            
            // HUD ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            updateHUD();
        }

        function checkCollisions() {
            // 1. íƒ€ê²Ÿ ë„ë‹¬
            const dx = particle.x - target.x;
            const dy = particle.y - target.y;
            if (Math.hypot(dx, dy) < target.radius) {
                winLevel();
                return;
            }

            // 2. ì¥ì• ë¬¼ ì¶©ëŒ
            for (let obs of obstacles) {
                if (particle.x > obs.x && particle.x < obs.x + obs.w &&
                    particle.y > obs.y && particle.y < obs.y + obs.h) {
                    failLevel("CRASHED!");
                    return;
                }
            }
        }

        function winLevel() {
            state.running = false;
            if (state.level < 3) {
                showMsg(`LEVEL ${state.level} CLEARED!`, "var(--success-color)");
                setTimeout(() => {
                    state.level++;
                    setupLevel(state.level);
                    resetSystem();
                    showMsg(`LEVEL ${state.level} START`, "#fff");
                }, 2000);
            } else {
                showMsg("ALL LEVELS COMPLETED!", "var(--accent-color)");
            }
        }

        function failLevel(text = "MISSED!") {
            state.running = false;
            showMsg(text, "var(--obstacle-color)");
        }

        function showMsg(text, color) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.style.color = color;
            msg.style.opacity = 1;
            msg.style.textShadow = `0 0 30px ${color}`;
        }

        // --- 5. ë Œë”ë§ ---
        function draw() {
            ctx.clearRect(0, 0, width, height);
            time += 0.05;

            drawGrid();
            drawFields();
            
            if (state.mode === 'challenge') {
                drawTarget();
                drawObstacles();
            }

            drawTrail();
            drawParticle();
            drawVectors();
        }

        function drawGrid() {
            ctx.strokeStyle = "rgba(0, 242, 254, 0.05)";
            ctx.lineWidth = 1;
            const size = 60;
            ctx.beginPath();
            for (let x = 0; x < width; x += size) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
            for (let y = 0; y < height; y += size) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
            ctx.stroke();
        }

        function drawFields() {
            // ì „ê¸°ì¥ (Plate)
            if (state.E !== 0) {
                const color = state.E > 0 ? "255, 71, 87" : "0, 242, 254";
                ctx.fillStyle = `rgba(${color}, 0.1)`;
                ctx.fillRect(0, 0, width, 20);
                ctx.fillRect(0, height-20, width, 20);
                ctx.strokeStyle = `rgba(${color}, 0.5)`;
                ctx.beginPath();
                // ë‹¨ìˆœí™”ëœ í•„ë“œ ë¼ì¸
                for(let x=50; x<width; x+=100) {
                    drawArrow(x, 30, x, height-30, 8);
                }
                ctx.stroke();
            }
            // ìê¸°ì¥
            if (state.B !== 0) {
                ctx.fillStyle = "rgba(255, 165, 2, 0.3)";
                ctx.font = "20px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                const symbol = state.B > 0 ? "âœ•" : "â—";
                for(let x=50; x<width; x+=100) {
                    for(let y=50; y<height; y+=100) {
                        ctx.fillText(symbol, x, y);
                    }
                }
            }
        }

        function drawObstacles() {
            ctx.save(); // í˜„ì¬ ê·¸ë¦¬ê¸° ìƒíƒœ ì €ì¥ (í´ë¦¬í•‘ì„ ìœ„í•´)

            for (let obs of obstacles) {
                // 1. í´ë¦¬í•‘ ì˜ì—­(ë„¤ëª¨) ì„¤ì •
                ctx.beginPath();
                ctx.rect(obs.x, obs.y, obs.w, obs.h);
                ctx.clip(); // ì´ ì´í›„ë¡œëŠ” ë„¤ëª¨ ì•ˆìª½ë§Œ ê·¸ë ¤ì§

                // 2. ë°°ê²½ ì±„ìš°ê¸°
                ctx.fillStyle = "rgba(255, 107, 107, 0.2)";
                ctx.fill();

                // 3. ë¹—ê¸ˆ ê·¸ë¦¬ê¸° (í´ë¦¬í•‘ ë•ë¶„ì— ì‚ì ¸ë‚˜ê°€ì§€ ì•ŠìŒ)
                ctx.strokeStyle = "var(--obstacle-color)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                // ë¹—ê¸ˆì´ ë„¤ëª¨ë¥¼ ê½‰ ì±„ìš°ë„ë¡ ë„‰ë„‰í•˜ê²Œ ë°˜ë³µ
                for (let i = -obs.h; i < obs.w + obs.h; i += 15) {
                    ctx.moveTo(obs.x + i, obs.y);
                    ctx.lineTo(obs.x + i + obs.h + 20, obs.y + obs.h + 20);
                }
                ctx.stroke();

                // í´ë¦¬í•‘ í•´ì œ ì „ì— í…Œë‘ë¦¬ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = "var(--obstacle-color)";
                ctx.lineWidth = 3;
                ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                
                // í´ë¦¬í•‘ í•´ì œ (ë‹¤ìŒ ë£¨í”„ë¥¼ ìœ„í•´)
                ctx.restore(); 
                ctx.save(); // ë‹¤ìŒ ì¥ì• ë¬¼ì„ ìœ„í•´ ë‹¤ì‹œ save
            }
            ctx.restore(); // ìµœì¢… ë³µêµ¬
        }

        function drawTarget() {
            if (!target.active) return;
            const color = "var(--success-color)";
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;

            ctx.beginPath();
            ctx.arc(target.x, target.y, target.radius, time, time + Math.PI * 1.5);
            ctx.stroke();
            
            ctx.font = "12px sans-serif";
            ctx.fillStyle = color;
            ctx.fillText("GOAL", target.x - 18, target.y + 4);
            ctx.shadowBlur = 0;
        }

        function drawTrail() {
            if (particle.trail.length < 2) return;

            // [ìˆ˜ì •] ìŠ¤ì¼€ì¼ ê³„ì‚°
            const DESIGN_WIDTH = 1200;
            const scale = Math.min(1.0, width / DESIGN_WIDTH);

            const color = physics[state.particleType].color;
            ctx.strokeStyle = color;
            
            // [ìˆ˜ì •] ì„  êµµê¸°ë„ í™”ë©´ì— ë¹„ë¡€í•´ì„œ ì–‡ì•„ì§
            ctx.lineWidth = Math.max(1, 3 * scale); 
            
            ctx.lineCap = 'round';
            ctx.shadowBlur = 10 * scale; // ê·¸ë¦¼ìë„ ìŠ¤ì¼€ì¼ë§
            ctx.shadowColor = color;
            
            ctx.beginPath();
            ctx.moveTo(particle.trail[0].x, particle.trail[0].y);
            for (let p of particle.trail) ctx.lineTo(p.x, p.y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawParticle() {
            // [ìˆ˜ì •] í™”ë©´ í¬ê¸°ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ ê³„ì‚°
            const DESIGN_WIDTH = 1200;
            const scale = Math.min(1.0, width / DESIGN_WIDTH);

            const pProp = physics[state.particleType];
            
            // [ìˆ˜ì •] ì…ì í¬ê¸°ë„ í™”ë©´ì— ë¹„ë¡€í•´ì„œ ì‘ì•„ì§ (ìµœì†Œ 3pxì€ ìœ ì§€)
            const baseR = pProp.name === 'Alpha' ? 10 : 6;
            const r = Math.max(3, baseR * scale); 
            
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, r, 0, Math.PI*2);
            ctx.fill();
            
            // í›„ê´‘ íš¨ê³¼
            ctx.shadowBlur = 20 * scale; // í›„ê´‘ ë²”ìœ„ë„ ìŠ¤ì¼€ì¼ë§
            ctx.shadowColor = pProp.color;
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, r + (4 * scale), 0, Math.PI*2);
            ctx.fillStyle = pProp.color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function drawVectors() {
            if (!state.running) return;
            // ë²¡í„° ê·¸ë¦¬ê¸° (ìƒëµ ê°€ëŠ¥í•˜ë‚˜ êµìœ¡ì  ëª©ì ì„ ìœ„í•´ ìœ ì§€)
        }

        function drawArrow(x1, y1, x2, y2, head) {
            const angle = Math.atan2(y2-y1, x2-x1);
            ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
            ctx.lineTo(x2 - head * Math.cos(angle - Math.PI/6), y2 - head * Math.sin(angle - Math.PI/6));
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - head * Math.cos(angle + Math.PI/6), y2 - head * Math.sin(angle + Math.PI/6));
        }

        function loop() {
            updatePhysics();
            draw();
            animationId = requestAnimationFrame(loop);
        }

        init();
    </script>
</body>
</html>