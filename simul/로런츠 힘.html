<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ë¡œìŠ¤ í•„ë“œ: ì…ì ê°€ì† ì‹œë®¬ë ˆì´í„°</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Share+Tech+Mono&display=swap');

        :root {
            --bg-color: #050a14;
            --panel-bg: rgba(15, 23, 42, 0.85);
            --text-color: #e0e6ed;
            --accent-color: #00f2fe; /* Cyan */
            --danger-color: #ff4757; /* Electric */
            --warning-color: #ffa502; /* Magnetic */
            --success-color: #2ed573;
            --obstacle-color: #ff6b6b;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: var(--text-color);
            font-family: 'Montserrat', sans-serif;
        }

        /* ê²Œì„ ì»¨í…Œì´ë„ˆ: ì „ì²´ í™”ë©´ */
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: radial-gradient(circle at center, #0b1021 0%, #000000 100%);
        }

        /* ìº”ë²„ìŠ¤ */
        #simCanvas {
            display: block;
            width: 100%;
            height: 100%;
            border-top: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: crosshair;
        }

        /* [ê°€ë¡œ ëª¨ë“œ ìœ ë„ í™”ë©´] */
        #rotate-warning {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #050a14;
            z-index: 9999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        .phone-icon { font-size: 3rem; animation: rotatePhone 1.5s infinite; margin-bottom: 20px; }
        
        @keyframes rotatePhone {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(-90deg); }
            100% { transform: rotate(0deg); }
        }

        @media screen and (orientation: portrait) {
            #rotate-warning { display: flex; }
            #game-container { display: none; }
        }

        /* --- UI ìš”ì†Œ ìŠ¤íƒ€ì¼ --- */

        /* ìƒë‹¨: ìˆ˜ì‹ ëŒ€ì‹œë³´ë“œ (HUD) */
        #hud {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 40px;
            z-index: 10;
        }

        .hud-box {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Share Tech Mono', monospace;
            text-align: center;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            min-width: 140px;
        }
        .hud-label { font-size: 0.8rem; color: #aaa; margin-bottom: 5px; }
        .hud-val { font-size: 1.2rem; font-weight: bold; }
        .force-eq { font-size: 1.5rem; font-weight: bold; color: #555; align-self: center;}
        .force-eq.balanced { color: var(--success-color); text-shadow: 0 0 10px var(--success-color); }

        /* ì¢Œì¸¡ ìƒë‹¨: ì…ì ì„ íƒê¸° */
        #particleSelector {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--panel-bg);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            z-index: 20;
        }
        .p-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.6;
            transition: 0.2s;
        }
        .p-option:hover, .p-option.active { opacity: 1; }
        .p-option.active { color: var(--accent-color); font-weight: bold; }
        .p-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; background: #fff; }

        /* ìš°ì¸¡ ìƒë‹¨: ê²Œì„ ëª¨ë“œ ë²„íŠ¼ */
        #gameModePanel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* ë ˆë²¨ ë°°ì§€ */
        .level-badge {
            display: none;
            background: var(--warning-color);
            color: #000;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8rem;
            box-shadow: 0 0 10px var(--warning-color);
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 30px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        
        #challengeBtn { background: transparent; border: 2px solid var(--warning-color); color: var(--warning-color); }
        #challengeBtn:hover, #challengeBtn.active { background: var(--warning-color); color: #000; box-shadow: 0 0 20px var(--warning-color); }

        #auroraBtn { 
            background: transparent; 
            border: 2px solid #a29bfe;
            color: #a29bfe; 
        }
        #auroraBtn:hover { 
            background: #a29bfe; 
            color: #000; 
            box-shadow: 0 0 20px #a29bfe;
            transform: translateY(-2px);
        }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ (ì™„ì „ ë³µêµ¬ë¨) */
        #controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            
            /* í•µì‹¬ ë³€ê²½: íˆ¬ëª…ë„ë¥¼ 0.2ë¡œ ë‚®ì¶°ì„œ ë’¤ê°€ í›¤íˆ ë¹„ì¹˜ê²Œ í•¨ */
            background: rgba(15, 23, 42, 0.2); 
            
            /* ë°°ê²½ì„ íë¦¬ê²Œ ì²˜ë¦¬í•´ì„œ ê¸€ì”¨ ê°€ë…ì„± í™•ë³´ (ìœ ë¦¬ ê°™ì€ ëŠë‚Œ) */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px); /* ì‚¬íŒŒë¦¬ í˜¸í™˜ */

            padding: 20px 40px;
            border-radius: 20px;
            
            /* í…Œë‘ë¦¬ë„ ë” ì—°í•˜ê²Œ */
            border: 1px solid rgba(255, 255, 255, 0.08);
            
            display: flex;
            gap: 30px;
            align-items: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); /* ê·¸ë¦¼ìë„ ì—°í•˜ê²Œ */
            z-index: 100;
        }

        .control-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .control-group label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ (ì¤‘ì•™ ì •ë ¬ ì™„ë²½ í•´ê²°) */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            margin: 10px 0;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #fff;
            cursor: pointer;
            margin-top: -6px; /* (4px - 16px) / 2 = -6px (ì¤‘ì•™ ì •ë ¬) */
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        
        .value-display { font-family: 'Share Tech Mono', monospace; font-size: 0.9rem; color: #fff; margin-top: 5px; }

        #launchBtn { 
            background: var(--accent-color); 
            color: #000; 
            padding: 15px 30px;
            font-size: 1.1rem;
        }
        #launchBtn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--accent-color); }

        /* ë©”ì‹œì§€ */
        #message {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem; font-weight: 800;
            text-align: center;
            opacity: 0; pointer-events: none;
            transition: 0.3s;
            z-index: 200; text-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* [ëª¨ë°”ì¼/ì‘ì€ í™”ë©´ ì „ìš© ìŠ¤íƒ€ì¼] */
        @media screen and (max-width: 900px), screen and (max-height: 600px) {
            #hud { top: 5px; gap: 8px; }
            .hud-box { padding: 4px 8px; min-width: 60px; border-radius: 5px; }
            .hud-label { font-size: 0.55rem; margin-bottom: 2px; }
            .hud-val { font-size: 0.8rem; }
            .force-eq { font-size: 0.9rem; }

            #particleSelector { top: 5px; left: 5px; padding: 6px; border-radius: 10px; }
            .p-option { font-size: 0.65rem; margin-bottom: 3px; }
            .p-dot { width: 6px; height: 6px; margin-right: 4px; }

            #gameModePanel { top: 5px; right: 5px; gap: 5px; }
            .button-container { gap: 5px; }
            .btn { padding: 6px 12px; font-size: 0.7rem; border-radius: 15px; border-width: 1.5px; }
            .level-badge { font-size: 0.65rem; padding: 2px 5px; }

            #controls { 
                bottom: 10px; 
                padding: 10px 15px; 
                gap: 10px; 
                width: 95%; 
                border-radius: 15px;
            }
            .control-group label { font-size: 0.65rem; margin-bottom: 2px; }
            .value-display { font-size: 0.7rem; margin-top: 2px; }
            #launchBtn { padding: 8px 16px; font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <div id="rotate-warning">
        <div class="phone-icon">ğŸ“±</div>
        <p>ê°€ë¡œ ëª¨ë“œë¡œ ëŒë ¤ì£¼ì„¸ìš”<br>(Please Rotate Your Device)</p>
    </div>

    <div id="game-container">
        
        <div id="hud">
            <div class="hud-box" style="border-color: var(--danger-color);">
                <div class="hud-label">ELECTRIC FORCE (Fe = qE)</div>
                <div class="hud-val" id="hudFe" style="color: var(--danger-color);">0.00</div>
            </div>
            <div class="force-eq" id="eqSign">â‰ </div>
            <div class="hud-box" style="border-color: var(--warning-color);">
                <div class="hud-label">MAGNETIC FORCE (Fb = qvB)</div>
                <div class="hud-val" id="hudFb" style="color: var(--warning-color);">0.00</div>
            </div>
        </div>

        <div id="particleSelector">
            <div class="hud-label" style="margin-bottom:10px;">PARTICLE TYPE</div>
            <div class="p-option active" onclick="setParticle('proton', this)">
                <div class="p-dot" style="background: #ff4757;"></div> Proton (p+)
            </div>
            <div class="p-option" onclick="setParticle('electron', this)">
                <div class="p-dot" style="background: #00f2fe;"></div> Electron (e-)
            </div>
            <div class="p-option" onclick="setParticle('alpha', this)">
                <div class="p-dot" style="background: #2ed573;"></div> Alpha (He2+)
            </div>
        </div>

        <div id="gameModePanel">
            <div id="levelBadge" class="level-badge">LEVEL 1</div>
            <div class="button-container">
                <button id="challengeBtn" class="btn">CHALLENGE MODE</button>
                <button id="auroraBtn" class="btn">PROJECT: AURORA</button>
            </div>
        </div>

        <div id="message"></div>

        <canvas id="simCanvas"></canvas>

        <div id="controls">
            <div class="control-group">
                <label style="color:var(--danger-color)">E-FIELD</label>
                <input type="range" id="eSlider" min="-5" max="5" step="0.1" value="0">
                <div class="value-display" id="eVal">0.0</div>
            </div>
            <div class="control-group">
                <label style="color:var(--warning-color)">B-FIELD</label>
                <input type="range" id="bSlider" min="-2" max="2" step="0.1" value="0">
                <div class="value-display" id="bVal">0.0</div>
            </div>
            <div class="control-group">
                <label style="color:var(--accent-color)">VELOCITY</label>
                <input type="range" id="vSlider" min="1" max="10" step="0.5" value="5">
                <div class="value-display" id="vVal">5.0</div>
            </div>
            <button id="launchBtn" class="btn">LAUNCH</button>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height; // ì „ì—­ ë³€ìˆ˜
        let animationId;
        
        // --- 1. ìƒíƒœ ë° ë¬¼ë¦¬ ì„¤ì • ---
        const physics = {
            proton: { m: 2.0, q: 1, color: '#ff4757', name: 'Proton' },
            electron: { m: 0.5, q: -1, color: '#00f2fe', name: 'Electron' }, 
            alpha: { m: 8.0, q: 2, color: '#2ed573', name: 'Alpha' }
        };

        const state = {
            E: 0, B: 0, v0: 5,
            running: false,
            mode: 'free', 
            level: 1,
            particleType: 'proton'
        };

        let particle = { x: 0, y: 0, vx: 0, vy: 0, trail: [] };
        let target = { x: 0, y: 0, radius: 30, active: false };
        let obstacles = [];

        // --- 2. ì´ˆê¸°í™” ---
        function init() {
            window.addEventListener('resize', resize);
            
            document.getElementById('eSlider').addEventListener('input', updateUI);
            document.getElementById('bSlider').addEventListener('input', updateUI);
            document.getElementById('vSlider').addEventListener('input', updateUI);
            document.getElementById('launchBtn').addEventListener('click', launch);
            document.getElementById('challengeBtn').addEventListener('click', toggleChallenge);
            document.getElementById('auroraBtn').addEventListener('click', function() {
                window.location.href = 'ì˜¤ë¡œë¼.html';
            });

            updateUI();
            
            // í™”ë©´ í¬ê¸° ì„¤ì • ë° ìµœì´ˆ ë“œë¡œìš° (ì¤‘ìš”: ê¹Œë§Œ í™”ë©´ ë°©ì§€)
            resize(); 

            // ë£¨í”„ ì‹œì‘
            requestAnimationFrame(loop);
        }

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;

            canvas.width = width;
            canvas.height = height;

            const container = document.getElementById('game-container');
            if(container) container.style.transform = 'none';

            if (state.mode === 'challenge') {
                setupLevel(state.level); 
            } else {
                target.x = width - 100;
                target.y = height / 2;
            }

            resetSystem();
            draw(); // ë¦¬ì‚¬ì´ì¦ˆ ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 
        }

        // --- 3. ë¡œì§ ì œì–´ ---
        function setParticle(type, el) {
            state.particleType = type;
            document.querySelectorAll('.p-option').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
            
            if(state.running) launch();
            else resetSystem();
        }

        function updateUI() {
            state.E = parseFloat(document.getElementById('eSlider').value);
            state.B = parseFloat(document.getElementById('bSlider').value);
            state.v0 = parseFloat(document.getElementById('vSlider').value);

            document.getElementById('eVal').textContent = state.E.toFixed(1);
            document.getElementById('bVal').textContent = state.B.toFixed(1);
            document.getElementById('vVal').textContent = state.v0.toFixed(1);

            updateHUD();
        }

        function updateHUD() {
            const p = physics[state.particleType];
            // í™”ë©´ ë†’ì´ ìŠ¤ì¼€ì¼(ì „ê¸°ì¥) ì ìš©í•˜ì—¬ í‘œì‹œê°’ê³¼ ì‹¤ì œ í˜ ì‹±í¬ ë§ì¶¤
            const scaleY = Math.min(1.0, height / 700); 
            const Fe = Math.abs(p.q * state.E * scaleY); 
            const Fb = Math.abs(p.q * state.v0 * state.B); 

            document.getElementById('hudFe').textContent = Fe.toFixed(2);
            document.getElementById('hudFb').textContent = Fb.toFixed(2);

            const eqSign = document.getElementById('eqSign');
            if (state.running && Math.abs(Fe - Fb) < 0.1 && Fe > 0) {
                eqSign.textContent = "=";
                eqSign.classList.add('balanced');
            } else {
                eqSign.textContent = "vs";
                eqSign.classList.remove('balanced');
            }
        }

        function toggleChallenge() {
            const btn = document.getElementById('challengeBtn');
            const badge = document.getElementById('levelBadge');
            
            if (state.mode === 'free') {
                state.mode = 'challenge';
                state.level = 1;
                btn.classList.add('active');
                btn.textContent = "EXIT CHALLENGE";
                badge.style.display = 'block';
                setupLevel(1);
                showMsg("LEVEL 1 START", "#fff");
            } else {
                state.mode = 'free';
                btn.classList.remove('active');
                btn.textContent = "CHALLENGE MODE";
                badge.style.display = 'none';
                target.active = false;
                obstacles = [];
            }
            resetSystem();
        }

        function setupLevel(lvl) {
            target.active = true;
            obstacles = [];
            document.getElementById('levelBadge').textContent = `LEVEL ${lvl}`;

            // í™”ë©´ì˜ ì¤‘ì•™ ì¢Œí‘œ
            const cx = width / 2;
            const cy = height / 2;

            if (lvl === 1) {
                // [LEVEL 1: ê³„ë‹¨í˜• í„°ë„]
                // í™”ë©´ ë†’ì´ì˜ 30% ì§€ì (ìƒë‹¨)ì— í„°ë„ ìƒì„±
                const tunnelY = height * 0.3; 
                
                target.x = width * 0.9; // ì˜¤ë¥¸ìª½ 90% ì§€ì 
                target.y = tunnelY;

                // 1. ì•„ë˜ìª½ ë²½ (í„°ë„ ë°”ë‹¥)
                obstacles.push({ 
                    x: width * 0.25, // ì™¼ìª½ 25% ì§€ì ë¶€í„° ì‹œì‘
                    y: tunnelY + 40, 
                    w: width * 0.75, // ë‚˜ë¨¸ì§€ ê¸¸ì´ ê½‰ ì±„ì›€
                    h: height 
                }); 

                // 2. ìœ„ìª½ ë²½ (í„°ë„ ì²œì¥)
                obstacles.push({ 
                    x: width * 0.25, 
                    y: 0, 
                    w: width * 0.75, 
                    h: tunnelY - 40 
                });

            } else if (lvl === 2) {
                // [LEVEL 2: ì§€ê·¸ì¬ê·¸ ìµìŠ¤íŠ¸ë¦¼]
                target.x = width * 0.95;
                target.y = cy - (height * 0.15); // ì•½ê°„ ìœ„ìª½

                // ë²½ ë°°ì¹˜ ê°„ê²© (ì „ì²´ ë„ˆë¹„ì˜ 25% ì§€ì ë¶€í„° ì‹œì‘)
                const startX = width * 0.25;
                const interval = (width * 0.6) / 3; // 60% ê³µê°„ì„ 3ë“±ë¶„
                const wallW = width * 0.025; // ë²½ ë‘ê»˜ëŠ” í™”ë©´ ë„ˆë¹„ì˜ 2.5%
                const holeSize = height * 0.2; // êµ¬ë© í¬ê¸°ëŠ” í™”ë©´ ë†’ì´ì˜ 20%

                // 1. ì²« ë²ˆì§¸ ë²½ (ì•„ë˜ì—ì„œ ì†ŸìŒ)
                obstacles.push({ 
                    x: startX, 
                    y: cy - holeSize/2, 
                    w: wallW, 
                    h: height 
                });

                // 2. ë‘ ë²ˆì§¸ ë²½ (ìœ„ì—ì„œ ë‚´ë ¤ì˜´)
                obstacles.push({ 
                    x: startX + interval, 
                    y: 0, 
                    w: wallW, 
                    h: cy + holeSize/2 
                });

                // 3. ì„¸ ë²ˆì§¸ ë²½ (ì•„ë˜ì—ì„œ ì†ŸìŒ)
                obstacles.push({ 
                    x: startX + interval * 2, 
                    y: cy - holeSize/2, 
                    w: wallW, 
                    h: height 
                });

                // ì²œì¥/ë°”ë‹¥ ì•ˆì „í„± (í™”ë©´ ë†’ì´ì˜ 5%)
                const borderH = height * 0.05;
                obstacles.push({ x: 0, y: 0, w: width, h: borderH }); 
                obstacles.push({ x: 0, y: height - borderH, w: width, h: borderH });

            } else if (lvl === 3) {
                // [LEVEL 3: U-Turn]
                target.x = cx;
                target.y = cy;

                // ê°ì˜¥ í¬ê¸° (í™”ë©´ ë†’ì´ ê¸°ì¤€ 15%)
                const boxSize = height * 0.15;
                const wallThick = 20;

                // 'ã„·'ì ê°ì˜¥ (í™”ë©´ ì¤‘ì•™ ê¸°ì¤€)
                // ì™¼ìª½ ë²½ (ë§‰í˜)
                obstacles.push({ 
                    x: cx - boxSize, 
                    y: cy - boxSize, 
                    w: wallThick, 
                    h: boxSize * 2 
                });
                // ìœ„ìª½ ë²½
                obstacles.push({ 
                    x: cx - boxSize, 
                    y: cy - boxSize, 
                    w: boxSize * 2, 
                    h: wallThick 
                });
                // ì•„ë˜ìª½ ë²½
                obstacles.push({ 
                    x: cx - boxSize, 
                    y: cy + boxSize - wallThick, 
                    w: boxSize * 2, 
                    h: wallThick 
                });
                
                // ìœ„ì•„ë˜ ì¤‘ì•™ ê°€ì´ë“œ ë²½
                obstacles.push({ x: cx, y: 0, w: wallThick, h: height * 0.2 });
                obstacles.push({ x: cx, y: height * 0.8, w: wallThick, h: height * 0.2 });
            }
        }

        function resetSystem() {
            particle.x = 80;
            particle.y = height / 2;
            particle.vx = state.v0;
            particle.vy = 0;
            particle.trail = [];
            state.running = false;
            
            if(state.mode === 'free') target.active = false;
            
            document.getElementById('message').style.opacity = 0;
            document.getElementById('eqSign').classList.remove('balanced');
            
            // ë¦¬ì…‹ ì‹œì—ë„ í™”ë©´ í•œë²ˆ ê·¸ë¦¼
            draw();
        }

        function launch() {
            resetSystem();
            
            // [ìˆ˜ì •] ì†ë„ëŠ” 'ë„ˆë¹„' ê¸°ì¤€ ìŠ¤ì¼€ì¼ (ê°€ë¡œê°€ ì¢ìœ¼ë©´ ëŠë¦¬ê²Œ)
            const scaleX = Math.min(1.0, width / 1200);
            particle.vx = state.v0 * scaleX; 
            state.running = true;
        }

        // --- 4. ë¬¼ë¦¬ ì—”ì§„ (FPS 60 ê³ ì • + ìŠ¤ì¼€ì¼ ë¶„ë¦¬) ---
        function updatePhysics() {
            if (!state.running) return;

            // [ì¤‘ìš”] ì „ê¸°ì¥ì€ 'ë†’ì´' ê¸°ì¤€, ì†ë„ëŠ” 'ë„ˆë¹„' ê¸°ì¤€
            const scaleY = Math.min(1.0, height / 700); 

            const originalDt = 0.2; 
            const steps = 20; 
            const dt = originalDt / steps; 

            const pProp = physics[state.particleType];

            for (let i = 0; i < steps; i++) {
                const scaledE = state.E * scaleY; // ì „ê¸°ì¥ë§Œ YìŠ¤ì¼€ì¼ ì ìš©
                const Fe_y = pProp.q * scaledE;

                const Fb_x = pProp.q * particle.vy * state.B;
                const Fb_y = -pProp.q * particle.vx * state.B;

                const Fnet_x = Fb_x;
                const Fnet_y = Fe_y + Fb_y;

                const ax = Fnet_x / pProp.m;
                const ay = Fnet_y / pProp.m;

                particle.vx += ax * dt;
                particle.vy += ay * dt;
                particle.x += particle.vx * dt;
                particle.y += particle.vy * dt;
            }

            particle.trail.push({x: particle.x, y: particle.y});

            // í™”ë©´ ì´íƒˆ
            if (particle.x > width + 50 || particle.x < -50 || particle.y > height + 50 || particle.y < -50) {
                state.running = false;
                if(state.mode === 'challenge') failLevel();
            }

            if (state.mode === 'challenge') checkCollisions();
            updateHUD();
        }

        function checkCollisions() {
            const dx = particle.x - target.x;
            const dy = particle.y - target.y;
            if (Math.hypot(dx, dy) < target.radius) {
                winLevel();
                return;
            }
            for (let obs of obstacles) {
                if (particle.x > obs.x && particle.x < obs.x + obs.w &&
                    particle.y > obs.y && particle.y < obs.y + obs.h) {
                    failLevel("CRASHED!");
                    return;
                }
            }
        }

        function winLevel() {
            state.running = false;
            if (state.level < 3) {
                showMsg(`LEVEL ${state.level} CLEARED!`, "var(--success-color)");
                setTimeout(() => {
                    state.level++;
                    setupLevel(state.level);
                    resetSystem();
                    showMsg(`LEVEL ${state.level} START`, "#fff");
                }, 2000);
            } else {
                showMsg("ALL LEVELS COMPLETED!", "var(--accent-color)");
            }
        }

        function failLevel(text = "MISSED!") {
            state.running = false;
            showMsg(text, "var(--obstacle-color)");
        }

        function showMsg(text, color) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.style.color = color;
            msg.style.opacity = 1;
            msg.style.textShadow = `0 0 30px ${color}`;
        }

        // --- 5. ë Œë”ë§ ---
        function draw() {
            if(!width || !height) return; // ì•ˆì „ì¥ì¹˜

            ctx.clearRect(0, 0, width, height);

            drawGrid();
            drawFields();
            
            if (state.mode === 'challenge') {
                drawTarget();
                drawObstacles();
            }

            drawTrail();
            drawParticle();
        }

        function drawGrid() {
            ctx.strokeStyle = "rgba(0, 242, 254, 0.05)";
            ctx.lineWidth = 1;
            const size = 60;
            ctx.beginPath();
            for (let x = 0; x < width; x += size) { ctx.moveTo(x, 0); ctx.lineTo(x, height); }
            for (let y = 0; y < height; y += size) { ctx.moveTo(0, y); ctx.lineTo(width, y); }
            ctx.stroke();
        }

        function drawFields() {
            // ì „ê¸°ì¥ (Plate)
            if (state.E !== 0) {
                const color = state.E > 0 ? "255, 71, 87" : "0, 242, 254";
                ctx.fillStyle = `rgba(${color}, 0.1)`;
                ctx.fillRect(0, 0, width, 20);
                ctx.fillRect(0, height-20, width, 20);
                
                ctx.strokeStyle = `rgba(${color}, 0.5)`;
                ctx.beginPath();
                // [ìˆ˜ì •] ì „ê¸°ì¥ ë°©í–¥: ì–‘ìˆ˜ë©´ ìœ„->ì•„ë˜, ìŒìˆ˜ë©´ ì•„ë˜->ìœ„
                for(let x=50; x<width; x+=100) {
                    if(state.E > 0) drawArrow(x, 30, x, height-30, 8);
                    else drawArrow(x, height-30, x, 30, 8);
                }
                ctx.stroke();
            }
            // ìê¸°ì¥
            if (state.B !== 0) {
                ctx.fillStyle = "rgba(255, 165, 2, 0.3)";
                ctx.font = "20px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                const symbol = state.B > 0 ? "âœ•" : "â—";
                for(let x=50; x<width; x+=100) {
                    for(let y=50; y<height; y+=100) {
                        ctx.fillText(symbol, x, y);
                    }
                }
            }
        }

        function drawObstacles() {
            ctx.save();
            for (let obs of obstacles) {
                ctx.beginPath();
                ctx.rect(obs.x, obs.y, obs.w, obs.h);
                ctx.clip();
                ctx.fillStyle = "rgba(255, 107, 107, 0.2)";
                ctx.fill();
                ctx.strokeStyle = "var(--obstacle-color)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                for (let i = -obs.h; i < obs.w + obs.h; i += 15) {
                    ctx.moveTo(obs.x + i, obs.y);
                    ctx.lineTo(obs.x + i + obs.h + 20, obs.y + obs.h + 20);
                }
                ctx.stroke();
                ctx.strokeStyle = "var(--obstacle-color)";
                ctx.lineWidth = 3;
                ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                ctx.restore(); 
                ctx.save();
            }
            ctx.restore();
        }

        function drawTarget() {
            if (!target.active) return;
            const color = "var(--success-color)";
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.shadowBlur = 15;
            ctx.shadowColor = color;
            ctx.beginPath();
            // íƒ€ê²Ÿ ì• ë‹ˆë©”ì´ì…˜ (ì‹œê°„ê°’ í•„ìš”í•˜ë¯€ë¡œ date ì‚¬ìš©)
            const t = Date.now() / 300;
            ctx.arc(target.x, target.y, target.radius, t, t + Math.PI * 1.5);
            ctx.stroke();
            ctx.font = "12px sans-serif";
            ctx.fillStyle = color;
            ctx.fillText("GOAL", target.x - 18, target.y + 4);
            ctx.shadowBlur = 0;
        }

        function drawTrail() {
            if (particle.trail.length < 2) return;
            // ì‹œê° íš¨ê³¼ëŠ” 'ë„ˆë¹„' ê¸°ì¤€
            const scaleX = Math.min(1.0, width / 1200);
            const color = physics[state.particleType].color;
            ctx.strokeStyle = color;
            ctx.lineWidth = Math.max(1, 3 * scaleX); 
            ctx.lineCap = 'round';
            ctx.shadowBlur = 10 * scaleX; 
            ctx.shadowColor = color;
            ctx.beginPath();
            ctx.moveTo(particle.trail[0].x, particle.trail[0].y);
            for (let p of particle.trail) ctx.lineTo(p.x, p.y);
            ctx.stroke();
            ctx.shadowBlur = 0;
        }

        function drawParticle() {
            const scaleX = Math.min(1.0, width / 1200);
            const pProp = physics[state.particleType];
            const baseR = pProp.name === 'Alpha' ? 10 : 6;
            const r = Math.max(3, baseR * scaleX); 
            
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, r, 0, Math.PI*2);
            ctx.fill();
            
            ctx.shadowBlur = 20 * scaleX; 
            ctx.shadowColor = pProp.color;
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, r + (4 * scaleX), 0, Math.PI*2);
            ctx.fillStyle = pProp.color;
            ctx.fill();
            ctx.shadowBlur = 0;
        }

        function drawArrow(x1, y1, x2, y2, head) {
            const angle = Math.atan2(y2-y1, x2-x1);
            ctx.moveTo(x1, y1); ctx.lineTo(x2, y2);
            ctx.lineTo(x2 - head * Math.cos(angle - Math.PI/6), y2 - head * Math.sin(angle - Math.PI/6));
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - head * Math.cos(angle + Math.PI/6), y2 - head * Math.sin(angle + Math.PI/6));
        }

        // --- 6. ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ (FPS 60 ê³ ì •) ---
        let lastTime = 0;
        const fpsInterval = 1000 / 60; // 60FPS

        function loop(timestamp) {
            animationId = requestAnimationFrame(loop);

            if (!lastTime) { lastTime = timestamp; return; }
            const elapsed = timestamp - lastTime;

            if (elapsed > fpsInterval) {
                lastTime = timestamp - (elapsed % fpsInterval);
                updatePhysics();
                draw();
            }
        }

        // ì‹¤í–‰
        init();
    </script>
</body>
</html>