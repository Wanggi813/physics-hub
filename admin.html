<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì‹œ(ë¬¼ë¦¬)ì—ì´ì…˜ ê´€ë¦¬ì í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#020617;
      --panel:#050b1c;
      --ink:#e5e7eb;
      --muted:#9ca3af;
      --accent:#4f46e5;
      --accent-soft:#6366f1;
      --danger:#ef4444;
      --ok:#22c55e;
      --line:#1f2937;
      --radius:14px;
      --shadow:0 18px 40px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font:14px/1.6 system-ui,"Pretendard","Noto Sans KR",sans-serif;
      background:
        radial-gradient(900px 600px at 0% 0%,rgba(79,70,229,.35),transparent 55%),
        radial-gradient(900px 600px at 100% 100%,rgba(14,165,233,.25),transparent 55%),
        #020617;
      color:var(--ink);
      padding:24px 16px 40px;
    }
    .wrap{
      max-width:960px;
      margin:0 auto;
    }
    h1{
      margin:0 0 6px;
      font-size:22px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    h1 span.logo{
      width:28px;
      height:28px;
      border-radius:10px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:#111827;
      border:1px solid rgba(148,163,255,.4);
      font-size:16px;
    }
    .subtitle{
      margin:0 0 20px;
      font-size:13px;
      color:var(--muted);
    }
    .card{
      background:rgba(15,23,42,.9);
      border-radius:var(--radius);
      border:1px solid rgba(55,65,81,.9);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      margin-bottom:16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:16px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      background:rgba(79,70,229,.14);
      border:1px solid rgba(129,140,248,.6);
      color:#c7d2fe;
    }
    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
    }
    input{
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid #374151;
      background:#020617;
      color:var(--ink);
      font-size:13px;
      margin-bottom:8px;
    }
    input:focus{
      outline:none;
      border-color:var(--accent-soft);
      box-shadow:0 0 0 1px rgba(99,102,241,.6);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .row > div{
      flex:1 1 180px;
    }
    button{
      border:none;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      cursor:pointer;
      background:linear-gradient(180deg,var(--accent-soft),#312e81);
      color:#e5e7eb;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    button.secondary{
      background:transparent;
      border:1px solid rgba(148,163,255,.7);
      color:#e5e7eb;
    }
    button.danger{
      background:linear-gradient(180deg,#ef4444,#b91c1c);
      border:none;
      color:#fee2e2;
    }
    button.small{
      padding:4px 10px;
      font-size:12px;
    }
    button:disabled{
      opacity:.5;
      cursor:default;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .status-line{
      margin-top:8px;
      font-size:12px;
    }
    .status-ok{color:var(--ok);}
    .status-err{color:var(--danger);}
    .lock-card{
      max-width:420px;
      margin:40px auto 0;
      text-align:left;
    }
    .lock-title{
      font-size:15px;
      margin:0 0 4px;
    }
    .lock-sub{
      margin:0 0 14px;
      font-size:13px;
      color:var(--muted);
    }
    .pill{
      display:inline-flex;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(148,163,255,.5);
      font-size:11px;
      color:#c7d2fe;
      margin-left:4px;
    }
    .mt-8{margin-top:8px;}
    .mt-4{margin-top:4px;}
    .flex-between{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:center;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #1f2937;
    }
    th{
      text-align:left;
      color:#9ca3af;
      font-weight:500;
      background:#050816;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,.6);
    }
    .tag{
      display:inline-flex;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid #374151;
      font-size:11px;
      color:#9ca3af;
    }
    .small{
      font-size:11px;
      color:#6b7280;
    }
    .scroll{
      max-height:280px;
      overflow:auto;
      margin-top:6px;
      border-radius:10px;
      border:1px solid #1f2937;
    }
    .csv-table-wrap{
      max-height:260px;
      overflow:auto;
      border-radius:10px;
      border:1px solid #1f2937;
      margin-top:8px;
    }
    .mono{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>
      <span class="logo">âš›ï¸</span>
      ì‹œ(ë¬¼ë¦¬)ì—ì´ì…˜ ê´€ë¦¬ì
      <span class="pill">ê´€ë¦¬ì ì „ìš©</span>
    </h1>
    <p class="subtitle">
      Firebase Authentication / Firestoreë¥¼ ì´ìš©í•´ í•™ìƒ ê³„ì •ì„ ë“±ë¡Â·ê´€ë¦¬í•˜ëŠ” í˜ì´ì§€ì…ë‹ˆë‹¤.
    </p>

    <div class="card lock-card" id="lock-card">
      <p class="lock-title">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸</p>
      <p class="lock-sub">
        ì„ ìƒë‹˜ë§Œ ì ‘ì†í•˜ëŠ” ê´€ë¦¬ì í˜ì´ì§€ì…ë‹ˆë‹¤. ì‚¬ì „ì— ì •í•´ ë‘” ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
      </p>
      <label for="admin-pass">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="admin-pass" placeholder="ì˜ˆ: physics-2025-!@#" />
      <div class="flex-between mt-8">
        <button id="btn-admin-enter">ê´€ë¦¬ì ëª¨ë“œ ì…ì¥</button>
        <button type="button" class="secondary small" id="btn-toggle-pass">í‘œì‹œ</button>
      </div>
      <p class="hint mt-4">
        âš  ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ë‹¨ìˆœ í”„ë¡ íŠ¸ì—”ë“œ ì ê¸ˆì…ë‹ˆë‹¤. í•™ìƒì—ê²Œ ê³µìœ í•˜ì§€ ë§ê³ , GitHubì— ì˜¬ë¦´ ê²½ìš°ì—ëŠ”
        ë‚˜ì¤‘ì— í™˜ê²½ë³€ìˆ˜/ì„œë²„ ë“±ìœ¼ë¡œ ìˆ¨ê²¨ì£¼ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
      </p>
      <p class="status-line" id="admin-lock-status"></p>
    </div>

    <div id="admin-main" style="display:none;">

      <div class="card">
        <h2>ğŸ§‘â€ğŸ“ ë‹¨ì¼ í•™ìƒ ê³„ì • ìƒì„± <span class="badge">ID / ë¹„ë°€ë²ˆí˜¸ ë°°í¬ìš©</span></h2>
        <p class="hint">
          ì—¬ê¸°ì„œ ë§Œë“  ê³„ì •ì€ <span class="tag">index.html</span>ì˜ ë¡œê·¸ì¸ ì°½ì—ì„œ ì•„ì´ë””ë§Œ ì…ë ¥í•´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          (ë‚´ë¶€ì ìœ¼ë¡œ <code class="mono">ì•„ì´ë””@myapp.local</code> ì´ë©”ì¼ í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.)
        </p>
        <div class="row mt-8">
          <div>
            <label for="new-id">í•™ìƒ ì•„ì´ë””</label>
            <input type="text" id="new-id" placeholder="ì˜ˆ: s1A_01" />
          </div>
          <div>
            <label for="new-pass">ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="new-pass" placeholder="ìµœì†Œ 6ìë¦¬" />
          </div>
          <div>
            <label for="new-pass2">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
            <input type="password" id="new-pass2" placeholder="ë‹¤ì‹œ ì…ë ¥" />
          </div>
        </div>

        <div class="row mt-4">
          <div>
            <label for="auto-prefix">ID ì ‘ë‘ì–´ (ì„ íƒ)</label>
            <input type="text" id="auto-prefix" placeholder="ì˜ˆ: s1A_" />
          </div>
          <div>
            <label for="auto-start">ì‹œì‘ ë²ˆí˜¸</label>
            <input type="number" id="auto-start" value="1" />
          </div>
          <div>
            <label for="auto-digits">ë²ˆí˜¸ ìë¦¬ìˆ˜</label>
            <input type="number" id="auto-digits" value="2" />
          </div>
        </div>
        <div class="flex-between mt-4">
          <div style="display:flex;gap:8px;align-items:center;">
            <button type="button" class="secondary small" id="btn-auto-id">ID ìë™ ìƒì„±</button>
            <span class="small">ì˜ˆ: prefix = <span class="mono">s1A_</span>, ì‹œì‘ë²ˆí˜¸=1, ìë¦¬ìˆ˜=2 â†’ <span class="mono">s1A_01</span></span>
          </div>
          <button id="btn-create">ê³„ì • ìƒì„±</button>
        </div>
        <p class="status-line" id="create-status"></p>
      </div>

      <div class="card">
        <h2>ğŸ“¥ CSV ì¼ê´„ ê³„ì • ìƒì„± <span class="badge">ì—¬ëŸ¬ í•™ìƒ í•œ ë²ˆì— ë“±ë¡</span></h2>
        <p class="hint">
          CSV í˜•ì‹ ì˜ˆì‹œ:<br>
          <span class="mono">id,password</span><br>
          <span class="mono">s1A_01,111111</span><br>
          <span class="mono">s1A_02,</span>  â† ë¹„ë°€ë²ˆí˜¸ ë¹ˆì¹¸ì´ë©´ ìë™ìœ¼ë¡œ 8ìë¦¬ ëœë¤ ë¹„ë°€ë²ˆí˜¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.
        </p>
        <div class="row mt-8">
          <div>
            <label for="csv-file">CSV íŒŒì¼ ì„ íƒ</label>
            <input type="file" id="csv-file" accept=".csv,text/csv" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button type="button" class="secondary small" id="btn-clear-csv">ëª©ë¡ ë¹„ìš°ê¸°</button>
          </div>
        </div>
        <div class="csv-table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:40px;">#</th>
                <th>ì•„ì´ë””(ID)</th>
                <th>ë¹„ë°€ë²ˆí˜¸</th>
                <th style="width:120px;">ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="csv-tbody">
              <tr><td colspan="4" class="small">CSV íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì—ì„œ ê³„ì • ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="flex-between mt-8">
          <button type="button" id="btn-bulk-create">ê³„ì • ì¼ê´„ ìƒì„±</button>
          <p class="small" id="bulk-summary">ì½ì–´ì˜¨ í–‰: 0</p>
        </div>
        <p class="status-line" id="bulk-status"></p>
      </div>

      <div class="card">
        <h2>ğŸ“Š ì ìˆ˜ / ì‚¬ìš©ì ëª©ë¡</h2>
        <div class="flex-between">
          <p class="hint">
            Firestore <span class="tag">scores</span> ì»¬ë ‰ì…˜ ê¸°ì¤€ìœ¼ë¡œ IDÂ·ì ìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.
          </p>
          <button class="secondary" id="btn-refresh">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th style="width:40px;">#</th>
                <th>ì•„ì´ë””(ID)</th>
                <th style="width:80px;">ì ìˆ˜</th>
                <th style="width:140px;">UID (ì•ë¶€ë¶„)</th>
              </tr>
            </thead>
            <tbody id="score-tbody">
              <tr><td colspan="4" class="small">ì•„ì§ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. [ëª©ë¡ ìƒˆë¡œê³ ì¹¨] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</td></tr>
            </tbody>
          </table>
        </div>
        <p class="status-line" id="list-status"></p>
      </div>

      <div class="card">
        <h2>ğŸ“¢ ê±´ì˜í•¨ ìˆ˜ì‹  ëª©ë¡</h2>
        <div class="flex-between">
          <p class="hint">
            í•™ìƒë“¤ì´ ë³´ë‚¸ ì˜ê²¬ì…ë‹ˆë‹¤. í™•ì¸ í›„ [ì‚­ì œ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ëª©ë¡ì—ì„œ ì§€ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
          <button class="secondary" id="btn-refresh-sugg">ê±´ì˜í•¨ ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="scroll">
          <table style="min-width: 600px;">
            <colgroup>
              <col style="width: 50px;">
              <col style="width: 140px;">
              <col style="width: 100px;">
              <col style="width: auto;">
              <col style="width: 70px;">
            </colgroup>
            <thead>
              <tr>
                <th>#</th>
                <th>ë‚ ì§œ</th>
                <th>ë³´ë‚¸ í•™ìƒ</th>
                <th>ì œëª© / ë‚´ìš©</th>
                <th>ê´€ë¦¬</th>
              </tr>
            </thead>
            <tbody id="sugg-tbody">
              <tr><td colspan="5" class="small">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ [ê±´ì˜í•¨ ìƒˆë¡œê³ ì¹¨]ì„ ëˆ„ë¥´ì„¸ìš”.</td></tr>
            </tbody>
          </table>
        </div>
        <p class="status-line" id="sugg-status"></p>
      </div>

    </div>
  </div>

  <script type="module">
    // ===== 1. Firebase SDK ë¡œë“œ =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signOut
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      getDocs,
      collection,
      query,
      orderBy,
      limit,
      deleteDoc // <--- [ì¶”ê°€ë¨] ì‚­ì œ ê¸°ëŠ¥ìš©
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ===== 2. Firebase ì„¤ì • (indexì™€ ë™ì¼ í”„ë¡œì íŠ¸) =====
    const firebaseConfig = {
      apiKey: "AIzaSyCO36JgPpNz8swADxTMVJUFVALWM5o171w",
      authDomain: "simulation-67cd3.firebaseapp.com",
      projectId: "simulation-67cd3",
      storageBucket: "simulation-67cd3.appspot.com",
      messagingSenderId: "615983461615",
      appId: "1:615983461615:web:002e07bcea878eb6d5571a",
      measurementId: "G-9RGN7LYE5W"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ===== 3. ê°„ë‹¨ ê´€ë¦¬ì ì ê¸ˆ (í”„ë¡ íŠ¸ì—”ë“œ ë¹„ë°€ë²ˆí˜¸) =====
    // âš  ì‹¤ì œ ë¹„ë°€ê°’ì€ ë‚˜ì¤‘ì— ê¼­ ë°”ê¾¸ì„¸ìš”!
    const ADMIN_PASSWORD = "dhkdrl@960813";

    const lockCard = document.getElementById("lock-card");
    const adminMain = document.getElementById("admin-main");
    const adminPassInput = document.getElementById("admin-pass");
    const adminLockStatus = document.getElementById("admin-lock-status");
    const btnAdminEnter = document.getElementById("btn-admin-enter");
    const btnTogglePass = document.getElementById("btn-toggle-pass");

    btnAdminEnter.addEventListener("click", () => {
      const val = adminPassInput.value.trim();
      if (!val) {
        adminLockStatus.textContent = "ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        adminLockStatus.className = "status-line status-err";
        return;
      }
      if (val === ADMIN_PASSWORD) {
        lockCard.style.display = "none";
        adminMain.style.display = "block";
        adminLockStatus.textContent = "";
      } else {
        adminLockStatus.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        adminLockStatus.className = "status-line status-err";
      }
    });

    btnTogglePass.addEventListener("click", () => {
      if (adminPassInput.type === "password") {
        adminPassInput.type = "text";
        btnTogglePass.textContent = "ìˆ¨ê¸°ê¸°";
      } else {
        adminPassInput.type = "password";
        btnTogglePass.textContent = "í‘œì‹œ";
      }
    });

    adminPassInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnAdminEnter.click();
    });

    // ===== 4. ë‹¨ì¼ ê³„ì • ìƒì„± + ID ìë™ ìƒì„± =====
    const newIdInput = document.getElementById("new-id");
    const newPassInput = document.getElementById("new-pass");
    const newPass2Input = document.getElementById("new-pass2");
    const btnCreate = document.getElementById("btn-create");
    const createStatus = document.getElementById("create-status");

    const autoPrefixInput = document.getElementById("auto-prefix");
    const autoStartInput = document.getElementById("auto-start");
    const autoDigitsInput = document.getElementById("auto-digits");
    const btnAutoId = document.getElementById("btn-auto-id");

    let autoCounter = 0;

    function padNumber(n, digits){
      const s = String(n);
      if (s.length >= digits) return s;
      return "0".repeat(digits - s.length) + s;
    }

    btnAutoId.addEventListener("click", () => {
      const prefix = autoPrefixInput.value || "";
      let startNum = parseInt(autoStartInput.value, 10);
      const digits = Math.max(1, parseInt(autoDigitsInput.value, 10) || 1);

      if (!autoCounter) {
        autoCounter = isNaN(startNum) ? 1 : startNum;
      } else {
        autoCounter++;
      }

      const id = prefix + padNumber(autoCounter, digits);
      newIdInput.value = id;

      createStatus.textContent = `ìë™ ìƒì„±ëœ ID: ${id}`;
      createStatus.className = "status-line";
    });

    btnCreate.addEventListener("click", async () => {
      const id = newIdInput.value.trim();
      const pw1 = newPassInput.value;
      const pw2 = newPass2Input.value;

      createStatus.textContent = "";
      createStatus.className = "status-line";

      if (!id) {
        createStatus.textContent = "í•™ìƒ ì•„ì´ë””ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
        createStatus.className = "status-line status-err";
        return;
      }
      if (pw1.length < 6) {
        createStatus.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
        createStatus.className = "status-line status-err";
        return;
      }
      if (pw1 !== pw2) {
        createStatus.textContent = "ë¹„ë°€ë²ˆí˜¸ì™€ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        createStatus.className = "status-line status-err";
        return;
      }

      const email = id + "@myapp.local";

      btnCreate.disabled = true;
      createStatus.textContent = "ê³„ì •ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, pw1);

        await setDoc(doc(db, "users", cred.user.uid), { ID: id });
        await setDoc(doc(db, "scores", cred.user.uid), { ID: id, score: 0 });

        createStatus.textContent = `ê³„ì • ìƒì„± ì™„ë£Œ: ${id}`;
        createStatus.className = "status-line status-ok";

        newPassInput.value = "";
        newPass2Input.value = "";

        await signOut(auth);
      } catch (err) {
        console.error("ê³„ì • ìƒì„± ì˜¤ë¥˜:", err);
        createStatus.textContent = "ê³„ì • ìƒì„± ì˜¤ë¥˜: " + err.message;
        createStatus.className = "status-line status-err";
      } finally {
        btnCreate.disabled = false;
      }
    });

    // ===== 5. CSV ì¼ê´„ ê³„ì • ìƒì„± =====
    const csvFileInput = document.getElementById("csv-file");
    const csvTbody = document.getElementById("csv-tbody");
    const btnBulkCreate = document.getElementById("btn-bulk-create");
    const btnClearCsv = document.getElementById("btn-clear-csv");
    const bulkSummary = document.getElementById("bulk-summary");
    const bulkStatus = document.getElementById("bulk-status");

    let csvRows = [];

    function resetCsvTable(){
      csvRows = [];
      csvTbody.innerHTML = `
        <tr><td colspan="4" class="small">CSV íŒŒì¼ì„ ì„ íƒí•˜ë©´ ì—¬ê¸°ì—ì„œ ê³„ì • ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</td></tr>
      `;
      bulkSummary.textContent = "ì½ì–´ì˜¨ í–‰: 0";
      bulkStatus.textContent = "";
      bulkStatus.className = "status-line";
    }

    btnClearCsv.addEventListener("click", resetCsvTable);

    function parseCsv(text){
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      if (!lines.length) return [];

      let startIndex = 0;
      const first = lines[0].toLowerCase();
      const hasHeader = first.includes("id") && (first.includes("password") || first.includes("pw"));
      if (hasHeader) startIndex = 1;

      const arr = [];
      for (let i = startIndex; i < lines.length; i++){
        const line = lines[i];
        const parts = line.split(","); 
        const id = (parts[0] || "").trim();
        const pw = (parts[1] || "").trim();
        if (!id) continue;
        arr.push({ id, password: pw });
      }
      return arr;
    }

    function randomPassword(len = 8){
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";
      let out = "";
      for(let i=0;i<len;i++){
        out += chars.charAt(Math.floor(Math.random()*chars.length));
      }
      return out;
    }

    csvFileInput.addEventListener("change", () => {
      const file = csvFileInput.files?.[0];
      if (!file) {
        resetCsvTable();
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const text = String(e.target.result || "");
        const arr = parseCsv(text);

        if (!arr.length) {
          resetCsvTable();
          bulkStatus.textContent = "CSVì—ì„œ ìœ íš¨í•œ í–‰ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
          bulkStatus.className = "status-line status-err";
          return;
        }

        csvRows = [];
        csvTbody.innerHTML = "";

        arr.forEach((row, idx) => {
          const tr = document.createElement("tr");

          const tdIdx = document.createElement("td");
          tdIdx.textContent = String(idx+1);

          const tdId = document.createElement("td");
          tdId.textContent = row.id;

          const tdPw = document.createElement("td");
          const pwText = row.password || "(ìë™ ìƒì„±)";
          tdPw.textContent = pwText;

          const tdStatus = document.createElement("td");
          tdStatus.textContent = "ëŒ€ê¸°";
          tdStatus.className = "small";

          tr.append(tdIdx, tdId, tdPw, tdStatus);
          csvTbody.appendChild(tr);

          csvRows.push({
            id: row.id,
            password: row.password, 
            statusEl: tdStatus
          });
        });

        bulkSummary.textContent = `ì½ì–´ì˜¨ í–‰: ${csvRows.length}`;
        bulkStatus.textContent = "";
        bulkStatus.className = "status-line";
      };
      reader.readAsText(file, "utf-8");
    });

    btnBulkCreate.addEventListener("click", async () => {
      if (!csvRows.length) {
        bulkStatus.textContent = "ë¨¼ì € CSV íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.";
        bulkStatus.className = "status-line status-err";
        return;
      }

      let success = 0;
      let fail = 0;

      btnBulkCreate.disabled = true;
      bulkStatus.textContent = "ê³„ì •ì„ ìˆœì„œëŒ€ë¡œ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦";
      bulkStatus.className = "status-line";

      for (let i = 0; i < csvRows.length; i++){
        const row = csvRows[i];
        const id = row.id.trim();
        let pw = row.password?.trim();

        if (!id) {
          row.statusEl.textContent = "ID ì—†ìŒ (ê±´ë„ˆëœ€)";
          row.statusEl.className = "small";
          continue;
        }
        if (!pw || pw.length < 6) {
          pw = randomPassword(8);
          row.password = pw;
          const pwCell = row.statusEl.previousElementSibling;
          if (pwCell) pwCell.textContent = pw + " (ìë™)";
        }

        const email = id + "@myapp.local";
        row.statusEl.textContent = "ìƒì„± ì¤‘â€¦";
        row.statusEl.className = "small";

        try {
          const cred = await createUserWithEmailAndPassword(auth, email, pw);

          await setDoc(doc(db, "users", cred.user.uid), { ID: id });
          await setDoc(doc(db, "scores", cred.user.uid), { ID: id, score: 0 });

          row.statusEl.textContent = "ì„±ê³µ";
          row.statusEl.className = "small";
          row.statusEl.style.color = "#22c55e";
          success++;

          await signOut(auth);
        } catch (err) {
          console.error("CSV ê³„ì • ìƒì„± ì˜¤ë¥˜:", err);
          row.statusEl.textContent = "ì‹¤íŒ¨: " + (err.code || err.message);
          row.statusEl.className = "small";
          row.statusEl.style.color = "#ef4444";
          fail++;
        }

        bulkSummary.textContent = `ì§„í–‰: ${i+1}/${csvRows.length} (ì„±ê³µ ${success} / ì‹¤íŒ¨ ${fail})`;
      }

      bulkStatus.textContent = `ì¼ê´„ ìƒì„± ì™„ë£Œ â€” ì„±ê³µ ${success}ê±´, ì‹¤íŒ¨ ${fail}ê±´`;
      bulkStatus.className = "status-line " + (fail ? "status-err" : "status-ok");
      btnBulkCreate.disabled = false;
    });

    // ===== 6. ì ìˆ˜ / ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ =====
    const btnRefresh = document.getElementById("btn-refresh");
    const tbody = document.getElementById("score-tbody");
    const listStatus = document.getElementById("list-status");

    btnRefresh.addEventListener("click", async () => {
      tbody.innerHTML = `
        <tr><td colspan="4" class="small">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤â€¦</td></tr>
      `;
      listStatus.textContent = "";
      listStatus.className = "status-line";

      try {
        const q = query(
          collection(db, "scores"),
          orderBy("score", "desc"),
          limit(200)
        );
        const snap = await getDocs(q);

        if (snap.empty) {
          tbody.innerHTML = `
            <tr><td colspan="4" class="small">ì•„ì§ ë“±ë¡ëœ ì ìˆ˜/ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
          `;
          listStatus.textContent = "ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
          listStatus.className = "status-line";
          return;
        }

        let i = 0;
        const rows = [];
        snap.forEach(docSnap => {
          i++;
          const data = docSnap.data();
          const id = data.ID || "(ID ì—†ìŒ)";
          const score = data.score ?? 0;
          const uid = docSnap.id || "";
          const shortUid = uid.length > 10 ? uid.slice(0, 10) + "â€¦" : uid;

          rows.push(`
            <tr>
              <td>${i}</td>
              <td>${id}</td>
              <td>${score}</td>
              <td class="small">${shortUid}</td>
            </tr>
          `);
        });
        tbody.innerHTML = rows.join("");
        listStatus.textContent = `ì´ ${i}ëª…ì˜ ê¸°ë¡ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
        listStatus.className = "status-line status-ok";
      } catch (err) {
        console.error("ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", err);
        tbody.innerHTML = `
          <tr><td colspan="4" class="small">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>
        `;
        listStatus.textContent = "ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜: " + err.message;
        listStatus.className = "status-line status-err";
      }
    });

    // ===== 7. ê±´ì˜í•¨ ë¶ˆëŸ¬ì˜¤ê¸° ë° ì‚­ì œ [ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥] =====
    const btnRefreshSugg = document.getElementById("btn-refresh-sugg");
    const suggTbody = document.getElementById("sugg-tbody");
    const suggStatus = document.getElementById("sugg-status");

    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
    function formatTime(timestamp) {
      if (!timestamp) return "-";
      const d = timestamp.toDate();
      return d.getFullYear() + "-" +
             String(d.getMonth()+1).padStart(2,"0") + "-" +
             String(d.getDate()).padStart(2,"0") + " " +
             String(d.getHours()).padStart(2,"0") + ":" +
             String(d.getMinutes()).padStart(2,"0");
    }

    async function loadSuggestions() {
      suggTbody.innerHTML = `<tr><td colspan="5" class="small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>`;
      suggStatus.textContent = "";

      try {
        const q = query(collection(db, "suggestions"), orderBy("date", "desc"));
        const snap = await getDocs(q);

        if (snap.empty) {
          suggTbody.innerHTML = `<tr><td colspan="5" class="small">ë„ì°©í•œ ì˜ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          suggStatus.textContent = "ë°ì´í„° ì—†ìŒ";
          return;
        }

        let html = "";
        let idx = 0;
        snap.forEach((docSnap) => {
          idx++;
          const data = docSnap.data();
          const docId = docSnap.id;
          
          const dateStr = formatTime(data.date);
          const writer = data.writerID || data.userId || "(ì•Œìˆ˜ì—†ìŒ)";
          const title = data.title || "(ì œëª© ì—†ìŒ)";
          const content = data.content || "";

          html += `
            <tr>
              <td>${idx}</td>
              <td class="small" style="color:#9ca3af;">${dateStr}</td>
              <td style="font-weight:bold; color:#a5b4fc;">${writer}</td>
              <td>
                <div style="font-weight:bold; margin-bottom:4px;">${title}</div>
                <div class="small" style="white-space:pre-wrap;">${content}</div>
              </td>
              <td>
                <button class="danger small btn-del-sugg" data-id="${docId}">ì‚­ì œ</button>
              </td>
            </tr>
          `;
        });

        suggTbody.innerHTML = html;
        suggStatus.textContent = `ì´ ${idx}ê±´ì˜ ì˜ê²¬ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
        suggStatus.className = "status-line status-ok";

        // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.querySelectorAll(".btn-del-sugg").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const idToDelete = e.target.getAttribute("data-id");
            if(confirm("ì •ë§ ì´ ì˜ê²¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              await deleteSuggestion(idToDelete);
            }
          });
        });

      } catch (err) {
        console.error(err);
        suggTbody.innerHTML = `<tr><td colspan="5" class="small">ì˜¤ë¥˜ ë°œìƒ</td></tr>`;
        suggStatus.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message;
        suggStatus.className = "status-line status-err";
      }
    }

    async function deleteSuggestion(docId) {
      try {
        await deleteDoc(doc(db, "suggestions", docId));
        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadSuggestions();
      } catch (err) {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + err.message);
      }
    }

    btnRefreshSugg.addEventListener("click", loadSuggestions);
  </script>
</body>
</html>