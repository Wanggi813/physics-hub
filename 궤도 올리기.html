<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>ë‚˜ë§Œì˜ ìœ„ì„± ì˜ì•„ ì˜¬ë¦¬ê¸° â€” ì¤‘ì‹¬í–‰ì„±/ë¶ê·¹ë°œì‚¬</title>
  <style>
    :root{
      --ink:#eaf2ff;
      --muted:#a8b3c7;
      --panel: rgba(18, 24, 44, 0.72);
      --panel2: rgba(10, 14, 28, 0.55);
      --stroke: rgba(255,255,255,0.12);
      --accent:#62a6ff;
      --good:#2ecc71;
      --bad:#ff5d5d;
      --warn:#ffcc66;

      --vk: rgba(98,166,255,0.95); /* velocity vector */
      --fg: rgba(255,93,93,0.90);  /* gravity vector */
      --ek: rgba(98,166,255,0.85);
      --ep: rgba(255,170,80,0.75);
      --et: rgba(255,255,255,0.65);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html, body{ width:100%; height:100%; overflow:hidden; background:#060812; color:var(--ink); }
    body{ font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Noto Sans KR",sans-serif; }

    .stage{
      position:fixed; inset:0;
      display:block;
      background:
        radial-gradient(1200px 900px at 70% 20%, rgba(90,155,255,0.16), transparent 60%),
        radial-gradient(900px 700px at 15% 70%, rgba(180,80,255,0.12), transparent 60%),
        radial-gradient(900px 700px at 85% 85%, rgba(60,255,210,0.08), transparent 62%),
        linear-gradient(180deg, #040512 0%, #070a18 50%, #050713 100%);
    }

    .stars, .stars2, .vignette{
      position:absolute; inset:-60% -20%;
      pointer-events:none;
    }
    .stars{
      background-image:
        radial-gradient(1px 1px at 35px 45px, rgba(255,255,255,.85), transparent),
        radial-gradient(1px 1px at 95px 115px, rgba(255,255,255,.75), transparent),
        radial-gradient(2px 2px at 240px 190px, rgba(255,255,255,.65), transparent),
        radial-gradient(1px 1px at 310px 260px, rgba(255,255,255,.7), transparent);
      background-size: 360px 360px;
      opacity:.85;
      animation: drift 36s linear infinite;
      filter: drop-shadow(0 0 6px rgba(120,180,255,0.15));
    }
    .stars2{
      inset:-80% -30%;
      background-image:
        radial-gradient(1px 1px at 25px 25px, rgba(255,255,255,.55), transparent),
        radial-gradient(2px 2px at 170px 80px, rgba(255,255,255,.35), transparent),
        radial-gradient(1px 1px at 260px 240px, rgba(255,255,255,.45), transparent);
      background-size: 420px 420px;
      opacity:.65;
      animation: drift2 62s linear infinite;
    }
    .vignette{
      inset:0;
      background: radial-gradient(80% 80% at 55% 50%, transparent 55%, rgba(0,0,0,0.55) 100%);
      opacity:.9;
      pointer-events:none;
    }
    @keyframes drift{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-140px,220px,0)} }
    @keyframes drift2{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(180px,260px,0)} }

    .sim{ position:absolute; inset:0; overflow:hidden; }
    #world{ position:absolute; inset:0; transform-origin: 50% 50%; will-change: transform; }
    #overlay{ position:absolute; inset:0; width:100%; height:100%; z-index: 8; pointer-events:none; }

    /* í–‰ì„±: í™”ë©´ ì •ê°€ìš´ë° */
    #planet{
      position:absolute;
      left: 50vw;
      top: 50vh;
      width: 240px;
      height: 240px;
      transform: translate(-50%, -50%);
      background-image: url('./image/earth.png');
      background-size: cover;
      background-repeat:no-repeat;
      background-position:center;
      border-radius: 50%;
      box-shadow:
        0 0 0 2px rgba(255,255,255,0.08),
        0 0 40px rgba(90,155,255,0.22),
        0 0 140px rgba(90,155,255,0.10);
      filter: saturate(1.05) contrast(1.05);
      z-index: 5;
    }

    /* ìš°ì£¼ì„  (SVG ìŠ¤íƒ€ì¼ ìœ ì§€) */
    #rocket-container{
      position:absolute;
      width: 76px;
      height: 44px;
      z-index: 10;
      left: 50vw; /* ì´ˆê¸° ìœ„ì¹˜ëŠ” JSì—ì„œ ë¶ê·¹ìœ¼ë¡œ ì´ë™ */
      top: 50vh;
      transform: translate(-50%, -50%);
      will-change: transform, opacity;
      opacity:1;
      transition: opacity 420ms ease;
    }
    #rocket-container.vanish{ opacity:0; }
    #rocket-body{
      width:100%; height:100%;
      display:block;
      transform: scale(1.55);
      transform-origin: 50% 50%;
      filter: drop-shadow(0 12px 18px rgba(255,120,60,0.22));
    }
    #flame{
      position:absolute;
      left: -18px;
      top: 50%;
      transform: translateY(-50%) rotate(180deg);
      width:0; height:0;
      border-top: 9px solid transparent;
      border-bottom: 9px solid transparent;
      border-left: 22px solid #ffcc00;
      filter: drop-shadow(0 6px 16px #ff8800);
      display:none;
      animation: flicker .08s infinite;
    }
    @keyframes flicker{
      0%{ opacity:1; transform: translateY(-50%) rotate(180deg) scaleX(1) scaleY(1); }
      50%{ opacity:.8; transform: translateY(-50%) rotate(180deg) scaleX(.85) scaleY(.85); }
      100%{ opacity:1; transform: translateY(-50%) rotate(180deg) scaleX(1.15) scaleY(1.05); }
    }

    /* Panel */
    .panel{
      position:fixed;
      left: 14px;
      top: 14px;
      width: min(460px, calc(100vw - 28px));
      max-height: calc(100vh - 28px);
      overflow:hidden;
      padding: 16px 16px 14px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border: 1px solid var(--stroke);
      border-radius: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,0.45);
      z-index: 50;
    }
    .panel h2{
      font-size: 16px;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 12px;
      color: var(--ink);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(98,166,255,0.14);
      border: 1px solid rgba(98,166,255,0.22);
      color: rgba(210,230,255,0.95);
      font-weight: 700;
      font-size: 12px;
      white-space:nowrap;
    }
    label{ font-size: 12px; color: var(--muted); }
    .val{ font-size: 13px; color: var(--ink); font-weight: 800; white-space:nowrap; }
    input[type="range"]{ width:100%; cursor:pointer; }

    .group{ margin-bottom: 10px; }
    .control{
      display:grid;
      grid-template-columns: 92px 1fr auto;
      gap: 10px;
      align-items:center;
    }

    .planetBtns{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top: 6px;
    }
    .pbtn{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: var(--ink);
      font-weight: 900;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .pbtn:hover{ background: rgba(98,166,255,0.12); border-color: rgba(98,166,255,0.22); }
    .pbtn:active{ transform: translateY(1px); }
    .pbtn.on{ background: rgba(98,166,255,0.18); border-color: rgba(98,166,255,0.35); }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .chip{
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-weight: 900;
      font-size: 12px;
      cursor:pointer;
      color: var(--ink);
      user-select:none;
    }
    .chip.on{ background: rgba(98,166,255,0.18); border-color: rgba(98,166,255,0.35); }

    .actions{ display:flex; gap:10px; margin-top: 10px; flex-wrap:wrap; }
    button.action{
      flex:1;
      padding: 11px 12px;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      background: rgba(98,166,255,0.16);
      color: var(--ink);
      font-weight: 900;
      cursor: pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      min-width: 130px;
    }
    button.action:hover:not(:disabled){ background: rgba(98,166,255,0.24); border-color: rgba(98,166,255,0.32); }
    button.action:active:not(:disabled){ transform: translateY(1px); }
    button.action:disabled{ opacity:.55; cursor:not-allowed; }

    .out{
      margin-top: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
    }
    .out .line{ display:flex; justify-content:space-between; gap:12px; font-size: 13px; padding: 6px 0; }
    .out .k{ color: var(--muted); }
    .result{
      margin-top: 10px;
      font-weight: 950;
      font-size: 14px;
      text-align:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      line-height:1.35;
    }
    .result.good{ background: rgba(46,204,113,0.16); border-color: rgba(46,204,113,0.25); }
    .result.bad{ background: rgba(255,93,93,0.16); border-color: rgba(255,93,93,0.25); }
    .result.warn{ background: rgba(255,204,102,0.14); border-color: rgba(255,204,102,0.22); }

    .hint{ margin-top: 10px; font-size: 11px; color: rgba(180,196,224,0.75); line-height: 1.35; }
  </style>
</head>
<body>

  <div class="stage">
    <div class="stars"></div>
    <div class="stars2"></div>

    <div class="sim">
      <div id="world">
        <canvas id="overlay"></canvas>

        <div id="planet"></div>

        <div id="rocket-container" aria-hidden="true">
          <svg id="rocket-body" viewBox="0 0 320 200" preserveAspectRatio="xMidYMid meet">
            <defs>
              <linearGradient id="kps_flame" x1="0" x2="1">
                <stop offset="0" stop-color="#fff59d"/>
                <stop offset="0.45" stop-color="#ffb74d"/>
                <stop offset="1" stop-color="#ff5252"/>
              </linearGradient>
              <radialGradient id="kps_glass" cx="50%" cy="50%" r="50%">
                <stop offset="0" stop-color="#cfe9ff"/>
                <stop offset="1" stop-color="#5aa0ff"/>
              </radialGradient>
              <linearGradient id="kps_hull" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0" stop-color="#eef2f9"/>
                <stop offset="1" stop-color="#d6dce8"/>
              </linearGradient>
            </defs>
            <g transform="translate(0,6)">
              <path d="M16 100 L72 78 L72 122 Z" fill="url(#kps_flame)" opacity="0.95"></path>
            </g>
            <g transform="translate(40,12)">
              <path d="M50,50 Q180,20 270,80 Q290,100 270,120 Q180,180 50,150 Q30,140 30,100 Q30,60 50,50 Z"
                    fill="url(#kps_hull)" stroke="#cfd6e6" stroke-width="4"/>
              <circle cx="160" cy="100" r="24" fill="url(#kps_glass)" stroke="#1c3d7a" stroke-width="6"/>
              <circle cx="168" cy="92" r="9" fill="#eaf6ff" opacity="0.9"/>
            </g>
          </svg>
          <div id="flame"></div>
        </div>
      </div>
    </div>

    <div class="vignette"></div>
  </div>

  <div class="panel" role="region" aria-label="ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • íŒ¨ë„">
    <h2>ğŸš€ ë‚˜ë§Œì˜ ìœ„ì„± ì˜ì•„ ì˜¬ë¦¬ê¸° <span class="badge" id="stageBadge">ëŒ€ê¸°</span></h2>

    <div class="group">
      <label>í–‰ì„± ì„ íƒ</label>
      <div class="planetBtns">
        <button class="pbtn on" id="btnEarth">ì§€êµ¬</button>
        <button class="pbtn" id="btnMoon">ë‹¬</button>
        <button class="pbtn" id="btnMars">í™”ì„±</button>
      </div>
    </div>

    <div class="group">
      <div class="control">
        <label for="initialVelocity">ë°œì‚¬ ì†ë„ v</label>
        <input type="range" id="initialVelocity" min="1" max="15" value="7.9" step="0.1" />
        <div class="val"><span id="initialVelocityValue">7.9</span> km/s</div>
      </div>
    </div>

    <div class="group">
      <div class="control">
        <label for="launchAngle">ë°œì‚¬ ê°ë„ Î¸</label>
        <input type="range" id="launchAngle" min="0" max="90" value="0" step="1" />
        <div class="val"><span id="launchAngleValue">0</span>Â°</div>
      </div>
      <div class="hint">Î¸ëŠ” <b>ì§€í‘œë©´ ì ‘ì„ (ìˆ˜í‰)</b> ê¸°ì¤€ì…ë‹ˆë‹¤. (0Â°=ìˆ˜í‰ ë°œì‚¬, 90Â°=ìˆ˜ì§ ë°œì‚¬)</div>
    
    <div class="group">
      <div class="control">
        <label for="launchAlt">ì¶œë°œ ê¶¤ë„ ê³ ë„ h</label>
        <input type="range" id="launchAlt" min="0" max="2000" value="0" step="10" />
        <div class="val"><span id="launchAltValue">0</span> km</div>
      </div>
      <div class="hint">â€» hëŠ” <b>í–‰ì„± í‘œë©´ ìœ„ ê³ ë„</b>. (0 km = ì§€í‘œë©´/ë¶ê·¹ ë°œì‚¬ì )</div>
    </div>

    <div class="chips">
      <div class="chip on" id="chipVectors">ë²¡í„° í‘œì‹œ</div>
      <div class="chip on" id="chipEnergy">ì—ë„ˆì§€ ê·¸ë˜í”„</div>
      <div class="chip on" id="chipTrails">ê¶¤ì  ëˆ„ì </div>
    </div>

    <div class="actions">
      <button class="action" id="launchButton">ë°œì‚¬</button>
      <button class="action" id="pauseButton" disabled>ì¼ì‹œì •ì§€</button>
      <button class="action" id="resetButton">ì´ˆê¸°í™”</button>
      <button class="action" id="clearTrailsButton">ê¶¤ì  ì§€ìš°ê¸°</button>
    </div>

    <div class="out">
      <div class="line"><div class="k">ì œ1ìš°ì£¼ì†ë„ vâ‚</div><div><span id="v1">0.00</span> km/s</div></div>
      <div class="line"><div class="k">íƒˆì¶œì†ë„ vâ‚‘</div><div><span id="ve">0.00</span> km/s</div></div>

      <div class="line"><div class="k">ìƒíƒœ</div><div id="status">ëŒ€ê¸° ì¤‘</div></div>
      <div class="line"><div class="k">ìµœê³  ê³ ë„</div><div><span id="maxAltitude">0</span> km</div></div>
      <div class="line"><div class="k">í˜„ì¬ ì†ë„</div><div><span id="currentVelocity">0.0</span> km/s</div></div>
      <div class="line"><div class="k">ì´ ì—ë„ˆì§€(ë‹¨ìœ„ì§ˆëŸ‰)</div><div><span id="specificEnergy">0.0</span> MJ/kg</div></div>

      <div id="result" class="result warn">ì†ë„Â·ê°ë„ë¥¼ ì¡°ì ˆí•œ ë’¤ ë°œì‚¬í•´ ë³´ì„¸ìš”.</div>
      <div class="hint">
        â€¢ íŒŒë€ í™”ì‚´í‘œ: ì†ë„ ë²¡í„° v &nbsp;|&nbsp; ë¹¨ê°„ í™”ì‚´í‘œ: ì¤‘ë ¥(ê°€ì†ë„) ë²¡í„° g<br/>
        â€¢ ì‹œë®¬ ì†ë„ëŠ” <b>ê³ ì •</b>ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (ì•ˆì •ì„±/ê°€ë…ì„± ìš°ì„ )
      </div>
    </div>
  </div>

  <script>
    const G = 6.67430e-11;

    const planetEl = document.getElementById('planet');
    const rocketContainer = document.getElementById('rocket-container');
    const flameEl = document.getElementById('flame');
    const worldEl = document.getElementById('world');
    const overlay = document.getElementById('overlay');
    const octx = overlay.getContext('2d');

    const btnEarth = document.getElementById('btnEarth');
    const btnMoon = document.getElementById('btnMoon');
    const btnMars = document.getElementById('btnMars');

    const vSlider = document.getElementById('initialVelocity');
    const altSlider = document.getElementById('launchAlt');
    const thSlider = document.getElementById('launchAngle');

    const altVal = document.getElementById('launchAltValue');

    const vVal = document.getElementById('initialVelocityValue');
    const thVal = document.getElementById('launchAngleValue');

    const v1El = document.getElementById('v1');
    const veEl = document.getElementById('ve');

    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');
    const maxAltEl = document.getElementById('maxAltitude');
    const curVEl = document.getElementById('currentVelocity');
    const epsEl = document.getElementById('specificEnergy');
    const stageBadge = document.getElementById('stageBadge');

    const launchButton = document.getElementById('launchButton');
    const pauseButton = document.getElementById('pauseButton');
    const resetButton = document.getElementById('resetButton');
    const clearTrailsButton = document.getElementById('clearTrailsButton');

    const chipVectors = document.getElementById('chipVectors');
    const chipEnergy  = document.getElementById('chipEnergy');
    const chipTrails  = document.getElementById('chipTrails');

    const PLANETS = {
      earth: { name:'ì§€êµ¬', M:5.972e24,  R:6371e3,   img:'./image/earth.png', glow:[90,155,255] },
      moon:  { name:'ë‹¬',  M:7.342e22,  R:1737.4e3, img:'./image/moon.png',  glow:[210,210,230] },
      mars:  { name:'í™”ì„±',M:6.4171e23, R:3389.5e3, img:'./image/mars.png',  glow:[255,140,110] }
    };

    let showVectors = true;
    let showEnergy = true;
    let keepTrails = true;

    function setChip(el, on){ el.classList.toggle('on', !!on); }
    chipVectors.addEventListener('click', ()=>{ showVectors=!showVectors; setChip(chipVectors, showVectors); drawOverlay(); });
    chipEnergy .addEventListener('click', ()=>{ showEnergy=!showEnergy; setChip(chipEnergy, showEnergy); drawOverlay(); });
    chipTrails .addEventListener('click', ()=>{
      keepTrails=!keepTrails;
      setChip(chipTrails, keepTrails);
      if(!keepTrails) trails.length = 0;
      drawOverlay();
    });

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

    // ---- Center anchors ----
    // í–‰ì„±ì€ í™”ë©´ ì •ì¤‘ì•™ì— ê³ ì •(50vw,50vh). ë”°ë¼ì„œ ì¤‘ì‹¬ì€ í™”ë©´ ì¤‘ì‹¬ìœ¼ë¡œ ê³ ì •.
    let planetCenter = {x:0,y:0};

    function updatePlanetCenter(){
      planetCenter = { x: window.innerWidth/2, y: window.innerHeight/2 };
    }

    function resizeOverlay(){
      overlay.width = Math.floor(window.innerWidth * devicePixelRatio);
      overlay.height = Math.floor(window.innerHeight * devicePixelRatio);
      overlay.style.width = window.innerWidth + 'px';
      overlay.style.height = window.innerHeight + 'px';
      octx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
      updatePlanetCenter();
    }

    // ---- Physics ----
    let planetKey = 'earth';
    let planet = PLANETS[planetKey];

    let running = false;
    let paused = false;
    let raf = null;
    let lastT = null;

    // state in meters (origin at planet center, y up)
    let r = {x:0,y:0};
    let v = {x:0,y:0};
    let maxAlt = 0;

    // scale: meters -> pixels
    let pxPerM = 0;

    // ìë™ ìŠ¤ì¼€ì¼ë§: ë©€ì–´ì§ˆìˆ˜ë¡(ì¤‘ë ¥ ì˜í–¥ê¶Œ/í•œê³„ê¹Œì§€) ìì—°ìŠ¤ëŸ½ê²Œ ì¤Œ ì•„ì›ƒ
    let worldScale = 1;
    function setWorldScale(s){
      worldScale = s;
      worldEl.style.transform = `scale(${worldScale})`;
      worldEl.style.transformOrigin = '50% 50%';
    }
const trails = [];
    const MAX_PTS = 120000; // ë©ˆì¶œ ë•Œê¹Œì§€ ì¶©ë¶„íˆ ê¸¸ê²Œ ì €ì¥
const minStep = 0; 
    // Fixed sim speed: ì•ˆì •ì ì´ë©´ì„œ ì²´ê° ì˜ ë³´ì´ê²Œ
    const TIME_SCALE = 1800; // ê³ ì • ë°°ì†(ì‘ê²Œ=ëŠë¦¬ê²Œ, 'ì›€ì§ì„'ì´ ë³´ì´ê²Œ)
    const GRAVITY_LIMIT_MULT = 20; // 'ì¤‘ë ¥ í•œê³„'(í‘œì‹œ/ìŠ¤ì¼€ì¼ ê¸°ì¤€)
    const MAX_STEPS = 20; // í”„ë ˆì„ë‹¹ ìµœëŒ€ ë¬¼ë¦¬ ìŠ¤í…(ë§ì„ìˆ˜ë¡ ë¶€ë“œëŸ¬ì›€)

    function computeScale(){
      const pr = planetEl.getBoundingClientRect();
      const radiusPx = pr.width/2;
      pxPerM = radiusPx / planet.R;
    }

    

    function launchOffsetM(){
      // ìš°ì£¼ì„ ì´ í–‰ì„± ì•ˆìœ¼ë¡œ 'ë°•íˆëŠ”' ëŠë‚Œì„ ì—†ì• ê¸° ìœ„í•œ ì‹œê°ì  ì˜¤í”„ì…‹(í‘œë©´ì—ì„œ ì•½ê°„ ë„ì›€)
      const rr = rocketContainer.getBoundingClientRect();
      const offsetPx = rr.height * 0.45;     // ìš°ì£¼ì„  ì ˆë°˜ ì •ë„ë¥¼ ë°”ê¹¥ìœ¼ë¡œ
      return offsetPx / pxPerM;
    }
function worldToScreen(w){
      return {
        x: planetCenter.x + w.x * pxPerM,
        y: planetCenter.y - w.y * pxPerM
      };
    }

    function accel(pos){
      const mu = G * planet.M;
      const r2 = pos.x*pos.x + pos.y*pos.y;
      const rmag = Math.sqrt(r2);
      const inv = 1.0 / (rmag*rmag*rmag + 1e-18);
      return { x: -mu * pos.x * inv, y: -mu * pos.y * inv };
    }

    // velocity Verlet
    function step(dt){
      const a0 = accel(r);
      r.x += v.x*dt + 0.5*a0.x*dt*dt;
      r.y += v.y*dt + 0.5*a0.y*dt*dt;

      const a1 = accel(r);
      v.x += 0.5*(a0.x + a1.x)*dt;
      v.y += 0.5*(a0.y + a1.y)*dt;

      const rmag = Math.hypot(r.x,r.y);
      const alt = Math.max(0, rmag - planet.R);
      if(alt > maxAlt) maxAlt = alt;

      // trail
      const tr = trails[trails.length-1];
      if(tr && tr.pts.length < MAX_PTS){
        const last = tr.pts[tr.pts.length-1];
        const dx = r.x - last.x, dy = r.y - last.y;
        if(dx*dx + dy*dy > (minStep*minStep)) tr.pts.push({x:r.x,y:r.y});
      }

      // collision
      if(rmag <= planet.R){
        finish('í–‰ì„±ì— ì¬ì¶©ëŒ (ë‚™í•˜)', 'bad');
        return;
      }

      // escape
      const mu = G*planet.M;
      const vmag = Math.hypot(v.x,v.y);
      const eps = 0.5*vmag*vmag - mu/rmag;
      const vr = (r.x*v.x + r.y*v.y) / (rmag + 1e-12);
      if(rmag > planet.R*GRAVITY_LIMIT_MULT && eps >= 0 && vr > 0){
        finish('ì¤‘ë ¥ê¶Œ íƒˆì¶œ (E â‰¥ 0)', 'good', true);
        return;
      }
    }

    function finish(msg, cls, vanishRocket=false){
      running = false;
      paused = false;
      lastT = null;
      launchButton.disabled = false;
      pauseButton.disabled = true;
      pauseButton.textContent = 'ì¼ì‹œì •ì§€';
      launchButton.textContent = 'ë‹¤ì‹œ ë°œì‚¬';
      flameEl.style.display = 'none';

      statusEl.textContent = cls==='good' ? 'íƒˆì¶œ' : 'ì¢…ë£Œ';
      resultEl.className = 'result ' + (cls==='good' ? 'good' : (cls==='bad' ? 'bad' : 'warn'));
      resultEl.textContent = msg;

      if(vanishRocket){
        rocketContainer.classList.add('vanish');
        setTimeout(()=>{ rocketContainer.style.display='none'; }, 430);
      }
    }

    function updateDerivedSpeeds(){
      const mu = G * planet.M;
      const v1 = Math.sqrt(mu / planet.R);
      const ve = Math.sqrt(2 * mu / planet.R);
      v1El.textContent = (v1/1000).toFixed(2);
      veEl.textContent = (ve/1000).toFixed(2);
    }

    function updateStageBadgeByV0(){
      const mu = G * planet.M;
      const v1 = Math.sqrt(mu / planet.R);
      const ve = Math.sqrt(2 * mu / planet.R);
      const vv = parseFloat(vSlider.value) * 1000;

      if(vv < v1*0.98) stageBadge.textContent = 'ë‹¨ê³„ 1';
      else if(vv < ve*0.999) stageBadge.textContent = 'ë‹¨ê³„ 2';
      else stageBadge.textContent = 'ë‹¨ê³„ 3';
    }

    function updatePreviewPose(){
      computeScale();
      const h0 = parseFloat(altSlider.value) * 1000;
      const np = worldToScreen({x:0, y: planet.R + h0});
      // ë°œì‚¬ ì „ í”„ë¦¬ë·°: ì„ íƒí•œ ê°ë„ Î¸(ìˆ˜í‰=0Â°)ì— ë§ì¶° ìš°ì£¼ì„  ë°©í–¥ë„ í‘œì‹œ
      const v0 = parseFloat(vSlider.value) * 1000;
      const th = parseFloat(thSlider.value) * Math.PI/180;
      const vel = { x: v0 * Math.cos(th), y: v0 * Math.sin(th) };
      const ang = Math.atan2(-vel.y, vel.x);
      rocketContainer.style.left = np.x + 'px';
      rocketContainer.style.top  = np.y + 'px';
      rocketContainer.style.transform = `translate(-50%, -50%) rotate(${ang}rad)`;
    }

function placeRocketAtNorthPolePreview(){
      updatePreviewPose();
    }

    function hardReset(clearAll=true){
      if(raf) cancelAnimationFrame(raf);
      raf = null;
      running = false;
      paused = false;
      lastT = null;

      flameEl.style.display = 'none';
      launchButton.disabled = false;
      pauseButton.disabled = true;
      pauseButton.textContent = 'ì¼ì‹œì •ì§€';
      launchButton.textContent = 'ë°œì‚¬';

      rocketContainer.classList.remove('vanish');
      rocketContainer.style.display = 'block';

      maxAlt = 0;
      maxAltEl.textContent = '0';
      curVEl.textContent = parseFloat(vSlider.value).toFixed(1);
      epsEl.textContent = '0.0';

      statusEl.textContent = 'ëŒ€ê¸° ì¤‘';
      resultEl.className = 'result warn';
      resultEl.textContent = 'ì†ë„Â·ê°ë„ë¥¼ ì¡°ì ˆí•œ ë’¤ ë°œì‚¬í•´ ë³´ì„¸ìš”.';
      stageBadge.textContent = 'ëŒ€ê¸°';

      if(clearAll) trails.length = 0;

      setWorldScale(1);
      updatePlanetCenter();
      updatePreviewPose();
      drawOverlay();
      updateStageBadgeByV0();
    }

    function setPlanet(key){
      planetKey = key;
      planet = PLANETS[key];

      btnEarth.classList.toggle('on', key==='earth');
      btnMoon.classList.toggle('on', key==='moon');
      btnMars.classList.toggle('on', key==='mars');

      planetEl.style.backgroundImage = `url('${planet.img}')`;

      const [R,G,B] = planet.glow;
      planetEl.style.boxShadow =
        `0 0 0 2px rgba(255,255,255,0.08),
         0 0 40px rgba(${R},${G},${B},0.22),
         0 0 140px rgba(${R},${G},${B},0.10)`;

      updateDerivedSpeeds();
      setWorldScale(1);
      hardReset(true);
    }

    // ---- Launch ----
    function start(){
      if(running) return;

      rocketContainer.classList.remove('vanish');
      rocketContainer.style.display = 'block';

      // ë¶ê·¹ì (ê³ ë„ h)ì—ì„œ ì‹œì‘
      const h0 = parseFloat(altSlider.value) * 1000;
      r = { x: 0, y: planet.R + h0 + Math.max(1, launchOffsetM()*0.15) };const v0 = parseFloat(vSlider.value) * 1000;
      const th = parseFloat(thSlider.value) * Math.PI/180;

      // Î¸: ì ‘ì„ (+x) ê¸°ì¤€, ë°”ê¹¥ìª½(ë°©ì‚¬)ìœ¼ë¡œ 0->90
      v = { x: v0 * Math.cos(th), y: v0 * Math.sin(th) };

      maxAlt = 0;

      if(!keepTrails) trails.length = 0;
      const tint = planet.glow;
      const c = `rgba(${clamp(tint[0]+(Math.random()*30-15),0,255)},${clamp(tint[1]+(Math.random()*30-15),0,255)},${clamp(tint[2]+(Math.random()*30-15),0,255)},0.65)`;
      trails.push({ pts:[{x:r.x,y:r.y}], color:c });

      running = true;
      paused = false;
      lastT = null;

      launchButton.disabled = true;
      pauseButton.disabled = false;
      launchButton.textContent = 'ì§„í–‰ ì¤‘â€¦';
      pauseButton.textContent = 'ì¼ì‹œì •ì§€';

      statusEl.textContent = 'ë°œì‚¬!';
      resultEl.className = 'result warn';
      resultEl.textContent = 'ê¶¤ì Â·ë²¡í„°Â·ì—ë„ˆì§€ ë³€í™”ë¥¼ ê´€ì°°í•˜ì„¸ìš”.';
      flameEl.style.display = 'block';

      updatePlanetCenter();
      tick(performance.now(), true);
    }

    function togglePause(){
      if(!running) return;
      paused = !paused;
      pauseButton.textContent = paused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
      statusEl.textContent = paused ? 'ì¼ì‹œì •ì§€' : 'ì§„í–‰ ì¤‘';
      flameEl.style.display = paused ? 'none' : 'block';
      if(!paused){
        lastT = null;
        raf = requestAnimationFrame(tick);
      }
    }

    // ---- Drawing ----
    function drawArrow(x0,y0,x1,y1,color,width){
      octx.save();
      octx.strokeStyle = color;
      octx.fillStyle = color;
      octx.lineWidth = width;
      octx.lineCap = 'round';
      octx.beginPath();
      octx.moveTo(x0,y0);
      octx.lineTo(x1,y1);
      octx.stroke();

      const dx=x1-x0, dy=y1-y0;
      const a=Math.atan2(dy,dx);
      const head=10;
      octx.beginPath();
      octx.moveTo(x1,y1);
      octx.lineTo(x1-head*Math.cos(a-0.45), y1-head*Math.sin(a-0.45));
      octx.lineTo(x1-head*Math.cos(a+0.45), y1-head*Math.sin(a+0.45));
      octx.closePath();
      octx.fill();
      octx.restore();
    }

    function drawEnergyBars(Ek, Ep, E){
      const pad = 14;
      const w = 230, h = 128;
      const x = window.innerWidth - w - pad;
      const y = pad;

      octx.save();
      octx.fillStyle = 'rgba(0,0,0,0.18)';
      octx.strokeStyle = 'rgba(255,255,255,0.10)';
      octx.lineWidth = 1;
      octx.beginPath();
      octx.roundRect(x,y,w,h,14);
      octx.fill();
      octx.stroke();

      octx.fillStyle = 'rgba(225,235,255,0.9)';
      octx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
      octx.fillText('ì—ë„ˆì§€(ë‹¨ìœ„ì§ˆëŸ‰)', x+12, y+18);

      const bx = x+16, by = y+28;
      const bw = w-32, bh = h-48;
      const mid = by + bh*0.55;

      const mu = G*planet.M;
      const Ep0 = Math.abs(-mu/planet.R);
      const EkVe = mu/planet.R;
      const scale = Math.max(Ep0, EkVe) * 1.15;

      octx.strokeStyle = 'rgba(255,255,255,0.10)';
      octx.beginPath();
      octx.moveTo(bx, mid);
      octx.lineTo(bx+bw, mid);
      octx.stroke();

      const EkMag = clamp(Ek/scale, 0, 1) * (bh*0.40);
      octx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ek');
      octx.fillRect(bx, mid - EkMag, bw*0.33, EkMag);

      const EpMag = clamp(Math.abs(Ep)/scale, 0, 1) * (bh*0.40);
      octx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--ep');
      if(Ep >= 0) octx.fillRect(bx + bw*0.37, mid - EpMag, bw*0.33, EpMag);
      else        octx.fillRect(bx + bw*0.37, mid,        bw*0.33, EpMag);

      const Emag = clamp(Math.abs(E)/scale, 0, 1) * (bh*0.40);
      octx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--et');
      if(E >= 0) octx.fillRect(bx + bw*0.74, mid - Emag, bw*0.26, Emag);
      else       octx.fillRect(bx + bw*0.74, mid,        bw*0.26, Emag);

      octx.fillStyle = 'rgba(225,235,255,0.88)';
      octx.fillText('Ek', bx+2, y+h-12);
      octx.fillText('Ep', bx + bw*0.37 + 2, y+h-12);
      octx.fillText('E',  bx + bw*0.74 + 2, y+h-12);

      if(E >= 0){
        octx.strokeStyle = 'rgba(46,204,113,0.50)';
        octx.lineWidth = 2;
        octx.beginPath();
        octx.roundRect(x+8,y+8,w-16,h-16,12);
        octx.stroke();
      }
      octx.restore();
    }

    function drawOverlay(){
      octx.clearRect(0,0,window.innerWidth, window.innerHeight);

      // trails
      for(const tr of trails){
        if(tr.pts.length < 2) continue;
        octx.save();
        octx.strokeStyle = tr.color;
        octx.lineWidth = 1.6;
        octx.beginPath();
        let p0 = worldToScreen(tr.pts[0]);
        octx.moveTo(p0.x, p0.y);
        for(let i=1;i<tr.pts.length;i++){
          const p = worldToScreen(tr.pts[i]);
          octx.lineTo(p.x,p.y);
        }
        octx.stroke();
        octx.restore();
      }

      // vectors + energy (running or preview)
      const pos = running ? r : {x:0, y:planet.R + launchOffsetM()};
      const vel = running ? v : (() => {
        const v0 = parseFloat(vSlider.value)*1000;
        const th = parseFloat(thSlider.value)*Math.PI/180;
        return {x: v0*Math.cos(th), y: v0*Math.sin(th)};
      })();

      const sp = worldToScreen(pos);
      const vmag = Math.hypot(vel.x, vel.y);
      const rmag = Math.hypot(pos.x, pos.y);

      const mu = G*planet.M;
      const eps = 0.5*vmag*vmag - mu/rmag;
      epsEl.textContent = (eps/1e6).toFixed(1);

      if(showVectors){
        const a = accel(pos);
        const amag = Math.hypot(a.x,a.y);

        const vScale = 120 / Math.max(3000, vmag);
        const aScale = 120 / Math.max(2, amag);

        const vp = worldToScreen({x: pos.x + vel.x*vScale, y: pos.y + vel.y*vScale});
        const ap = worldToScreen({x: pos.x + a.x*aScale, y: pos.y + a.y*aScale});

        drawArrow(sp.x, sp.y, vp.x, vp.y, getComputedStyle(document.documentElement).getPropertyValue('--vk'), 3);
        drawArrow(sp.x, sp.y, ap.x, ap.y, getComputedStyle(document.documentElement).getPropertyValue('--fg'), 3);
      }

      if(showEnergy){
        const Ek = 0.5*vmag*vmag;
        const Ep = -mu/rmag;
        const E  = Ek + Ep;
        drawEnergyBars(Ek, Ep, E);
      }
    }

    // ---- Loop ----
    function tick(t, first=false){
      if(!running || paused){
        drawOverlay();
        return;
      }

      if(!lastT || first) lastT = t;
      
      const dtReal = (t - lastT)/1000;
      lastT = t;

      // âœ… ìˆœê°„ì´ë™ ë°©ì§€: ë ‰ìœ¼ë¡œ í”„ë ˆì„ì´ ê¸¸ì–´ì ¸ë„ ë¬¼ë¦¬ì‹œê°„ì„ ìº¡(=ì í”„ ë°©ì§€)
      const dtRealClamped = Math.min(dtReal, 0.04); // 40ms cap

      // âœ… 'ì²œì²œíˆ' ë³´ì´ë„ë¡: TIME_SCALEì„ ë‚®ì¶”ê³ , ê³ ì • ìŠ¤í…ìœ¼ë¡œ ìª¼ê°œì„œ ë§ì´ ì ë¶„
      const simDt = dtRealClamped * TIME_SCALE;     // (ì‹œë®¬ ì‹œê°„)

      // ê³ ì • ë¬¼ë¦¬ ìŠ¤í…(ì‘ì„ìˆ˜ë¡ ë” ë¶€ë“œëŸ½ê³  ë” ë§ì€ ìŠ¤í…)
      const h = 0.01; // 0.008~0.02 ì¶”ì²œ
      let n = Math.ceil(simDt / h);
      n = clamp(n, 1, MAX_STEPS);

      const dt = simDt / n;
      for(let i=0;i<n;i++){
        step(dt);
        if(!running) break;
      }
// rocket visual (ì¢Œí‘œë¥¼ ì§ì ‘ left/topìœ¼ë¡œ ì„¤ì •: 'ì¤‘ì•™ìœ¼ë¡œ ë“¤ì–´ê°' / ì í”„ í˜„ìƒ ë°©ì§€)
      const sp = worldToScreen(r);
      const ang = Math.atan2(-v.y, v.x);
      rocketContainer.style.left = sp.x + 'px';
      rocketContainer.style.top  = sp.y + 'px';
      rocketContainer.style.transform = `translate(-50%, -50%) rotate(${ang}rad)`;


      // âœ… ìë™ ìŠ¤ì¼€ì¼ë§(ì¤Œ ì•„ì›ƒ): ìš°ì£¼ì„ ì´ ë©€ì–´ì§ˆìˆ˜ë¡ í™”ë©´ì— ë“¤ì–´ì˜¤ë„ë¡ ìŠ¤ì¼€ì¼ì„ ì¤„ì„
      // - í–‰ì„± ì¤‘ì‹¬ì€ í™”ë©´ ì¤‘ì•™ ê³ ì •
      // - 'ì¤‘ë ¥ í•œê³„'(R*GRAVITY_LIMIT_MULT)ê¹Œì§€ëŠ” ê³„ì† ì¤Œ ì•„ì›ƒ, ê·¸ ë°–ì€ ìµœì†Œ ìŠ¤ì¼€ì¼ ìœ ì§€
      const distPx = Math.hypot(sp.x - planetCenter.x, sp.y - planetCenter.y);
      const maxPx  = Math.min(window.innerWidth, window.innerHeight) * 0.42; // í™”ë©´ ì•ˆìª½ ëª©í‘œ ë°˜ê²½
      let desiredScale = 1;

      if (distPx > maxPx){
        desiredScale = clamp(maxPx / (distPx + 1e-6), 0.16, 1);
      }

      const rmagNow = Math.hypot(r.x, r.y);
      if (rmagNow >= planet.R * GRAVITY_LIMIT_MULT){
        desiredScale = Math.min(desiredScale, 0.16);
      }

      // ë¶€ë“œëŸ¬ìš´ ìŠ¤ì¼€ì¼ ë³€í™”
      setWorldScale(worldScale + (desiredScale - worldScale) * 0.08);
// auto zoom-out only (keep planet centered and visible)
      const margin = 80;
      const rx = sp.x, ry = sp.y;
      desiredScale = 1;
      if(rx > window.innerWidth - margin || rx < margin || ry < margin || ry > window.innerHeight - margin){
        const distPx = Math.hypot(rx - planetCenter.x, ry - planetCenter.y);
        const maxPx = Math.min(window.innerWidth, window.innerHeight) * 0.44;
        desiredScale = clamp(maxPx / (distPx + 1e-6), 0.18, 1);
      }
      setWorldScale(worldScale + (desiredScale - worldScale) * 0.10);

      // info
      const vmag = Math.hypot(v.x,v.y);
      curVEl.textContent = (vmag/1000).toFixed(1);
      maxAltEl.textContent = (maxAlt/1000).toFixed(0);

      // stage by current speed (simple)
      const mu = G*planet.M;
      const v1 = Math.sqrt(mu / planet.R);
      const ve = Math.sqrt(2 * mu / planet.R);
      if(vmag < v1*0.98) stageBadge.textContent = 'ë‹¨ê³„ 1';
      else if(vmag < ve*0.999) stageBadge.textContent = 'ë‹¨ê³„ 2';
      else stageBadge.textContent = 'ë‹¨ê³„ 3';

      drawOverlay();
      raf = requestAnimationFrame(tick);
    }

    // ---- UI events ----
    vSlider.addEventListener('input', ()=>{
      vVal.textContent = parseFloat(vSlider.value).toFixed(1);
      if(!running) { curVEl.textContent = parseFloat(vSlider.value).toFixed(1); updateStageBadgeByV0(); updatePreviewPose(); drawOverlay(); }
    });
    altSlider.addEventListener('input', ()=>{
      altVal.textContent = parseInt(altSlider.value,10);
      if(!running) { updatePreviewPose(); drawOverlay(); }
    });

    thSlider.addEventListener('input', ()=>{
      thVal.textContent = parseInt(thSlider.value,10);

      altVal.textContent = parseInt(altSlider.value, 10);
      if(!running) {
        updatePreviewPose();
        drawOverlay();
      }
    });

    launchButton.addEventListener('click', ()=>{
      if(running) return;
      launchButton.disabled = true;
      launchButton.textContent = 'ì§„í–‰ ì¤‘â€¦';
      pauseButton.disabled = false;
      statusEl.textContent = 'ë°œì‚¬!';
      resultEl.className = 'result warn';
      resultEl.textContent = 'ê¶¤ì Â·ë²¡í„°Â·ì—ë„ˆì§€ ë³€í™”ë¥¼ ê´€ì°°í•˜ì„¸ìš”.';
      flameEl.style.display = 'block';
      rocketContainer.classList.remove('vanish');
      rocketContainer.style.display = 'block';
      start();
      raf = requestAnimationFrame(tick);
    });

    pauseButton.addEventListener('click', togglePause);
    resetButton.addEventListener('click', ()=> hardReset(true));
    clearTrailsButton.addEventListener('click', ()=> { trails.length = 0; drawOverlay(); });

    btnEarth.addEventListener('click', ()=> setPlanet('earth'));
    btnMoon .addEventListener('click', ()=> setPlanet('moon'));
    btnMars .addEventListener('click', ()=> setPlanet('mars'));

    window.addEventListener('resize', ()=>{
      if(raf) cancelAnimationFrame(raf);
      raf = null;
      setWorldScale(1);
      resizeOverlay();
      updatePlanetCenter();
      computeScale();
      // keep rocket preview at north pole
      hardReset(false);
    });

    // ---- init ----
    function ensureRoundRect(){
      if(!CanvasRenderingContext2D.prototype.roundRect){
        CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
          const rr = Math.min(r, w/2, h/2);
          this.beginPath();
          this.moveTo(x+rr, y);
          this.arcTo(x+w, y, x+w, y+h, rr);
          this.arcTo(x+w, y+h, x, y+h, rr);
          this.arcTo(x, y+h, x, y, rr);
          this.arcTo(x, y, x+w, y, rr);
          this.closePath();
          return this;
        };
      }
    }

    function preload(){
      ['earth','moon','mars'].forEach(k=>{
        const img = new Image();
        img.src = PLANETS[k].img;
      });
    }

    function init(){
      ensureRoundRect();
      preload();

      vVal.textContent = parseFloat(vSlider.value).toFixed(1);
      thVal.textContent = parseInt(thSlider.value,10);

      resizeOverlay();
      updatePlanetCenter();
      computeScale();
      setPlanet('earth');

      // place rocket preview on north pole
      requestAnimationFrame(()=>{
        updatePlanetCenter();
        updatePreviewPose();
        drawOverlay();
      });
    }

    init();
  </script>
</body>
</html>
