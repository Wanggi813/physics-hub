<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>원형파 간섭 (파원 개수 선택)</title>
<style>
  html, body { height:100%; margin:0; background:#0a0a0a; color:#e6e6e6; font-family:system-ui, sans-serif; }
  .wrap {
    width:min(92vmin, 720px);
    aspect-ratio:1 / 1;
    margin:3vmin auto 0.8rem;
    background:#000;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,.55);
    overflow:hidden;
  }
  canvas#sim { width:100%; height:100%; display:block; cursor:grab; }
  .panel {
    width:min(92vmin, 720px);
    margin:0 auto 0.6rem;
    display:grid;
    grid-template-columns: 120px 1fr 62px;
    gap:8px 12px;
    align-items:center;
    font-size:14px;
  }
  .panel label { color:#bdbdbd }
  .panel input[type="range"], .panel select { width:100% }
  .badge {
    width:min(92vmin, 720px);
    margin:0 auto 0.6rem;
    text-align:center; color:#9b9b9b; font-size:12px;
  }
  .brand {
    width:min(92vmin, 720px);
    margin:0 auto 2rem;
    text-align:center;
    color:#c7f36b; font-weight:700;
    letter-spacing:.02em;
    text-shadow:0 1px 10px rgba(199,243,107,.25);
  }
</style>
</head>
<body>
  <div class="wrap"><canvas id="sim"></canvas></div>

  <div class="panel">
    <label for="lambda">파장 λ</label>
    <input id="lambda" type="range" min="16" max="200" step="2" value="60">
    <output id="lambdaOut">60</output>

    <label for="speed">위상속도 v</label>
    <input id="speed" type="range" min="20" max="400" step="5" value="140">
    <output id="speedOut">140</output>

    <label for="expo">노출</label>
    <input id="expo" type="range" min="2000" max="60000" step="1000" value="22000">
    <output id="expoOut">22000</output>

    <label for="sources">파원 개수</label>
    <select id="sources">
      <option value="1">1개</option>
      <option value="2" selected>2개</option>
      <option value="3">3개</option>
    </select>
  </div>

  <div class="badge">드래그: 파원 이동 • 감쇠 = <b>1/√r</b></div>
  <div class="brand">왕왕물리시뮬레이션</div>

<script>
(() => {
  const canvas = document.getElementById('sim');
  const ctx = canvas.getContext('2d');

  // UI 엘리먼트
  const $λ = document.getElementById('lambda'), $λOut=document.getElementById('lambdaOut');
  const $v = document.getElementById('speed'), $vOut=document.getElementById('speedOut');
  const $ex = document.getElementById('expo'), $exOut=document.getElementById('expoOut');
  const $src = document.getElementById('sources');

  let lambda=+$λ.value, v=+$v.value, exposure=+$ex.value;
  let numSources = +$src.value;

  // 파원 배열 (정규화 좌표)
  let sources = [
    { x:0.5, y:0.5 },
    { x:0.35, y:0.5 },
    { x:0.65, y:0.5 }
  ];

  // 캐시 배열
  let W=0,H=0,imgData,data;
  let rAll=[], invSqrtAll=[];

  function resizeCanvasToContainer(){
    const rect = canvas.getBoundingClientRect();
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const w=Math.round(rect.width*dpr), h=Math.round(rect.height*dpr);
    if(w===W && h===H) return;
    canvas.width=W=w; canvas.height=H=h;
    imgData=ctx.createImageData(W,H); data=imgData.data;
    rebuildCache();
  }

  function rebuildCache(){
    rAll=[]; invSqrtAll=[];
    for(let si=0; si<numSources; si++){
      const S={x:sources[si].x*W, y:sources[si].y*H};
      const r=new Float32Array(W*H), invSqrt=new Float32Array(W*H);
      let i=0;
      for(let y=0;y<H;y++){
        const dy=y-S.y;
        for(let x=0;x<W;x++,i++){
          const d=Math.hypot(x-S.x,dy)+1e-4;
          r[i]=d; invSqrt[i]=1/Math.sqrt(d);
        }
      }
      rAll.push(r); invSqrtAll.push(invSqrt);
    }
  }

  // 드래그
  let dragging=null, rebuildScheduled=false;
  function canvasToNorm(ev){
    const rect=canvas.getBoundingClientRect();
    return {
      x:Math.min(1,Math.max(0,(ev.clientX-rect.left)/rect.width)),
      y:Math.min(1,Math.max(0,(ev.clientY-rect.top)/rect.height))
    };
  }
  canvas.addEventListener('mousedown',e=>{
    canvas.style.cursor='grabbing';
    const n=canvasToNorm(e);
    let nearest=0, best=1e9;
    for(let i=0;i<numSources;i++){
      const d=Math.hypot(n.x-sources[i].x, n.y-sources[i].y);
      if(d<best){best=d; nearest=i;}
    }
    dragging=nearest;
  });
  window.addEventListener('mouseup',()=>{
    if(dragging!=null){ dragging=null; canvas.style.cursor='grab'; rebuildCache(); }
  });
  window.addEventListener('mousemove',e=>{
    if(dragging==null)return;
    sources[dragging]=canvasToNorm(e);
    if(!rebuildScheduled){
      rebuildScheduled=true;
      requestAnimationFrame(()=>{ rebuildCache(); rebuildScheduled=false; });
    }
  });

  // UI 이벤트
  $λ.addEventListener('input',e=>{lambda=+e.target.value;$λOut.textContent=lambda;});
  $v.addEventListener('input',e=>{v=+e.target.value;$vOut.textContent=v;});
  $ex.addEventListener('input',e=>{exposure=+e.target.value;$exOut.textContent=exposure;});
  $src.addEventListener('change',e=>{numSources=+e.target.value; rebuildCache();});

  $λOut.textContent=lambda; $vOut.textContent=v; $exOut.textContent=exposure;

  // 렌더
  function render(tMs){
    resizeCanvasToContainer();
    const t=tMs/1000;
    const k=(2*Math.PI)/lambda, omega=k*v;
    if(rAll.length!==numSources) rebuildCache();

    let i=0;
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++,i++){
        let a=0;
        for(let si=0;si<numSources;si++){
          a += Math.sin(k*rAll[si][i] - omega*t) * invSqrtAll[si][i];
        }
        let I=a*a*exposure; if(I>255) I=255;
        const g=I|0, o=i*4;
        data[o]=g; data[o+1]=g; data[o+2]=g; data[o+3]=255;
      }
    }
    ctx.putImageData(imgData,0,0);

    // 파원 점
    ctx.fillStyle='#fff';
    for(let si=0;si<numSources;si++){
      ctx.beginPath();
      ctx.arc(sources[si].x*W, sources[si].y*H, 3*(window.devicePixelRatio||1), 0, Math.PI*2);
      ctx.fill();
    }
    requestAnimationFrame(render);
  }

  resizeCanvasToContainer();
  requestAnimationFrame(render);
  window.addEventListener('resize',()=>resizeCanvasToContainer());
})();
</script>
</body>
</html>
